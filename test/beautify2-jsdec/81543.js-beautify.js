const debug=require('@tryghost/debug')('members');const{URL}=require('url');const cors=require('cors');const bodyParser=require('body-parser');const express=require('../../../shared/express');const urlUtils=require('../../../shared/url-utils');const membersService=require('../../services/members');const middleware=membersService.middleware;const shared=require('../shared');module.exports=function setupMembersApp(){debug('Members App setup start');const membersApp=express('members');membersApp.use(shared.middlewares.maintenance);membersApp.use(shared.middlewares.cacheControl('private'));const siteUrl=new URL(urlUtils.getSiteUrl());membersApp.use(cors(siteUrl.origin));membersApp.use(middleware.createSessionFromMagicLink);membersApp.post('/webhooks/stripe',middleware.stripeWebhooks);membersApp.get('/api/member',middleware.getMemberData);membersApp.put('/api/member',bodyParser.json({limit:'1mb'}),middleware.updateMemberData);membersApp.get('/api/session',middleware.getIdentityToken);membersApp.delete('/api/session',middleware.deleteSession);membersApp.get('/api/site',middleware.getMemberSiteData);membersApp.post('/api/send-magic-link',bodyParser.json(),shared.middlewares.brute.membersAuth,(req,res,next)=>membersService.api.middleware.sendMagicLink(req,res,next));membersApp.post('/api/create-stripe-checkout-session',(req,res,next)=>membersService.api.middleware.createCheckoutSession(req,res,next));membersApp.post('/api/create-stripe-update-session',(req,res,next)=>membersService.api.middleware.createCheckoutSetupSession(req,res,next));membersApp.put('/api/subscriptions/:id',(req,res,next)=>membersService.api.middleware.updateSubscription(req,res,next));membersApp.use('/api',shared.middlewares.errorHandler.resourceNotFound);membersApp.use('/api',shared.middlewares.errorHandler.handleJSONResponseV2);membersApp.use('/webhooks',shared.middlewares.errorHandler.resourceNotFound);membersApp.use('/webhooks',shared.middlewares.errorHandler.handleJSONResponseV2);debug('Members App setup end');return membersApp};