var ArrayRemove=require('../../utils/array/Remove');var CameraEvents=require('../../cameras/2d/events');var Class=require('../../utils/Class');var CONST=require('../../const');var EventEmitter=require('eventemitter3');var Events=require('../events');var GameEvents=require('../../core/events');var IsSizePowerOfTwo=require('../../math/pow2/IsSizePowerOfTwo');var Matrix4=require('../../math/Matrix4');var NOOP=require('../../utils/NOOP');var PipelineManager=require('./PipelineManager');var RenderTarget=require('./RenderTarget');var ScaleEvents=require('../../scale/events');var TextureEvents=require('../../textures/events');var Utils=require('./Utils');var WebGLSnapshot=require('../snapshot/WebGLSnapshot');var WebGLRenderer=new Class({Extends:EventEmitter,initialize:function WebGLRenderer(game){EventEmitter.call(this);var gameConfig=game.config;var contextCreationConfig={alpha:gameConfig.transparent,desynchronized:gameConfig.desynchronized,depth:false,antialias:gameConfig.antialiasGL,premultipliedAlpha:gameConfig.premultipliedAlpha,stencil:true,failIfMajorPerformanceCaveat:gameConfig.failIfMajorPerformanceCaveat,powerPreference:gameConfig.powerPreference,preserveDrawingBuffer:gameConfig.preserveDrawingBuffer};this.config={clearBeforeRender:gameConfig.clearBeforeRender,antialias:gameConfig.antialias,backgroundColor:gameConfig.backgroundColor,contextCreation:contextCreationConfig,roundPixels:gameConfig.roundPixels,maxTextures:gameConfig.maxTextures,maxTextureSize:gameConfig.maxTextureSize,batchSize:gameConfig.batchSize,maxLights:gameConfig.maxLights,mipmapFilter:gameConfig.mipmapFilter};this.game=game;this.type=CONST.WEBGL;this.pipelines=null;this.width=0;this.height=0;this.canvas=game.canvas;this.blendModes=[];this.contextLost=false;this.snapshotState={x:0,y:0,width:1,height:1,getPixel:false,callback:null,type:'image/png',encoder:0.92,isFramebuffer:false,bufferWidth:0,bufferHeight:0};this.currentActiveTexture=0;this.startActiveTexture=0;this.maxTextures=0;this.textureIndexes;this.tempTextures;this.textureZero;this.normalTexture;this.currentFramebuffer=null;this.fboStack=[];this.currentProgram=null;this.currentBlendMode=Infinity;this.currentScissorEnabled=false;this.currentScissor=null;this.scissorStack=[];this.contextLostHandler=NOOP;this.contextRestoredHandler=NOOP;this.gl=null;this.supportedExtensions=null;this.instancedArraysExtension=null;this.vaoExtension=null;this.extensions={};this.glFormats=[];this.compression={ETC1:false,PVRTC:false,S3TC:false};this.drawingBufferHeight=0;this.blankTexture=null;this.whiteTexture=null;this.maskCount=0;this.maskStack=[];this.currentMask={mask:null,camera:null};this.currentCameraMask={mask:null,camera:null};this.glFuncMap=null;this.currentType='';this.newType=false;this.nextTypeMatch=false;this.finalType=false;this.mipmapFilter=null;this.textureFlush=0;this.isTextureClean=false;this.defaultScissor=[0,0,0,0];this.isBooted=false;this.renderTarget=null;this.projectionMatrix;this.projectionWidth=0;this.projectionHeight=0;this.init(this.config)},init:function(config){var gl;var game=this.game;var canvas=this.canvas;var clearColor=config.backgroundColor;if(game.config.context){gl=game.config.context}else{gl=canvas.getContext('webgl',config.contextCreation)||canvas.getContext('experimental-webgl',config.contextCreation)}if(!gl||gl.isContextLost()){this.contextLost=true;throw new Error('WebGL unsupported')}this.gl=gl;var _this=this;this.contextLostHandler=function(event){_this.contextLost=true;_this.game.events.emit(GameEvents.CONTEXT_LOST,_this);event.preventDefault()};this.contextRestoredHandler=function(){_this.contextLost=false;_this.init(_this.config);_this.game.events.emit(GameEvents.CONTEXT_RESTORED,_this)};canvas.addEventListener('webglcontextlost',this.contextLostHandler,false);canvas.addEventListener('webglcontextrestored',this.contextRestoredHandler,false);game.context=gl;for(var i=0;i<=27;i++){this.blendModes.push({func:[gl.ONE,gl.ONE_MINUS_SRC_ALPHA],equation:gl.FUNC_ADD})}this.blendModes[1].func=[gl.ONE,gl.DST_ALPHA];this.blendModes[2].func=[gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA];this.blendModes[3].func=[gl.ONE,gl.ONE_MINUS_SRC_COLOR];this.blendModes[17]={func:[gl.ZERO,gl.ONE_MINUS_SRC_ALPHA],equation:gl.FUNC_REVERSE_SUBTRACT};this.glFormats[0]=gl.BYTE;this.glFormats[1]=gl.SHORT;this.glFormats[2]=gl.UNSIGNED_BYTE;this.glFormats[3]=gl.UNSIGNED_SHORT;this.glFormats[4]=gl.FLOAT;this.glFuncMap={mat2:{func:gl.uniformMatrix2fv,length:1,matrix:true},mat3:{func:gl.uniformMatrix3fv,length:1,matrix:true},mat4:{func:gl.uniformMatrix4fv,length:1,matrix:true},'1f':{func:gl.uniform1f,length:1},'1fv':{func:gl.uniform1fv,length:1},'1i':{func:gl.uniform1i,length:1},'1iv':{func:gl.uniform1iv,length:1},'2f':{func:gl.uniform2f,length:2},'2fv':{func:gl.uniform2fv,length:1},'2i':{func:gl.uniform2i,length:2},'2iv':{func:gl.uniform2iv,length:1},'3f':{func:gl.uniform3f,length:3},'3fv':{func:gl.uniform3fv,length:1},'3i':{func:gl.uniform3i,length:3},'3iv':{func:gl.uniform3iv,length:1},'4f':{func:gl.uniform4f,length:4},'4fv':{func:gl.uniform4fv,length:1},'4i':{func:gl.uniform4i,length:4},'4iv':{func:gl.uniform4iv,length:1}};var exts=gl.getSupportedExtensions();if(!config.maxTextures||config.maxTextures===-1){config.maxTextures=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS)}if(!config.maxTextureSize){config.maxTextureSize=gl.getParameter(gl.MAX_TEXTURE_SIZE)}var extString='WEBGL_compressed_texture_';var wkExtString='WEBKIT_'+extString;this.compression.ETC1=gl.getExtension(extString+'etc1')||gl.getExtension(wkExtString+'etc1');this.compression.PVRTC=gl.getExtension(extString+'pvrtc')||gl.getExtension(wkExtString+'pvrtc');this.compression.S3TC=gl.getExtension(extString+'s3tc')||gl.getExtension(wkExtString+'s3tc');this.supportedExtensions=exts;var angleString='ANGLE_instanced_arrays';this.instancedArraysExtension=(exts.indexOf(angleString)>-1)?gl.getExtension(angleString):null;var vaoString='OES_vertex_array_object';this.vaoExtension=(exts.indexOf(vaoString)>-1)?gl.getExtension(vaoString):null;gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.enable(gl.BLEND);gl.clearColor(clearColor.redGL,clearColor.greenGL,clearColor.blueGL,clearColor.alphaGL);this.mipmapFilter=gl[config.mipmapFilter];this.maxTextures=Utils.checkShaderMax(gl,config.maxTextures);this.textureIndexes=[];var tempTextures=this.tempTextures;if(Array.isArray(tempTextures)){for(var t=0;i<this.maxTextures;t++){gl.deleteTexture(tempTextures[t])}}else{tempTextures=new Array(this.maxTextures)}for(var index=0;index<this.maxTextures;index++){var tempTexture=gl.createTexture();gl.activeTexture(gl.TEXTURE0+index);gl.bindTexture(gl.TEXTURE_2D,tempTexture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array([0,0,255,255]));tempTextures[index]=tempTexture;this.textureIndexes.push(index)}this.tempTextures=tempTextures;this.currentActiveTexture=1;this.startActiveTexture++;gl.activeTexture(gl.TEXTURE1);this.pipelines=new PipelineManager(this);this.setBlendMode(CONST.BlendModes.NORMAL);this.projectionMatrix=new Matrix4().identity();game.textures.once(TextureEvents.READY,this.boot,this);return this},boot:function(){var game=this.game;var pipelineManager=this.pipelines;var baseSize=game.scale.baseSize;this.width=baseSize.width;this.height=baseSize.height;this.isBooted=true;this.renderTarget=new RenderTarget(this,this.width,this.height,1,0,true,true);pipelineManager.boot(game.config.pipeline);this.blankTexture=game.textures.getFrame('__DEFAULT');this.whiteTexture=game.textures.getFrame('__WHITE');var gl=this.gl;gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.enable(gl.SCISSOR_TEST);game.scale.on(ScaleEvents.RESIZE,this.onResize,this);this.resize(baseSize.width,baseSize.height)},onResize:function(gameSize,baseSize){if(baseSize.width!==this.width||baseSize.height!==this.height){this.resize(baseSize.width,baseSize.height)}},beginCapture:function(width,height){if(width===undefined){width=this.width}if(height===undefined){height=this.height}this.renderTarget.bind(true,width,height);this.setProjectionMatrix(width,height);this.resetTextures()},endCapture:function(){this.renderTarget.unbind(true);this.resetProjectionMatrix();return this.renderTarget},resize:function(width,height){var gl=this.gl;this.width=width;this.height=height;this.setProjectionMatrix(width,height);gl.viewport(0,0,width,height);this.drawingBufferHeight=gl.drawingBufferHeight;gl.scissor(0,(gl.drawingBufferHeight-height),width,height);this.defaultScissor[2]=width;this.defaultScissor[3]=height;this.emit(Events.RESIZE,width,height);return this},getAspectRatio:function(){return this.width/this.height},setProjectionMatrix:function(width,height){if(width!==this.projectionWidth||height!==this.projectionHeight){this.projectionWidth=width;this.projectionHeight=height;this.projectionMatrix.ortho(0,width,height,0,-1000,1000)}return this},resetProjectionMatrix:function(){this.projectionWidth=this.width;this.projectionHeight=this.height;this.projectionMatrix.ortho(0,this.width,this.height,0,-1000,1000)},hasExtension:function(extensionName){return this.supportedExtensions?this.supportedExtensions.indexOf(extensionName):false},getExtension:function(extensionName){if(!this.hasExtension(extensionName)){return null}if(!(extensionName in this.extensions)){this.extensions[extensionName]=this.gl.getExtension(extensionName)}return this.extensions[extensionName]},flush:function(){this.pipelines.flush()},pushScissor:function(x,y,width,height,drawingBufferHeight){if(drawingBufferHeight===undefined){drawingBufferHeight=this.drawingBufferHeight}var scissorStack=this.scissorStack;var scissor=[x,y,width,height];scissorStack.push(scissor);this.setScissor(x,y,width,height,drawingBufferHeight);this.currentScissor=scissor;return scissor},setScissor:function(x,y,width,height,drawingBufferHeight){if(drawingBufferHeight===undefined){drawingBufferHeight=this.drawingBufferHeight}var gl=this.gl;var current=this.currentScissor;var setScissor=(width>0&&height>0);if(current&&setScissor){var cx=current[0];var cy=current[1];var cw=current[2];var ch=current[3];setScissor=(cx!==x||cy!==y||cw!==width||ch!==height)}if(setScissor){this.flush();gl.scissor(x,(drawingBufferHeight-y-height),width,height)}},resetScissor:function(){var gl=this.gl;gl.enable(gl.SCISSOR_TEST);var current=this.currentScissor;if(current){var x=current[0];var y=current[1];var width=current[2];var height=current[3];if(width>0&&height>0){gl.scissor(x,(this.drawingBufferHeight-y-height),width,height)}}},popScissor:function(){var scissorStack=this.scissorStack;scissorStack.pop();var scissor=scissorStack[scissorStack.length-1];if(scissor){this.setScissor(scissor[0],scissor[1],scissor[2],scissor[3])}this.currentScissor=scissor},hasActiveStencilMask:function(){var mask=this.currentMask.mask;var camMask=this.currentCameraMask.mask;return((mask&&mask.isStencil)||(camMask&&camMask.isStencil))},resetViewport:function(){var gl=this.gl;gl.viewport(0,0,this.width,this.height);this.drawingBufferHeight=gl.drawingBufferHeight},setBlendMode:function(blendModeId,force){if(force===undefined){force=false}var gl=this.gl;var blendMode=this.blendModes[blendModeId];if(force||(blendModeId!==CONST.BlendModes.SKIP_CHECK&&this.currentBlendMode!==blendModeId)){this.flush();gl.enable(gl.BLEND);gl.blendEquation(blendMode.equation);if(blendMode.func.length>2){gl.blendFuncSeparate(blendMode.func[0],blendMode.func[1],blendMode.func[2],blendMode.func[3])}else{gl.blendFunc(blendMode.func[0],blendMode.func[1])}this.currentBlendMode=blendModeId;return true}return false},addBlendMode:function(func,equation){var index=this.blendModes.push({func:func,equation:equation});return index-1},updateBlendMode:function(index,func,equation){if(this.blendModes[index]){this.blendModes[index].func=func;if(equation){this.blendModes[index].equation=equation}}return this},removeBlendMode:function(index){if(index>17&&this.blendModes[index]){this.blendModes.splice(index,1)}return this},setBlankTexture:function(){this.setTexture2D(this.blankTexture.glTexture)},setTextureSource:function(textureSource){if(this.pipelines.forceZero()){this.setTextureZero(textureSource.glTexture,true);return 0}var gl=this.gl;var currentActiveTexture=this.currentActiveTexture;if(textureSource.glIndexCounter<this.startActiveTexture){textureSource.glIndexCounter=this.startActiveTexture;if(currentActiveTexture<this.maxTextures){textureSource.glIndex=currentActiveTexture;gl.activeTexture(gl.TEXTURE0+currentActiveTexture);gl.bindTexture(gl.TEXTURE_2D,textureSource.glTexture);this.currentActiveTexture++}else{this.flush();this.startActiveTexture++;this.textureFlush++;textureSource.glIndexCounter=this.startActiveTexture;textureSource.glIndex=1;gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,textureSource.glTexture);this.currentActiveTexture=2}}this.isTextureClean=false;return textureSource.glIndex},isNewNormalMap:function(texture,normalMap){return(this.textureZero!==texture||this.normalTexture!==normalMap)},setTextureZero:function(texture,flush){if(this.textureZero!==texture){if(flush){this.flush()}var gl=this.gl;gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,texture);this.textureZero=texture}},clearTextureZero:function(){this.textureZero=null},setNormalMap:function(texture){if(this.normalTexture!==texture){var gl=this.gl;gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,texture);this.normalTexture=texture;if(this.currentActiveTexture===1){this.currentActiveTexture=2}}},clearNormalMap:function(){this.normalTexture=null;this.startActiveTexture++;this.currentActiveTexture=1;this.textureFlush++},unbindTextures:function(){var gl=this.gl;var temp=this.tempTextures;for(var i=0;i<temp.length;i++){gl.activeTexture(gl.TEXTURE0+i);gl.bindTexture(gl.TEXTURE_2D,null)}this.normalTexture=null;this.textureZero=null;this.currentActiveTexture=1;this.startActiveTexture++;this.textureFlush++},resetTextures:function(all){if(all===undefined){all=false}if(this.isTextureClean){return}this.flush();var gl=this.gl;var temp=this.tempTextures;if(all){for(var i=0;i<temp.length;i++){gl.activeTexture(gl.TEXTURE0+i);gl.bindTexture(gl.TEXTURE_2D,temp[i])}gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,temp[1]);this.isTextureClean=true}else{gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,temp[0]);gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,temp[1])}this.normalTexture=null;this.textureZero=null;this.currentActiveTexture=1;this.startActiveTexture++;this.textureFlush++},setTexture2D:function(texture){if(this.pipelines.forceZero()){this.setTextureZero(texture,true);return 0}var gl=this.gl;var currentActiveTexture=this.currentActiveTexture;if(texture.glIndexCounter<this.startActiveTexture){texture.glIndexCounter=this.startActiveTexture;if(currentActiveTexture<this.maxTextures){texture.glIndex=currentActiveTexture;gl.activeTexture(gl.TEXTURE0+currentActiveTexture);gl.bindTexture(gl.TEXTURE_2D,texture);this.currentActiveTexture++}else{this.flush();this.startActiveTexture++;this.textureFlush++;texture.glIndexCounter=this.startActiveTexture;texture.glIndex=1;gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,texture);this.currentActiveTexture=2}}this.isTextureClean=false;return texture.glIndex},pushFramebuffer:function(framebuffer,updateScissor,resetTextures,setViewport){if(framebuffer===this.currentFramebuffer){return this}this.fboStack.push(framebuffer);return this.setFramebuffer(framebuffer,updateScissor,resetTextures,setViewport)},setFramebuffer:function(framebuffer,updateScissor,resetTextures,setViewport){if(updateScissor===undefined){updateScissor=false}if(resetTextures===undefined){resetTextures=false}if(setViewport===undefined){setViewport=true}if(framebuffer===this.currentFramebuffer){return this}var gl=this.gl;var width=this.width;var height=this.height;if(framebuffer&&framebuffer.renderTexture&&setViewport){width=framebuffer.renderTexture.width;height=framebuffer.renderTexture.height}else{this.flush()}gl.bindFramebuffer(gl.FRAMEBUFFER,framebuffer);if(setViewport){gl.viewport(0,0,width,height)}if(updateScissor){if(framebuffer){this.drawingBufferHeight=height;this.pushScissor(0,0,width,height)}else{this.drawingBufferHeight=this.height;this.popScissor()}}this.currentFramebuffer=framebuffer;if(resetTextures){this.resetTextures()}return this},popFramebuffer:function(updateScissor,resetTextures,setViewport){if(updateScissor===undefined){updateScissor=false}if(resetTextures===undefined){resetTextures=false}if(setViewport===undefined){setViewport=true}var fboStack=this.fboStack;fboStack.pop();var framebuffer=fboStack[fboStack.length-1];if(!framebuffer){framebuffer=null}this.setFramebuffer(framebuffer,updateScissor,resetTextures,setViewport);return framebuffer},setProgram:function(program){if(program!==this.currentProgram){this.flush();this.gl.useProgram(program);this.currentProgram=program;return true}return false},resetProgram:function(){this.gl.useProgram(this.currentProgram);return this},createTextureFromSource:function(source,width,height,scaleMode){var gl=this.gl;var minFilter=gl.NEAREST;var magFilter=gl.NEAREST;var wrap=gl.CLAMP_TO_EDGE;var texture=null;width=source?source.width:width;height=source?source.height:height;var pow=IsSizePowerOfTwo(width,height);if(pow){wrap=gl.REPEAT}if(scaleMode===CONST.ScaleModes.LINEAR&&this.config.antialias){minFilter=(pow)?this.mipmapFilter:gl.LINEAR;magFilter=gl.LINEAR}if(!source&&typeof width==='number'&&typeof height==='number'){texture=this.createTexture2D(0,minFilter,magFilter,wrap,wrap,gl.RGBA,null,width,height)}else{texture=this.createTexture2D(0,minFilter,magFilter,wrap,wrap,gl.RGBA,source)}return texture},createTexture2D:function(mipLevel,minFilter,magFilter,wrapT,wrapS,format,pixels,width,height,pma,forceSize,flipY){pma=(pma===undefined||pma===null)?true:pma;if(forceSize===undefined){forceSize=false}if(flipY===undefined){flipY=false}var gl=this.gl;var texture=gl.createTexture();gl.activeTexture(gl.TEXTURE0);var currentTexture=gl.getParameter(gl.TEXTURE_BINDING_2D);gl.bindTexture(gl.TEXTURE_2D,texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,minFilter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,magFilter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,wrapS);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,wrapT);gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,pma);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,flipY);if(pixels===null||pixels===undefined){gl.texImage2D(gl.TEXTURE_2D,mipLevel,format,width,height,0,format,gl.UNSIGNED_BYTE,null)}else{if(!forceSize){width=pixels.width;height=pixels.height}gl.texImage2D(gl.TEXTURE_2D,mipLevel,format,format,gl.UNSIGNED_BYTE,pixels)}if(IsSizePowerOfTwo(width,height)){gl.generateMipmap(gl.TEXTURE_2D)}if(currentTexture){gl.bindTexture(gl.TEXTURE_2D,currentTexture)}texture.isAlphaPremultiplied=pma;texture.isRenderTexture=false;texture.width=width;texture.height=height;texture.glIndex=0;texture.glIndexCounter=-1;return texture},createFramebuffer:function(width,height,renderTexture,addDepthStencilBuffer){var gl=this.gl;var framebuffer=gl.createFramebuffer();var complete=0;this.setFramebuffer(framebuffer);if(addDepthStencilBuffer){var depthStencilBuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,depthStencilBuffer);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,width,height);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,depthStencilBuffer)}renderTexture.isRenderTexture=true;renderTexture.isAlphaPremultiplied=false;gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,renderTexture,0);complete=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(complete!==gl.FRAMEBUFFER_COMPLETE){var errors={36054:'Incomplete Attachment',36055:'Missing Attachment',36057:'Incomplete Dimensions',36061:'Framebuffer Unsupported'};throw new Error('Framebuffer status: '+errors[complete])}framebuffer.renderTexture=renderTexture;this.setFramebuffer(null);this.resetTextures();return framebuffer},createProgram:function(vertexShader,fragmentShader){var gl=this.gl;var program=gl.createProgram();var vs=gl.createShader(gl.VERTEX_SHADER);var fs=gl.createShader(gl.FRAGMENT_SHADER);gl.shaderSource(vs,vertexShader);gl.shaderSource(fs,fragmentShader);gl.compileShader(vs);gl.compileShader(fs);if(!gl.getShaderParameter(vs,gl.COMPILE_STATUS)){throw new Error('Vertex Shader failed:\n'+gl.getShaderInfoLog(vs))}if(!gl.getShaderParameter(fs,gl.COMPILE_STATUS)){throw new Error('Fragment Shader failed:\n'+gl.getShaderInfoLog(fs))}gl.attachShader(program,vs);gl.attachShader(program,fs);gl.linkProgram(program);if(!gl.getProgramParameter(program,gl.LINK_STATUS)){throw new Error('Link Program failed:\n'+gl.getProgramInfoLog(program))}gl.useProgram(program);return program},createVertexBuffer:function(initialDataOrSize,bufferUsage){var gl=this.gl;var vertexBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,initialDataOrSize,bufferUsage);gl.bindBuffer(gl.ARRAY_BUFFER,null);return vertexBuffer},createIndexBuffer:function(initialDataOrSize,bufferUsage){var gl=this.gl;var indexBuffer=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,initialDataOrSize,bufferUsage);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null);return indexBuffer},deleteTexture:function(texture,reset){if(reset){this.resetTextures(true)}if(texture){this.gl.deleteTexture(texture)}return this},deleteFramebuffer:function(framebuffer){if(framebuffer){this.gl.deleteFramebuffer(framebuffer);ArrayRemove(this.fboStack,framebuffer);if(this.currentFramebuffer===framebuffer){this.currentFramebuffer=null}}return this},deleteProgram:function(program){if(program){this.gl.deleteProgram(program)}return this},deleteBuffer:function(buffer){this.gl.deleteBuffer(buffer);return this},preRenderCamera:function(camera){var cx=camera.x;var cy=camera.y;var cw=camera.width;var ch=camera.height;var color=camera.backgroundColor;camera.emit(CameraEvents.PRE_RENDER,camera);this.pipelines.preBatchCamera(camera);this.pushScissor(cx,cy,cw,ch);if(camera.mask){this.currentCameraMask.mask=camera.mask;this.currentCameraMask.camera=camera._maskCamera;camera.mask.preRenderWebGL(this,camera,camera._maskCamera)}if(color.alphaGL>0){var pipeline=this.pipelines.setMulti();pipeline.drawFillRect(cx,cy,cw,ch,Utils.getTintFromFloats(color.blueGL,color.greenGL,color.redGL,1),color.alphaGL)}},getCurrentStencilMask:function(){var prev=null;var stack=this.maskStack;var cameraMask=this.currentCameraMask;if(stack.length>0){prev=stack[stack.length-1]}else if(cameraMask.mask&&cameraMask.mask.isStencil){prev=cameraMask}return prev},postRenderCamera:function(camera){var flashEffect=camera.flashEffect;var fadeEffect=camera.fadeEffect;if(flashEffect.isRunning||(fadeEffect.isRunning||fadeEffect.isComplete)){var pipeline=this.pipelines.setMulti();flashEffect.postRenderWebGL(pipeline,Utils.getTintFromFloats);fadeEffect.postRenderWebGL(pipeline,Utils.getTintFromFloats)}camera.dirty=false;this.popScissor();if(camera.mask){this.currentCameraMask.mask=null;camera.mask.postRenderWebGL(this,camera._maskCamera)}this.pipelines.postBatchCamera(camera);camera.emit(CameraEvents.POST_RENDER,camera)},preRender:function(){if(this.contextLost){return}var gl=this.gl;gl.bindFramebuffer(gl.FRAMEBUFFER,null);if(this.config.clearBeforeRender){var clearColor=this.config.backgroundColor;gl.clearColor(clearColor.redGL,clearColor.greenGL,clearColor.blueGL,clearColor.alphaGL);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT|gl.STENCIL_BUFFER_BIT)}gl.enable(gl.SCISSOR_TEST);this.currentScissor=this.defaultScissor;this.scissorStack.length=0;this.scissorStack.push(this.currentScissor);if(this.game.scene.customViewports){gl.scissor(0,(this.drawingBufferHeight-this.height),this.width,this.height)}this.currentMask.mask=null;this.currentCameraMask.mask=null;this.maskStack.length=0;this.textureFlush=0;this.emit(Events.PRE_RENDER)},render:function(scene,children,camera){if(this.contextLost){return}var childCount=children.length;this.emit(Events.RENDER,scene,camera);this.preRenderCamera(camera);if(childCount===0){this.setBlendMode(CONST.BlendModes.NORMAL);this.postRenderCamera(camera);return}this.currentType='';var current=this.currentMask;for(var i=0;i<childCount;i++){this.finalType=(i===childCount-1);var child=children[i];var mask=child.mask;current=this.currentMask;if(current.mask&&current.mask!==mask){current.mask.postRenderWebGL(this,current.camera)}if(mask&&current.mask!==mask){mask.preRenderWebGL(this,child,camera)}if(child.blendMode!==this.currentBlendMode){this.setBlendMode(child.blendMode)}var type=child.type;if(type!==this.currentType){this.newType=true;this.currentType=type}if(!this.finalType){this.nextTypeMatch=(children[i+1].type===this.currentType)}else{this.nextTypeMatch=false}child.renderWebGL(this,child,camera);this.newType=false}current=this.currentMask;if(current.mask){current.mask.postRenderWebGL(this,current.camera)}this.setBlendMode(CONST.BlendModes.NORMAL);this.postRenderCamera(camera)},postRender:function(){if(this.contextLost){return}this.flush();this.emit(Events.POST_RENDER);var state=this.snapshotState;if(state.callback){WebGLSnapshot(this.canvas,state);state.callback=null}if(this.textureFlush>0){this.startActiveTexture++;this.currentActiveTexture=1}},snapshot:function(callback,type,encoderOptions){return this.snapshotArea(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight,callback,type,encoderOptions)},snapshotArea:function(x,y,width,height,callback,type,encoderOptions){var state=this.snapshotState;state.callback=callback;state.type=type;state.encoder=encoderOptions;state.getPixel=false;state.x=x;state.y=y;state.width=Math.min(width,this.gl.drawingBufferWidth);state.height=Math.min(height,this.gl.drawingBufferHeight);return this},snapshotPixel:function(x,y,callback){this.snapshotArea(x,y,1,1,callback);this.snapshotState.getPixel=true;return this},snapshotFramebuffer:function(framebuffer,bufferWidth,bufferHeight,callback,getPixel,x,y,width,height,type,encoderOptions){if(getPixel===undefined){getPixel=false}if(x===undefined){x=0}if(y===undefined){y=0}if(width===undefined){width=bufferWidth}if(height===undefined){height=bufferHeight}var currentFramebuffer=this.currentFramebuffer;this.snapshotArea(x,y,width,height,callback,type,encoderOptions);var state=this.snapshotState;state.getPixel=getPixel;state.isFramebuffer=true;state.bufferWidth=bufferWidth;state.bufferHeight=bufferHeight;this.setFramebuffer(framebuffer);WebGLSnapshot(this.canvas,state);this.setFramebuffer(currentFramebuffer);state.callback=null;state.isFramebuffer=false;return this},canvasToTexture:function(srcCanvas,dstTexture,noRepeat,flipY){if(noRepeat===undefined){noRepeat=false}if(flipY===undefined){flipY=false}if(!dstTexture){return this.createCanvasTexture(srcCanvas,noRepeat,flipY)}else{return this.updateCanvasTexture(srcCanvas,dstTexture,flipY)}},createCanvasTexture:function(srcCanvas,noRepeat,flipY){if(noRepeat===undefined){noRepeat=false}if(flipY===undefined){flipY=false}var gl=this.gl;var minFilter=gl.NEAREST;var magFilter=gl.NEAREST;var width=srcCanvas.width;var height=srcCanvas.height;var wrapping=gl.CLAMP_TO_EDGE;var pow=IsSizePowerOfTwo(width,height);if(!noRepeat&&pow){wrapping=gl.REPEAT}if(this.config.antialias){minFilter=(pow)?this.mipmapFilter:gl.LINEAR;magFilter=gl.LINEAR}return this.createTexture2D(0,minFilter,magFilter,wrapping,wrapping,gl.RGBA,srcCanvas,width,height,true,false,flipY)},updateCanvasTexture:function(srcCanvas,dstTexture,flipY){if(flipY===undefined){flipY=false}var gl=this.gl;var width=srcCanvas.width;var height=srcCanvas.height;if(width>0&&height>0){gl.activeTexture(gl.TEXTURE0);var currentTexture=gl.getParameter(gl.TEXTURE_BINDING_2D);gl.bindTexture(gl.TEXTURE_2D,dstTexture);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,flipY);gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,true);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,srcCanvas);dstTexture.width=width;dstTexture.height=height;if(currentTexture){gl.bindTexture(gl.TEXTURE_2D,currentTexture)}}return dstTexture},createVideoTexture:function(srcVideo,noRepeat,flipY){if(noRepeat===undefined){noRepeat=false}if(flipY===undefined){flipY=false}var gl=this.gl;var minFilter=gl.NEAREST;var magFilter=gl.NEAREST;var width=srcVideo.videoWidth;var height=srcVideo.videoHeight;var wrapping=gl.CLAMP_TO_EDGE;var pow=IsSizePowerOfTwo(width,height);if(!noRepeat&&pow){wrapping=gl.REPEAT}if(this.config.antialias){minFilter=(pow)?this.mipmapFilter:gl.LINEAR;magFilter=gl.LINEAR}return this.createTexture2D(0,minFilter,magFilter,wrapping,wrapping,gl.RGBA,srcVideo,width,height,true,true,flipY)},updateVideoTexture:function(srcVideo,dstTexture,flipY){if(flipY===undefined){flipY=false}var gl=this.gl;var width=srcVideo.videoWidth;var height=srcVideo.videoHeight;if(width>0&&height>0){gl.activeTexture(gl.TEXTURE0);var currentTexture=gl.getParameter(gl.TEXTURE_BINDING_2D);gl.bindTexture(gl.TEXTURE_2D,dstTexture);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,flipY);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,srcVideo);dstTexture.width=width;dstTexture.height=height;if(currentTexture){gl.bindTexture(gl.TEXTURE_2D,currentTexture)}}return dstTexture},setTextureFilter:function(texture,filter){var gl=this.gl;var glFilter=[gl.LINEAR,gl.NEAREST][filter];gl.activeTexture(gl.TEXTURE0);var currentTexture=gl.getParameter(gl.TEXTURE_BINDING_2D);gl.bindTexture(gl.TEXTURE_2D,texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,glFilter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,glFilter);if(currentTexture){gl.bindTexture(gl.TEXTURE_2D,currentTexture)}return this},getMaxTextureSize:function(){return this.config.maxTextureSize},destroy:function(){this.canvas.removeEventListener('webglcontextlost',this.contextLostHandler,false);this.canvas.removeEventListener('webglcontextrestored',this.contextRestoredHandler,false);var gl=this.gl;var temp=this.tempTextures;for(var i=0;i<temp.length;i++){gl.deleteTexture(temp[i])}this.pipelines.destroy();this.removeAllListeners();this.fboStack=[];this.maskStack=[];this.extensions={};this.textureIndexes=[];this.gl=null;this.game=null;this.canvas=null;this.contextLost=true;this.currentMask=null;this.currentCameraMask=null}});module.exports=WebGLRenderer;
