const _=require('lodash')const $jquery=require('./jquery')const $document=require('./document')const $elements=require('./elements')const $coordinates=require('./coordinates')const $transform=require('./transform')const fixedOrAbsoluteRe=/(fixed|absolute)/const OVERFLOW_PROPS=['hidden','scroll','auto']const isVisible=(el)=>{return!isHidden(el,'isVisible()')}const isHidden=(el,methodName='isHidden()',options={checkOpacity:true})=>{if(!$elements.isElement(el)){throw new Error(`\`Cypress.dom.${methodName}\`failed because it requires a DOM element.The subject received was:\`${el}\``)}const $el=$jquery.wrap(el)if($elements.isBody(el)||$elements.isHTML(el)){return false}if($elements.isOption(el)||$elements.isOptgroup(el)){if(elHasDisplayNone($el)){return true}const $select=$elements.getFirstParentWithTagName($el,'select')if($select&&$select.length){return isHidden($select[0],methodName)}}if(elHasNoEffectiveWidthOrHeight($el)){if(elHasDisplayInline($el)){return!elHasVisibleChild($el)}return true}if(elHasVisibilityHiddenOrCollapse($el)){return true}if($transform.detectVisibility($el)!=='visible'){return true}if(elHasOpacityZero($el)&&options.checkOpacity){return true}if(elIsHiddenByAncestors($el,options.checkOpacity)){return true}if(elOrAncestorIsFixedOrSticky($el)){return elIsNotElementFromPoint($el)}return elIsOutOfBoundsOfAncestorsOverflow($el)}const elHasNoEffectiveWidthOrHeight=($el)=>{const el=$el[0]const style=getComputedStyle(el)const transform=style.getPropertyValue('transform')const width=elOffsetWidth($el)const height=elOffsetHeight($el)const overflowHidden=elHasOverflowHidden($el)return isZeroLengthAndTransformNone(width,height,transform)||isZeroLengthAndOverflowHidden(width,height,overflowHidden)||(el.getClientRects().length<=0)}const isZeroLengthAndTransformNone=(width,height,transform)=>{return(width<=0&&transform==='none')||(height<=0&&transform==='none')}const isZeroLengthAndOverflowHidden=(width,height,overflowHidden)=>{return(width<=0&&overflowHidden)||(height<=0&&overflowHidden)}const elHasNoOffsetWidthOrHeight=($el)=>{return(elOffsetWidth($el)<=0)||(elOffsetHeight($el)<=0)}const elOffsetWidth=($el)=>{return $el[0].offsetWidth}const elOffsetHeight=($el)=>{return $el[0].offsetHeight}const elHasVisibilityHiddenOrCollapse=($el)=>{return elHasVisibilityHidden($el)||elHasVisibilityCollapse($el)}const elHasVisibilityHidden=($el)=>{return $el.css('visibility')==='hidden'}const elHasVisibilityCollapse=($el)=>{return $el.css('visibility')==='collapse'}const elHasOpacityZero=($el)=>{return $el.css('opacity')==='0'}const elHasDisplayNone=($el)=>{return $el.css('display')==='none'}const elHasDisplayInline=($el)=>{return $el.css('display')==='inline'}const elHasOverflowHidden=function($el){const cssOverflow=[$el.css('overflow'),$el.css('overflow-y'),$el.css('overflow-x')]return cssOverflow.includes('hidden')}const elHasPositionRelative=($el)=>{return $el.css('position')==='relative'}const elHasPositionAbsolute=($el)=>{return $el.css('position')==='absolute'}const elHasClippableOverflow=function($el){return OVERFLOW_PROPS.includes($el.css('overflow'))||OVERFLOW_PROPS.includes($el.css('overflow-y'))||OVERFLOW_PROPS.includes($el.css('overflow-x'))}const canClipContent=function($el,$ancestor){if(!elHasClippableOverflow($ancestor)){return false}const $offsetParent=$el.offsetParent()if(!elHasPositionRelative($el)&&$elements.isAncestor($ancestor,$offsetParent)){return false}if(elHasPositionAbsolute($offsetParent)&&$elements.isChild($ancestor,$offsetParent)){return false}return true}const elOrAncestorIsFixedOrSticky=function($el){return!!$elements.getFirstFixedOrStickyPositionParent($el)}const elAtCenterPoint=function($el){const doc=$document.getDocumentFromElement($el.get(0))const elProps=$coordinates.getElementPositioning($el)const{topCenter,leftCenter}=elProps.fromElViewport const el=$coordinates.getElementAtPointFromViewport(doc,leftCenter,topCenter)if(el){return $jquery.wrap(el)}}const elDescendentsHavePositionFixedOrAbsolute=function($parent,$child){const parents=$elements.getAllParents($child[0],$parent)const $els=$jquery.wrap(parents).add($child)return _.some($els.get(),(el)=>{return fixedOrAbsoluteRe.test($jquery.wrap(el).css('position'))})}const elHasVisibleChild=function($el){return _.some($el.children(),(el)=>{return isVisible(el)})}const elIsNotElementFromPoint=function($el){const $elAtPoint=elAtCenterPoint($el)if($elements.isDescendent($el,$elAtPoint)){return false}if(($el.css('pointer-events')==='none'||$el.parent().css('pointer-events')==='none')&&($elAtPoint&&$elements.isAncestor($el,$elAtPoint))){return false}return true}const elIsOutOfBoundsOfAncestorsOverflow=function($el,$ancestor=$elements.getParent($el)){if($elements.isUndefinedOrHTMLBodyDoc($ancestor)){return false}const elProps=$coordinates.getElementPositioning($el)if(canClipContent($el,$ancestor)){const ancestorProps=$coordinates.getElementPositioning($ancestor)if((elProps.fromElWindow.left>(ancestorProps.width+ancestorProps.fromElWindow.left))||((elProps.fromElWindow.left+elProps.width)<ancestorProps.fromElWindow.left)||(elProps.fromElWindow.top>(ancestorProps.height+ancestorProps.fromElWindow.top))||((elProps.fromElWindow.top+elProps.height)<ancestorProps.fromElWindow.top)){return true}}return elIsOutOfBoundsOfAncestorsOverflow($el,$elements.getParent($ancestor))}const elIsHiddenByAncestors=function($el,checkOpacity,$origEl=$el){const $parent=$elements.getParent($el)if($elements.isUndefinedOrHTMLBodyDoc($parent)){return false}if(elHasOpacityZero($parent)&&checkOpacity){return true}if(elHasOverflowHidden($parent)&&elHasNoEffectiveWidthOrHeight($parent)){return!elDescendentsHavePositionFixedOrAbsolute($parent,$origEl)}return elIsHiddenByAncestors($parent,checkOpacity,$origEl)}const parentHasNoOffsetWidthOrHeightAndOverflowHidden=function($el){if($elements.isUndefinedOrHTMLBodyDoc($el)){return false}if(elHasOverflowHidden($el)&&elHasNoEffectiveWidthOrHeight($el)){return $el}return parentHasNoOffsetWidthOrHeightAndOverflowHidden($elements.getParent($el))}const parentHasDisplayNone=function($el){if(!$el.length||$document.isDocument($el)){return false}if(elHasDisplayNone($el)){return $el}return parentHasDisplayNone($elements.getParent($el))}const parentHasVisibilityHidden=function($el){if(!$el.length||$document.isDocument($el)){return false}if(elHasVisibilityHidden($el)){return $el}return parentHasVisibilityHidden($elements.getParent($el))}const parentHasVisibilityCollapse=function($el){if(!$el.length||$document.isDocument($el)){return false}if(elHasVisibilityCollapse($el)){return $el}return parentHasVisibilityCollapse($elements.getParent($el))}const parentHasOpacityZero=function($el){if(!$el.length||$document.isDocument($el)){return false}if(elHasOpacityZero($el)){return $el}return parentHasOpacityZero($el.parent())}const getReasonIsHidden=function($el,options={checkOpacity:true}){const node=$elements.stringify($el,'short')let width=elOffsetWidth($el)let height=elOffsetHeight($el)let $parent let parentNode if(elHasDisplayNone($el)){return`This element\`${node}\`is not visible because it has CSS property:\`display:none\``}if($parent=parentHasDisplayNone($elements.getParent($el))){parentNode=$elements.stringify($parent,'short')return`This element\`${node}\`is not visible because its parent\`${parentNode}\`has CSS property:\`display:none\``}if($parent=parentHasVisibilityHidden($elements.getParent($el))){parentNode=$elements.stringify($parent,'short')return`This element\`${node}\`is not visible because its parent\`${parentNode}\`has CSS property:\`visibility:hidden\``}if($parent=parentHasVisibilityCollapse($elements.getParent($el))){parentNode=$elements.stringify($parent,'short')return`This element\`${node}\`is not visible because its parent\`${parentNode}\`has CSS property:\`visibility:collapse\``}if($elements.isDetached($el)){return`This element\`${node}\`is not visible because it is detached from the DOM`}if(elHasVisibilityHidden($el)){return`This element\`${node}\`is not visible because it has CSS property:\`visibility:hidden\``}if(elHasVisibilityCollapse($el)){return`This element\`${node}\`is not visible because it has CSS property:\`visibility:collapse\``}if(elHasOpacityZero($el)&&options.checkOpacity){return`This element\`${node}\`is not visible because it has CSS property:\`opacity:0\``}if(($parent=parentHasOpacityZero($el.parent()))&&options.checkOpacity){parentNode=$elements.stringify($parent,'short')return`This element\`${node}\`is not visible because its parent\`${parentNode}\`has CSS property:\`opacity:0\``}if(elHasNoOffsetWidthOrHeight($el)){return`This element\`${node}\`is not visible because it has an effective width and height of:\`${width}x ${height}\`pixels.`}const transformResult=$transform.detectVisibility($el)if(transformResult==='transformed'){return`This element\`${node}\`is not visible because it is hidden by transform.`}if(transformResult==='backface'){return`This element\`${node}\`is not visible because it is rotated and its backface is hidden.`}if($parent=parentHasNoOffsetWidthOrHeightAndOverflowHidden($elements.getParent($el))){parentNode=$elements.stringify($parent,'short')width=elOffsetWidth($parent)height=elOffsetHeight($parent)return`This element\`${node}\`is not visible because its parent\`${parentNode}\`has CSS property:\`overflow:hidden\`and an effective width and height of:\`${width}x ${height}\`pixels.`}if(elOrAncestorIsFixedOrSticky($el)){if(elIsNotElementFromPoint($el)){const covered=$elements.stringify(elAtCenterPoint($el))if(covered){return`This element\`${node}\`is not visible because it has CSS property:\`position:fixed\`and it's being covered by another element:\n\n\`${covered}\``}return`This element\`${node}\`is not visible because its ancestor has\`position:fixed\`CSS property and it is overflowed by other elements.How about scrolling to the element with\`cy.scrollIntoView()\`?`}}else{if(elIsOutOfBoundsOfAncestorsOverflow($el)){return`This element\`${node}\`is not visible because its content is being clipped by one of its parent elements,which has a CSS property of overflow:\`hidden\`,\`scroll\`or\`auto\``}}return`This element\`${node}\`is not visible.`}module.exports={isVisible,isHidden,parentHasDisplayNone,getReasonIsHidden,}
