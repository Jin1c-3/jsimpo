const logging=require('@tryghost/logging');module['exports']={'config':{'transaction':!![]},async 'up'({transacting:_0x19a2b9}){var _0x26bd30={'wfSZj':function(_0x573a37,_0x26960b){return _0x573a37-_0x26960b;},'NiIQd':function(_0x4b56c1,_0x333614){return _0x4b56c1!==_0x333614;},'XMsyC':'mysql','YoChl':'Skipping cleanup of duplicate subscriptions - database is not MySQL','IImej':function(_0x5ed093,_0x31709c){return _0x5ed093(_0x31709c);},'ySqAK':'members_stripe_customers_subscriptions','FgmOG':'subscription_id','ItAdd':'count','kMuEW':function(_0x381eff,_0x15ef2e){return _0x381eff(_0x15ef2e);}};if(_0x26bd30['NiIQd'](_0x19a2b9['client']['config']['client'],_0x26bd30['XMsyC'])){logging['warn'](_0x26bd30['YoChl']);return;}const _0x4b7a63=await _0x26bd30['IImej'](_0x19a2b9,_0x26bd30['ySqAK'])['select'](_0x26bd30['FgmOG'])['count']('subscription_id\x20as\x20count')['groupBy'](_0x26bd30['FgmOG'])['having'](_0x26bd30['ItAdd'],'>',0x1);if(!_0x4b7a63['length']){logging['info']('No duplicate subscriptions found');return;}logging['info']('Found '+_0x4b7a63['length']+' duplicate stripe subscriptions');for(const _0x4d41a9 of _0x4b7a63){const _0x3e4659=await _0x26bd30['kMuEW'](_0x19a2b9,_0x26bd30['ySqAK'])['select']()['where'](_0x26bd30['FgmOG'],_0x4d41a9['subscription_id']);const _0xefcba5=_0x3e4659['sort']((_0x52fe4b,_0x37652e)=>{return _0x26bd30['wfSZj'](_0x37652e['updated_at'],_0x52fe4b['updated_at']);});const [_0x18c3d9,..._0x1bc1a3]=_0xefcba5;logging['info']('Keeping newest subscription '+_0x18c3d9['id']+'\x20-\x20'+_0x18c3d9['subscription_id']+', last updated at '+_0x18c3d9['updated_at']);for(const _0x1b814f of _0x1bc1a3){logging['info']('Deleting\x20duplicate\x20subscription\x20'+_0x1b814f['id']+'\x20-\x20'+_0x1b814f['subscription_id']+',\x20last\x20updated\x20at\x20'+_0x1b814f['updated_at']);await _0x26bd30['kMuEW'](_0x19a2b9,_0x26bd30['ySqAK'])['where']({'id':_0x1b814f['id']})['del']();}}},async 'down'(){}};