import _0x52008c from'dns';import{Meteor}from'meteor/meteor';import _0x293397 from'mem';import*as _0x51e01d from'../functions/errors';import{logger}from'./logger';import{isFederationEnabled}from'./isFederationEnabled';import{federationRequest}from'./http';const dnsResolveSRV=Meteor['wrapAsync'](_0x52008c['resolveSrv']);const dnsResolveTXT=Meteor['wrapAsync'](_0x52008c['resolveTxt']);const cacheMaxAge=0x36ee80;const memoizedDnsResolveSRV=_0x293397(dnsResolveSRV,{'maxAge':cacheMaxAge});const memoizedDnsResolveTXT=_0x293397(dnsResolveTXT,{'maxAge':cacheMaxAge});const hubUrl=process['env']['NODE_ENV']==='development'?'http://localhost:8080':'https://hub.rocket.chat';export function registerWithHub(peerDomain,url,publicKey){var fwMpKS={'qcWJW':'dns.search','Zissp':function(callee,param1,param2,param3){return callee(param1,param2,param3);},'GgZTH':'POST','exrAj':'EvEnm','sjBuH':'dns.registerWithHub'};const body={'domain':peerDomain,'url':url,'public_key':publicKey};try{fwMpKS['Zissp'](federationRequest,fwMpKS['GgZTH'],hubUrl+'/api/v1/peers',body);return!![];}catch(_0x69edb7){if('mLnnM'!==fwMpKS['exrAj']){logger['dns']['error'](_0x69edb7);throw _0x51e01d['peerCouldNotBeRegisteredWithHub'](fwMpKS['sjBuH']);}else{throw _0x51e01d['disabled'](fwMpKS['qcWJW']);}}}export function searchHub(peerDomain){var WjRend={'Xnivx':function(callee,param1,param2){return callee(param1,param2);},'nwPIW':'GET','FZVPt':function(x,y){return x===y;},'dZaEa':'PYWAT','eARrl':'TLjaD','HqYkc':'dns.registerWithHub'};try{logger['dns']['debug']('searchHub: peerDomain='+peerDomain);const {data:{peer}}=WjRend['Xnivx'](federationRequest,WjRend['nwPIW'],hubUrl+'/api/v1/peers?search='+peerDomain);if(!peer){if(WjRend['FZVPt'](WjRend['dZaEa'],WjRend['eARrl'])){protocol=null;}else{logger['dns']['debug']('searchHub: could not find peerDomain='+peerDomain);throw _0x51e01d['peerCouldNotBeRegisteredWithHub'](WjRend['HqYkc']);}}const {url,public_key:publicKey}=peer;logger['dns']['debug']('searchHub: found peerDomain='+peerDomain+' url='+url);return{'url':url,'peerDomain':peerDomain,'publicKey':publicKey};}catch(_0x529b95){logger['dns']['error'](_0x529b95);throw _0x51e01d['peerNotFoundUsingDNS']('dns.searchHub');}}export function search(peerDomain){var FWQlLz={'oOpSV':'dns.registerWithHub','mwytM':'http','odfnw':function(callee,param1,param2,param3){return callee(param1,param2,param3);},'wLjSF':'POST','TIGFF':function(callee,param1){return callee(param1);},'gykcW':function(callee,param1){return callee(param1);},'WlkNx':function(x,y){return x!==y;},'PlwaW':'dns.search','viNaA':function(callee,param1){return callee(param1);},'pfilg':'KjYAz','CWDCi':'yTJHJ','KJmCD':function(callee,param1){return callee(param1);},'HkIol':function(x,y){return x===y;},'oKwgu':'nitdu','ZjwKa':function(x,y){return x===y;},'lEQyK':'fxcaH','Gianh':'0|6|2|4|1|5|3','zMNHL':function(x,y){return x!==y;},'EZfOf':'https','ubJVb':function(x,y){return x||y;},'IbpDD':'hyTdp','NxlkO':function(callee,param1){return callee(param1);},'xWIzC':function(x,y){return x===y;},'sPxPe':'uefhm','ljWEI':function(callee,param1){return callee(param1);}};if(!isFederationEnabled()){if(FWQlLz['WlkNx']('podKf','podKf')){logger['dns']['error'](err);throw _0x51e01d['peerNotFoundUsingDNS']('dns.searchHub');}else{throw _0x51e01d['disabled'](FWQlLz['PlwaW']);}}logger['dns']['debug']('search: peerDomain='+peerDomain);let srvEntries=[];let protocol='';try{logger['dns']['debug']('search: peerDomain='+peerDomain+'\x20srv=_rocketchat._https.'+peerDomain);srvEntries=FWQlLz['viNaA'](memoizedDnsResolveSRV,'_rocketchat._https.'+peerDomain);protocol='https';}catch(_0x1ed596){}if(!srvEntries['length']){if(FWQlLz['pfilg']!==FWQlLz['pfilg']){logger['dns']['debug']('searchHub: could not find peerDomain='+peerDomain);throw _0x51e01d['peerCouldNotBeRegisteredWithHub'](FWQlLz['oOpSV']);}else{try{if(FWQlLz['CWDCi']===FWQlLz['CWDCi']){logger['dns']['debug']('search: peerDomain='+peerDomain+'\x20srv=_rocketchat._http.'+peerDomain);srvEntries=FWQlLz['KJmCD'](memoizedDnsResolveSRV,'_rocketchat._http.'+peerDomain);protocol='http';}else{logger['dns']['debug']('search: peerDomain='+peerDomain+' srv=_rocketchat._http.'+peerDomain);srvEntries=memoizedDnsResolveSRV('_rocketchat._http.'+peerDomain);protocol=FWQlLz['mwytM'];}}catch(_0x54e7e7){}}}if(!srvEntries['length']){if(FWQlLz['HkIol'](FWQlLz['oKwgu'],'WETJL')){try{logger['dns']['debug']('search:\x20peerDomain='+peerDomain+' srv=_rocketchat._http.'+peerDomain);srvEntries=memoizedDnsResolveSRV('_rocketchat._http.'+peerDomain);protocol='http';}catch(_0x3615ab){}}else{try{if(FWQlLz['ZjwKa'](FWQlLz['lEQyK'],'JPhyT')){FWQlLz['odfnw'](federationRequest,FWQlLz['wLjSF'],hubUrl+'/api/v1/peers',body);return!![];}else{var BtbFLn=FWQlLz['Gianh']['split']('|'),gWQjRS=0x0;while(!![]){switch(BtbFLn[gWQjRS++]){case'0':logger['dns']['debug']('search: peerDomain='+peerDomain+' srv=_rocketchat._tcp.'+peerDomain);continue;case'1':protocol=memoizedDnsResolveSRV('rocketchat-tcp-protocol.'+peerDomain);continue;case'2':protocol='https';continue;case'3':if(FWQlLz['zMNHL'](protocol,'http')&&protocol!==FWQlLz['EZfOf']){protocol=null;}continue;case'4':logger['dns']['debug']('search: peerDomain='+peerDomain+'\x20txt=rocketchat-tcp-protocol.'+peerDomain);continue;case'5':protocol=protocol[0x0]['join']('');continue;case'6':srvEntries=memoizedDnsResolveSRV('_rocketchat._tcp.'+peerDomain);continue;}break;}}}catch(_0x209a1c){}}}const [srvEntry]=srvEntries;if(FWQlLz['ubJVb'](!srvEntry,!protocol)){if(FWQlLz['ZjwKa']('hyTdp',FWQlLz['IbpDD'])){logger['dns']['debug']('search: could not find valid SRV entry peerDomain='+peerDomain+' srvEntry='+JSON['stringify'](srvEntry)+' protocol='+protocol);return FWQlLz['NxlkO'](searchHub,peerDomain);}else{logger['dns']['debug']('search: peerDomain='+peerDomain+' txt=rocketchat-public-key.'+peerDomain);const _0x512d98=FWQlLz['TIGFF'](memoizedDnsResolveTXT,'rocketchat-public-key.'+peerDomain);publicKey=_0x512d98[0x0]['join']('');}}let publicKey=null;try{logger['dns']['debug']('search: peerDomain='+peerDomain+' txt=rocketchat-public-key.'+peerDomain);const publicKeyTxtRecords=FWQlLz['NxlkO'](memoizedDnsResolveTXT,'rocketchat-public-key.'+peerDomain);publicKey=publicKeyTxtRecords[0x0]['join']('');}catch(_0x2cc12f){}if(!publicKey){if(FWQlLz['xWIzC'](FWQlLz['sPxPe'],'uefhm')){logger['dns']['debug']('search: could not find TXT entry for peerDomain='+peerDomain+'\x20-\x20SRV\x20entry\x20found');return FWQlLz['ljWEI'](searchHub,peerDomain);}else{logger['dns']['debug']('search: could not find TXT entry for peerDomain='+peerDomain+' - SRV entry found');return FWQlLz['gykcW'](searchHub,peerDomain);}}logger['dns']['debug']('search: found peerDomain='+peerDomain+'\x20srvEntry='+srvEntry['name']+':'+srvEntry['port']+' protocol='+protocol);return{'url':protocol+'://'+srvEntry['name']+':'+srvEntry['port'],'peerDomain':peerDomain,'publicKey':publicKey};}