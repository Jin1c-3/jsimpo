// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.
'use strict';const common=require('../common');const fixtures=require('../common/fixtures');if(!common['hasCrypto'])common['skip']('missing crypto');process['env']['NODE_TLS_REJECT_UNAUTHORIZED']='0';common['expectWarning']('Warning','Setting the NODE_TLS_REJECT_UNAUTHORIZED environment variable to \'0\' '+'makes TLS connections and HTTPS requests insecure by disabling '+'certificate\x20verification.');const assert=require('assert');const https=require('https');function read(_0x26a44c){return fixtures['readKey'](_0x26a44c);}const key1=read('agent1-key.pem');const cert1=read('agent1-cert.pem');const key2=read('agent2-key.pem');const cert2=read('agent2-cert.pem');const key3=read('agent3-key.pem');const cert3=read('agent3-cert.pem');const ca1=read('ca1-cert.pem');const ca2=read('ca2-cert.pem');const agent0=new https[('Agent')]();const agent1=new https[('Agent')]({'ca':[ca1]});const agent2=new https[('Agent')]({'ca':[ca2]});const agent3=new https['Agent']({'ca':[ca1,ca2]});const options1={'key':key1,'cert':cert1};const options2={'key':key2,'cert':cert2};const options3={'key':key3,'cert':cert3};const server1=server(options1);const server2=server(options2);const server3=server(options3);let listenWait=0x0;server1['listen'](0x0,listening());server2['listen'](0x0,listening());server3['listen'](0x0,listening());const responseErrors={};let pending=0x0;function server(_0x539789){const _0xb74b6f=https['createServer'](_0x539789,handler);_0xb74b6f['requests']=[];_0xb74b6f['expectCount']=0x0;return _0xb74b6f;}function handler(_0x3d671f,_0x29d681){var _0x29e382={'QbJwJ':'foo','WINux':'bar'};this['requests']['push'](_0x3d671f['url']);_0x29d681['statusCode']=0xc8;_0x29d681['setHeader'](_0x29e382['QbJwJ'],_0x29e382['WINux']);_0x29d681['end']('hello, world\n');}function listening(){var _0x596f7e={'hKXRd':function(_0x2760e3,_0x564877){return _0x2760e3===_0x564877;},'tbvKH':function(_0x5b7699){return _0x5b7699();}};listenWait++;return()=>{listenWait--;if(_0x596f7e['hKXRd'](listenWait,0x0)){_0x596f7e['tbvKH'](allListening);}};}function makeReq(_0x407271,_0x5a3c0a,_0x4e8f12,_0x55c88b,_0x40c7b8){var _0x197a94={'jkvQs':function(_0x54faac,_0x3a8d1a,_0x4df25f,_0x2c9d24){return _0x54faac(_0x3a8d1a,_0x4df25f,_0x2c9d24);},'ukCHL':'/inv1','odyNA':'/inv1-ca1','ZznsT':function(_0x3766e4,_0xe6f8da,_0x3b4e0d,_0x1a5dc8,_0x4d1eff,_0xabd24c){return _0x3766e4(_0xe6f8da,_0x3b4e0d,_0x1a5dc8,_0x4d1eff,_0xabd24c);},'LQaFW':'ERR_TLS_CERT_ALTNAME_INVALID','YTfbH':'/val1-ca1','ubysg':'agent1','dHYJw':'/val1-ca1ca2','gOpbd':function(_0x9e4c90,_0x56c8f3,_0x137a06,_0xd1a2d2,_0x5dac14,_0x5e4f56){return _0x9e4c90(_0x56c8f3,_0x137a06,_0xd1a2d2,_0x5dac14,_0x5e4f56);},'pEAKa':'/inv1-ca2','HKBXT':function(_0x3e865a,_0x3d3ebd,_0x51e5ed,_0x5af0e0){return _0x3e865a(_0x3d3ebd,_0x51e5ed,_0x5af0e0);},'mmaot':'DEPTH_ZERO_SELF_SIGNED_CERT','FoPwL':function(_0x335b2d,_0x1dbd47,_0x4e6d24,_0x464d28,_0xde3f53,_0x42c13f){return _0x335b2d(_0x1dbd47,_0x4e6d24,_0x464d28,_0xde3f53,_0x42c13f);},'yToQH':'/inv2-ca1','XbjiG':'agent2','DJQcn':function(_0x5bb105,_0x193d80,_0xabb058,_0x41fc25,_0x4be135,_0x498450){return _0x5bb105(_0x193d80,_0xabb058,_0x41fc25,_0x4be135,_0x498450);},'QRlmb':'/inv2-ca1ca2','TyBxW':'/inv3','wbJzX':'/inv3-ca2','UMSJL':'/inv3-ca1ca2','vByHC':'agent3','zckEe':'/val3-ca1ca2','KYySY':'/inv3-ca1','Lcxjz':'UNABLE_TO_VERIFY_LEAF_SIGNATURE','jzBEz':'bar','ozXrr':'hello, world\n','IFBUg':'bhxDq','TrRmY':function(_0x43aaa4,_0x5ccca9){return _0x43aaa4===_0x5ccca9;},'glxVv':'dDNiJ','npVzI':function(_0x5e6269,_0x5cf4bb){return _0x5e6269===_0x5cf4bb;},'EJiJf':'VzWkt','AfVlb':function(_0x2bc23f,_0x4a0f13){return _0x2bc23f!==_0x4a0f13;},'mVkMt':'CXNQF','XPtjo':'FRWlG','wxsKj':'fXFdA','ODPtc':function(_0x4a9217,_0x509913){return _0x4a9217===_0x509913;},'vFLaT':function(_0x3fbf1a,_0x15f4ec){return _0x3fbf1a===_0x15f4ec;},'lVNaR':'response'};pending++;const _0x352f56={'port':_0x5a3c0a,'path':_0x407271,'ca':_0x40c7b8};if(!_0x40c7b8){_0x352f56['agent']=agent0;}else{if(_0x197a94['npVzI']('VzWkt',_0x197a94['EJiJf'])){if(!Array['isArray'](_0x40c7b8))_0x40c7b8=[_0x40c7b8];if(_0x40c7b8['includes'](ca1)&&_0x40c7b8['includes'](ca2)){_0x352f56['agent']=agent3;}else if(_0x40c7b8['includes'](ca1)){_0x352f56['agent']=agent1;}else if(_0x40c7b8['includes'](ca2)){_0x352f56['agent']=agent2;}else{if(_0x197a94['AfVlb'](_0x197a94['mVkMt'],_0x197a94['mVkMt'])){_0x352f56['agent']=agent0;}else{_0x352f56['agent']=agent0;}}}else{_0x352f56['headers']={'host':_0x55c88b};}}if(_0x55c88b){if(_0x197a94['npVzI'](_0x197a94['XPtjo'],_0x197a94['wxsKj'])){const _0x100edc=server1['address']()['port'];const _0x52d0cb=server2['address']()['port'];const _0x4d6878=server3['address']()['port'];_0x197a94['jkvQs'](makeReq,_0x197a94['ukCHL'],_0x100edc,'UNABLE_TO_VERIFY_LEAF_SIGNATURE');makeReq(_0x197a94['odyNA'],_0x100edc,'ERR_TLS_CERT_ALTNAME_INVALID',null,ca1);_0x197a94['ZznsT'](makeReq,'/inv1-ca1ca2',_0x100edc,_0x197a94['LQaFW'],null,[ca1,ca2]);_0x197a94['ZznsT'](makeReq,_0x197a94['YTfbH'],_0x100edc,null,_0x197a94['ubysg'],ca1);_0x197a94['ZznsT'](makeReq,_0x197a94['dHYJw'],_0x100edc,null,'agent1',[ca1,ca2]);_0x197a94['gOpbd'](makeReq,_0x197a94['pEAKa'],_0x100edc,'UNABLE_TO_VERIFY_LEAF_SIGNATURE','agent1',ca2);_0x197a94['HKBXT'](makeReq,'/inv2',_0x52d0cb,_0x197a94['mmaot']);_0x197a94['FoPwL'](makeReq,_0x197a94['yToQH'],_0x52d0cb,_0x197a94['mmaot'],_0x197a94['XbjiG'],ca1);_0x197a94['DJQcn'](makeReq,_0x197a94['QRlmb'],_0x52d0cb,'DEPTH_ZERO_SELF_SIGNED_CERT',_0x197a94['XbjiG'],[ca1,ca2]);makeReq(_0x197a94['TyBxW'],_0x4d6878,'UNABLE_TO_VERIFY_LEAF_SIGNATURE');makeReq(_0x197a94['wbJzX'],_0x4d6878,'ERR_TLS_CERT_ALTNAME_INVALID',null,ca2);_0x197a94['DJQcn'](makeReq,_0x197a94['UMSJL'],_0x4d6878,'ERR_TLS_CERT_ALTNAME_INVALID',null,[ca1,ca2]);_0x197a94['DJQcn'](makeReq,'/val3-ca2',_0x4d6878,null,_0x197a94['vByHC'],ca2);_0x197a94['DJQcn'](makeReq,_0x197a94['zckEe'],_0x4d6878,null,_0x197a94['vByHC'],[ca1,ca2]);makeReq(_0x197a94['KYySY'],_0x4d6878,_0x197a94['Lcxjz'],'agent1',ca1);}else{_0x352f56['headers']={'host':_0x55c88b};}}const _0x226237=https['get'](_0x352f56);const _0x1c58c5=_0x197a94['ODPtc'](_0x5a3c0a,server1['address']()['port'])?server1:_0x5a3c0a===server2['address']()['port']?server2:_0x197a94['vFLaT'](_0x5a3c0a,server3['address']()['port'])?server3:null;if(!_0x1c58c5)throw new Error('invalid port: '+_0x5a3c0a);_0x1c58c5['expectCount']++;_0x226237['on'](_0x197a94['lVNaR'],common['mustCall'](_0xcecb3a=>{var _0x2963f2={'HAhwt':'foo','Pgjwj':_0x197a94['jzBEz'],'QCTIO':_0x197a94['ozXrr']};if(_0x197a94['IFBUg']!==_0x197a94['IFBUg']){server1['close']();server2['close']();server3['close']();}else{assert['strictEqual'](_0xcecb3a['connection']['authorizationError'],_0x4e8f12);responseErrors[_0x407271]=_0xcecb3a['connection']['authorizationError'];pending--;if(_0x197a94['TrRmY'](pending,0x0)){if(_0x197a94['glxVv']===_0x197a94['glxVv']){server1['close']();server2['close']();server3['close']();}else{this['requests']['push'](_0x226237['url']);_0xcecb3a['statusCode']=0xc8;_0xcecb3a['setHeader'](_0x2963f2['HAhwt'],_0x2963f2['Pgjwj']);_0xcecb3a['end'](_0x2963f2['QCTIO']);}}_0xcecb3a['resume']();}}));}function allListening(){var _0x3a84d8={'cjucZ':function(_0x4b4516,_0x56542d,_0x298646,_0x49b0ae){return _0x4b4516(_0x56542d,_0x298646,_0x49b0ae);},'mfvQs':'/inv1','dmkUl':'UNABLE_TO_VERIFY_LEAF_SIGNATURE','zGiba':function(_0x43f145,_0xd67e87,_0x571a29,_0x1a8348,_0x32548f,_0x228e7a){return _0x43f145(_0xd67e87,_0x571a29,_0x1a8348,_0x32548f,_0x228e7a);},'QcIxZ':'/inv1-ca1','RJFwF':'ERR_TLS_CERT_ALTNAME_INVALID','jEcnX':function(_0x234637,_0x3b2977,_0x3f4b98,_0x46d6a3,_0x19f05f,_0xce9dd8){return _0x234637(_0x3b2977,_0x3f4b98,_0x46d6a3,_0x19f05f,_0xce9dd8);},'fZngh':function(_0x25f22f,_0x56e28e,_0x49de8d,_0x5a266e,_0x1cffc2,_0x2f7f41){return _0x25f22f(_0x56e28e,_0x49de8d,_0x5a266e,_0x1cffc2,_0x2f7f41);},'aUGHx':'/val1-ca1','pAHDV':'agent1','nJNbC':'/val1-ca1ca2','olBzE':'/inv2','bOalk':'DEPTH_ZERO_SELF_SIGNED_CERT','wGBMu':'/inv2-ca1','Wbhbw':'agent2','odFVT':function(_0x6100a5,_0x3a6763,_0x5eada1,_0x1da2dc){return _0x6100a5(_0x3a6763,_0x5eada1,_0x1da2dc);},'BzyVa':'/inv3','QxXdQ':function(_0x10b198,_0x1197c5,_0x374bfc,_0x229f4a,_0x4b39a6,_0x3bfb79){return _0x10b198(_0x1197c5,_0x374bfc,_0x229f4a,_0x4b39a6,_0x3bfb79);},'XirRe':function(_0x210a2f,_0x35d2fa,_0x11ad5f,_0x4b1108,_0x57978c,_0x8a9c05){return _0x210a2f(_0x35d2fa,_0x11ad5f,_0x4b1108,_0x57978c,_0x8a9c05);},'zXZEl':'agent3'};const _0x55eb11=server1['address']()['port'];const _0x57fb70=server2['address']()['port'];const _0x2cc975=server3['address']()['port'];_0x3a84d8['cjucZ'](makeReq,_0x3a84d8['mfvQs'],_0x55eb11,_0x3a84d8['dmkUl']);_0x3a84d8['zGiba'](makeReq,_0x3a84d8['QcIxZ'],_0x55eb11,_0x3a84d8['RJFwF'],null,ca1);_0x3a84d8['jEcnX'](makeReq,'/inv1-ca1ca2',_0x55eb11,_0x3a84d8['RJFwF'],null,[ca1,ca2]);_0x3a84d8['fZngh'](makeReq,_0x3a84d8['aUGHx'],_0x55eb11,null,_0x3a84d8['pAHDV'],ca1);_0x3a84d8['fZngh'](makeReq,_0x3a84d8['nJNbC'],_0x55eb11,null,'agent1',[ca1,ca2]);makeReq('/inv1-ca2',_0x55eb11,_0x3a84d8['dmkUl'],_0x3a84d8['pAHDV'],ca2);_0x3a84d8['cjucZ'](makeReq,_0x3a84d8['olBzE'],_0x57fb70,_0x3a84d8['bOalk']);_0x3a84d8['fZngh'](makeReq,_0x3a84d8['wGBMu'],_0x57fb70,_0x3a84d8['bOalk'],_0x3a84d8['Wbhbw'],ca1);_0x3a84d8['fZngh'](makeReq,'/inv2-ca1ca2',_0x57fb70,_0x3a84d8['bOalk'],'agent2',[ca1,ca2]);_0x3a84d8['odFVT'](makeReq,_0x3a84d8['BzyVa'],_0x2cc975,_0x3a84d8['dmkUl']);_0x3a84d8['QxXdQ'](makeReq,'/inv3-ca2',_0x2cc975,_0x3a84d8['RJFwF'],null,ca2);_0x3a84d8['QxXdQ'](makeReq,'/inv3-ca1ca2',_0x2cc975,_0x3a84d8['RJFwF'],null,[ca1,ca2]);_0x3a84d8['XirRe'](makeReq,'/val3-ca2',_0x2cc975,null,'agent3',ca2);_0x3a84d8['XirRe'](makeReq,'/val3-ca1ca2',_0x2cc975,null,_0x3a84d8['zXZEl'],[ca1,ca2]);_0x3a84d8['XirRe'](makeReq,'/inv3-ca1',_0x2cc975,_0x3a84d8['dmkUl'],_0x3a84d8['pAHDV'],ca1);}process['on']('exit',()=>{assert['strictEqual'](server1['requests']['length'],server1['expectCount']);assert['strictEqual'](server2['requests']['length'],server2['expectCount']);assert['strictEqual'](server3['requests']['length'],server3['expectCount']);});