import*as _0x1ef1b0 from'path';import _0x476993 from'del';import{writeFile,stat,mkdir}from'fs/promises';import{repoRoot,benchesRoot,toUrl}from'./utils.js';import{defaultBenchOptions}from'./bench.js';import{prepare}from'./prepare.js';const measureName='duration';const warnings=new Set([]);const TACH_SCHEMA='https://raw.githubusercontent.com/Polymer/tachometer/master/config.schema.json';export const baseTraceLogDir=(...args)=>_0x1ef1b0['join'](benchesRoot('logs'),...args);async function validateFileDep(framework){var eWoqaI={'Rpnju':'string','iRtah':function(callee,param1){return callee(param1);}};try{if(typeof framework===eWoqaI['Rpnju']){await eWoqaI['iRtah'](stat,framework['replace'](/^file:/,''));return!![];}else{return![];}}catch(_0x8120e){console['log']('Stat\x20error:',_0x8120e);return![];}}export const frameworks=[{'label':'preact-v8','dependencies':{'framework':'file:'+repoRoot('benches/proxy-packages/preact-v8-proxy')},'isValid'(){var DuEUDH={'JxxSY':function(callee,param1){return callee(param1);}};return DuEUDH['JxxSY'](validateFileDep,this['dependencies']['framework']);}},{'label':'preact-master','dependencies':{'framework':'file:'+repoRoot('benches/proxy-packages/preact-master-proxy')},async 'isValid'(){var QvuJTm={'YKELI':function(callee,param1){return callee(param1);},'lHuwG':function(callee,param1){return callee(param1);},'ypLIo':'preact.tgz'};try{await QvuJTm['YKELI'](stat,QvuJTm['lHuwG'](repoRoot,QvuJTm['ypLIo']));return QvuJTm['lHuwG'](validateFileDep,this['dependencies']['framework']);}catch(_0x5f4c6f){return![];}}},{'label':'preact-local','dependencies':{'framework':'file:'+repoRoot('benches/proxy-packages/preact-local-proxy')},'isValid'(){var hfpeDs={'bHYHq':function(callee,param1){return callee(param1);}};return hfpeDs['bHYHq'](validateFileDep,this['dependencies']['framework']);}}];function getBaseBenchmarkConfig(benchPath){var fwZUnP={'VsLyZ':'.html','GigOS':function(callee,param1){return callee(param1);},'bdZKt':'duration','cTtYa':'performance','sXLMi':'expression','crkja':'window.usedJSHeapSize','AGcEK':'run-final','NLYqC':'usedJSHeapSize'};let name=_0x1ef1b0['basename'](benchPath)['replace'](fwZUnP['VsLyZ'],'');let url=_0x1ef1b0['posix']['relative'](toUrl(benchesRoot()),fwZUnP['GigOS'](toUrl,benchPath));let measurement;if(name=='02_replace1k'){const WARMUP_COUNT=0x5;measurement=[{'name':fwZUnP['bdZKt'],'mode':fwZUnP['cTtYa'],'entryName':measureName},{'name':'usedJSHeapSize','mode':fwZUnP['sXLMi'],'expression':fwZUnP['crkja']}];for(let i=0x0;i<WARMUP_COUNT;i++){const entryName='run-warmup-'+i;measurement['push']({'name':entryName,'mode':fwZUnP['cTtYa'],'entryName':entryName});}measurement['push']({'name':'run-final','mode':fwZUnP['cTtYa'],'entryName':fwZUnP['AGcEK']});}else{measurement=[{'name':fwZUnP['bdZKt'],'mode':fwZUnP['cTtYa'],'entryName':measureName},{'name':fwZUnP['NLYqC'],'mode':fwZUnP['sXLMi'],'expression':fwZUnP['crkja']}];}return{'name':name,'url':url,'measurement':measurement};}export async function generateSingleConfig(benchFile,opts){var xzYlJn={'wzqTK':function(callee,param1,param2){return callee(param1,param2);},'CbSdM':function(callee,param1){return callee(param1);}};const benchPath=await xzYlJn['wzqTK'](benchesRoot,'src',benchFile);const results=await xzYlJn['CbSdM'](stat,benchPath);if(!results['isFile']){throw new Error('Given path is not a file: '+benchPath);}await xzYlJn['wzqTK'](generateConfig,benchPath,{...defaultBenchOptions,...opts});}export async function generateConfig(benchPath,options){var ylxIVn={'qowPU':function(x,y){return x+y;},'xJzlP':function(x,y){return x+y;},'EPSMg':'Stat error:','TFrlY':function(callee,param1){return callee(param1);},'PzGKT':function(x,y){return x==y;},'SkGOa':'chrome','OZZyN':'OMxlD','otvhw':'aqGhF','AglYf':function(callee,param1,param2){return callee(param1,param2);},'YrXPV':'**/*','ruepv':function(callee,param1,param2){return callee(param1,param2);},'qcXLa':function(x,y){return x!==y;},'phTen':'JxsFw','NCRSt':'string','cypzn':function(x,y){return x===y;},'JwKSo':'Iiksg','ecIKk':function(x,y){return x==y;},'OxWcL':'GirfJ','XjHyb':function(x,y){return x!==y;},'iBhJH':'HkHiZ','quhXi':'Only\x20string/npm\x20dependencies\x20are\x20supported\x20at\x20this\x20time','ErLNb':'sample-size','aPqXm':function(x,y){return x==y;}};let expand;let browser;const baseBenchConfig=ylxIVn['TFrlY'](getBaseBenchmarkConfig,benchPath);if(Array['isArray'](options['browser'])){expand=options['browser']['map'](browserOpt=>({'browser':parseBrowserOption(browserOpt)}));}else{browser=parseBrowserOption(options['browser']);}if(ylxIVn['PzGKT'](browser['name'],ylxIVn['SkGOa'])&&options['trace']){if(ylxIVn['OZZyN']!==ylxIVn['otvhw']){const traceLogDir=baseTraceLogDir(baseBenchConfig['name']);await ylxIVn['AglYf'](_0x476993,ylxIVn['YrXPV'],{'cwd':traceLogDir});await ylxIVn['ruepv'](mkdir,traceLogDir,{'recursive':!![]});browser['trace']={'logDir':traceLogDir};}else{expand=options['browser']['map'](_0x85168a=>({'browser':parseBrowserOption(_0x85168a)}));}}let frameworksToRun;if(!options['framework']){if(ylxIVn['qcXLa'](ylxIVn['phTen'],ylxIVn['phTen'])){console['error'](ylxIVn['qowPU'](ylxIVn['xJzlP']('Framework options did not match any configured frameworks:\n','	Provided option: '+options['framework']+'\x0a'),'	Available frameworks: ['+frameworks['map'](_0x4f680a=>JSON['stringify'](_0x4f680a['label']))['join'](',\x20')+']\x0a'));throw new Error('Framework\x20option\x20did\x20not\x20match\x20any\x20configured\x20frameworks:\x20'+options['framework']);}else{frameworksToRun=frameworks;}}else if(typeof options['framework']===ylxIVn['NCRSt']){const match=frameworks['find'](f=>f['label']==options['framework']);frameworksToRun=match?[match]:[];}else if(Array['isArray'](options['framework'])){frameworksToRun=frameworks['filter'](f=>options['framework']['includes'](f['label']));}else{if(ylxIVn['cypzn'](ylxIVn['JwKSo'],ylxIVn['JwKSo'])){throw new Error('Unrecognized framework option: '+options['framework']);}else{console['log'](ylxIVn['EPSMg'],e);return![];}}if(ylxIVn['ecIKk'](frameworksToRun['length'],0x0)){console['error'](ylxIVn['xJzlP']('Framework\x20options\x20did\x20not\x20match\x20any\x20configured\x20frameworks:\x0a','	Provided option: '+options['framework']+'\x0a')+('\x09Available\x20frameworks:\x20['+frameworks['map'](f=>JSON['stringify'](f['label']))['join'](',\x20')+']\x0a'));throw new Error('Framework option did not match any configured frameworks: '+options['framework']);}const benchmarks=[];for(let framework of frameworksToRun){if(ylxIVn['qcXLa'](ylxIVn['OxWcL'],'qhOkX')){let frameworkPath=framework['dependencies']['framework'];if(ylxIVn['qcXLa'](typeof frameworkPath,ylxIVn['NCRSt'])){if(ylxIVn['XjHyb']('bwGZX',ylxIVn['iBhJH'])){throw new Error(ylxIVn['quhXi']);}else{throw new Error('Unrecognized framework option: '+options['framework']);}}if(!(await framework['isValid']())){const warnMsg='Could\x20not\x20locate\x20path\x20for\x20'+framework['label']+':\x20'+framework['dependencies']['framework']+'.\x20\x0aSkipping...';if(!warnings['has'](warnMsg)){console['warn'](warnMsg);warnings['add'](warnMsg);}continue;}benchmarks['push']({...baseBenchConfig,'packageVersions':framework,'browser':browser,'expand':expand});}else{browser=parseBrowserOption(options['browser']);}}if(ylxIVn['XjHyb'](options['prepare'],![])){if(ylxIVn['cypzn']('GRJeY','TyAYc')){console['warn'](warnMsg);warnings['add'](warnMsg);}else{await ylxIVn['TFrlY'](prepare,benchmarks['map'](b=>b['packageVersions']['label']));}}const config={'$schema':TACH_SCHEMA,'sampleSize':options[ylxIVn['ErLNb']],'timeout':options['timeout'],'horizons':options['horizon']['split'](','),'benchmarks':benchmarks};if(ylxIVn['aPqXm'](config['benchmarks']['length'],0x0)){if(options['framework']){const configuredFrameworks=frameworks['map'](f=>f['label'])['join'](',\x20');throw new Error('No benchmarks created. Does the specified framework match one of the configured frameworks? '+configuredFrameworks);}else{throw new Error('Unknown\x20failure:\x20no\x20benchmarks\x20created.\x20frameworksToRun:\x20'+frameworksToRun);}}const configPath=await writeConfig(baseBenchConfig['name'],config);return{'name':baseBenchConfig['name'],'configPath':configPath,'config':config};}async function writeConfig(name,config){var fXGDSQ={'QeieG':function(callee,param1,param2){return callee(param1,param2);},'dWwxn':'dist','BjRuB':'utf8'};const configPath=fXGDSQ['QeieG'](benchesRoot,fXGDSQ['dWwxn'],name+'.config.json');await mkdir(_0x1ef1b0['dirname'](configPath),{'recursive':!![]});await writeFile(configPath,JSON['stringify'](config,null,0x2),fXGDSQ['BjRuB']);return configPath;}function parseBrowserOption(str){var fTexcq={'FRbBa':'--js-flags=--expose-gc','dCnbl':'--enable-precise-memory-info','iRHPz':function(x,y){return x!==y;},'OPodm':function(x,y){return x+y;},'ASwzC':'-headless','KMvxs':function(x,y){return x===y;},'cMmxs':'zgJqT','VUpgZ':function(x,y){return x!==y;},'fzXUm':function(x,y){return x==y;},'dVLfT':'chrome'};let remoteUrl;const at=str['indexOf']('@');if(fTexcq['iRHPz'](at,-0x1)){remoteUrl=str['substring'](fTexcq['OPodm'](at,0x1));str=str['substring'](0x0,at);}const headless=str['endsWith'](fTexcq['ASwzC']);if(fTexcq['KMvxs'](headless,!![])){if(fTexcq['cMmxs']!=='VdlKD'){str=str['replace'](/-headless$/,'');}else{config['addArguments']=[fTexcq['FRbBa'],fTexcq['dCnbl']];}}const name=str;const config={'name':name,'headless':headless};if(fTexcq['VUpgZ'](remoteUrl,undefined)){config['remoteUrl']=remoteUrl;}if(fTexcq['fzXUm'](config['name'],fTexcq['dVLfT'])){config['addArguments']=[fTexcq['FRbBa'],fTexcq['dCnbl']];}return config;}