const fs=require('fs-extra');const path=require('path');const {promisifiedSpawn}=require('../utils/promisified-spawn');const {registryUrl}=require('./verdaccio-config');const NPMRCContent=registryUrl['replace'](/https?:/g,'')+'/:_authToken=\x22gatsby-dev\x22';const {getMonorepoPackageJsonPath}=require('../utils/get-monorepo-package-json-path');const {registerCleanupTask}=require('./cleanup-tasks');const adjustPackageJson=({monoRepoPackageJsonPath,packageName,versionPostFix,packagesToPublish,ignorePackageJSONChanges,root})=>{var _0x4baf2c={'bQAqq':function(_0x5d2e0a,_0x348735){return _0x5d2e0a(_0x348735);},'MaHcG':function(_0x2868a8,_0x4bd26a,_0x201307){return _0x2868a8(_0x4bd26a,_0x201307);}};const _0x233c36=fs['readFileSync'](monoRepoPackageJsonPath,'utf-8');const _0xeecec6=JSON['parse'](_0x233c36);_0xeecec6['version']=_0xeecec6['version']+'-dev-'+versionPostFix;packagesToPublish['forEach'](_0x55613b=>{if(_0xeecec6['dependencies']&&_0xeecec6['dependencies'][_0x55613b]){const _0xd29984=JSON['parse'](fs['readFileSync'](_0x4baf2c['bQAqq'](getMonorepoPackageJsonPath,{'packageName':_0x55613b,'root':root}),'utf-8'))['version'];_0xeecec6['dependencies'][_0x55613b]=_0xd29984+'-dev-'+versionPostFix;}});const _0x4ddb93=JSON['stringify'](_0xeecec6);const _0x44e459=_0x4baf2c['MaHcG'](ignorePackageJSONChanges,packageName,[_0x233c36,_0x4ddb93]);fs['outputFileSync'](monoRepoPackageJsonPath,_0x4ddb93);return{'newPackageVersion':_0xeecec6['version'],'unadjustPackageJson':_0x4baf2c['bQAqq'](registerCleanupTask,()=>{fs['outputFileSync'](monoRepoPackageJsonPath,_0x233c36);_0x44e459();})};};const createTemporaryNPMRC=({pathToPackage})=>{var _0x1c8b63={'kZOaM':function(_0x5bcfd7,_0x318264){return _0x5bcfd7(_0x318264);}};const _0x29bba9=path['join'](pathToPackage,'.npmrc');fs['outputFileSync'](_0x29bba9,NPMRCContent);return _0x1c8b63['kZOaM'](registerCleanupTask,()=>{fs['removeSync'](_0x29bba9);});};const publishPackage=async({packageName,packagesToPublish,root,versionPostFix,ignorePackageJSONChanges})=>{var _0x4e7a45={'ChMOq':function(_0x5e2803,_0x4fee99){return _0x5e2803(_0x4fee99);},'irWtu':function(_0x4bd280,_0x2dae84){return _0x4bd280(_0x2dae84);},'GOiaP':function(_0x213f52,_0x3a7c61){return _0x213f52(_0x3a7c61);},'LAsBe':'rYvCO','LwvPH':function(_0x557983){return _0x557983();},'HTndR':function(_0x36ba67){return _0x36ba67();}};const _0x2cd82e=_0x4e7a45['irWtu'](getMonorepoPackageJsonPath,{'packageName':packageName,'root':root});const {unadjustPackageJson,newPackageVersion}=_0x4e7a45['GOiaP'](adjustPackageJson,{'monoRepoPackageJsonPath':_0x2cd82e,'packageName':packageName,'root':root,'versionPostFix':versionPostFix,'packagesToPublish':packagesToPublish,'ignorePackageJSONChanges':ignorePackageJSONChanges});const _0x50a846=path['dirname'](_0x2cd82e);const _0x3a6b0f=_0x4e7a45['GOiaP'](createTemporaryNPMRC,{'pathToPackage':_0x50a846});const _0x58d6bf=['npm',['publish','--tag','gatsby-dev','--registry='+registryUrl],{'cwd':_0x50a846}];console['log']('Publishing '+packageName+'@'+newPackageVersion+' to local registry');try{await _0x4e7a45['GOiaP'](promisifiedSpawn,_0x58d6bf);console['log']('Published '+packageName+'@'+newPackageVersion+' to local registry');}catch(_0x4a668f){if(_0x4e7a45['LAsBe']===_0x4e7a45['LAsBe']){console['error']('Failed\x20to\x20publish\x20'+packageName+'@'+newPackageVersion,_0x4a668f);process['exit'](0x1);}else{const _0x629f10=JSON['parse'](fs['readFileSync'](_0x4e7a45['ChMOq'](getMonorepoPackageJsonPath,{'packageName':packageThatWillBePublished,'root':root}),'utf-8'))['version'];monorepoPKGjson['dependencies'][packageThatWillBePublished]=_0x629f10+'-dev-'+versionPostFix;}}_0x4e7a45['LwvPH'](_0x3a6b0f);_0x4e7a45['HTndR'](unadjustPackageJson);return newPackageVersion;};exports['publishPackage']=publishPackage;