const logging=require("@tryghost/logging");module.exports={config:{transaction:true},async up({transacting:i}){if(i.client.config.client!=="mysql"){logging.warn("Skipping cleanup of duplicate subscriptions - database is not MySQL");return}const t=await i("members_stripe_customers_subscriptions").select("subscription_id").count("subscription_id as count").groupBy("subscription_id").having("count",">",1);if(!t.length){logging.info("No duplicate subscriptions found");return}logging.info(`Found ${t.length} duplicate stripe subscriptions`);for(const s of t){const n=await i("members_stripe_customers_subscriptions").select().where("subscription_id",s.subscription_id);const o=n.sort((i,t)=>{return t.updated_at-i.updated_at});const[e,...r]=o;logging.info(`Keeping newest subscription ${e.id} - ${e.subscription_id}, last updated at ${e.updated_at}`);for(const c of r){logging.info(`Deleting duplicate subscription ${c.id} - ${c.subscription_id}, last updated at ${c.updated_at}`);await i("members_stripe_customers_subscriptions").where({id:c.id}).del()}}},async down(){}};