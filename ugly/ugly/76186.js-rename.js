import{Meteor}from"meteor/meteor";import{Roles,Permissions,Settings}from"../../models/server";import{settings}from"../../settings/server";import{getSettingPermissionId,CONSTANTS}from"../lib";Meteor.startup(function(){const e=[{_id:"access-permissions",roles:["admin"]},{_id:"access-setting-permissions",roles:["admin"]},{_id:"add-oauth-service",roles:["admin"]},{_id:"add-user-to-joined-room",roles:["admin","owner","moderator"]},{_id:"add-user-to-any-c-room",roles:["admin"]},{_id:"add-user-to-any-p-room",roles:[]},{_id:"api-bypass-rate-limit",roles:["admin","bot","app"]},{_id:"archive-room",roles:["admin","owner"]},{_id:"assign-admin-role",roles:["admin"]},{_id:"assign-roles",roles:["admin"]},{_id:"ban-user",roles:["admin","owner","moderator"]},{_id:"bulk-register-user",roles:["admin"]},{_id:"change-livechat-room-visitor",roles:["admin","livechat-manager","livechat-agent"]},{_id:"create-c",roles:["admin","user","bot","app"]},{_id:"create-d",roles:["admin","user","bot","app"]},{_id:"create-p",roles:["admin","user","bot","app"]},{_id:"create-personal-access-tokens",roles:["admin","user"]},{_id:"create-user",roles:["admin"]},{_id:"clean-channel-history",roles:["admin"]},{_id:"delete-c",roles:["admin","owner"]},{_id:"delete-d",roles:["admin"]},{_id:"delete-message",roles:["admin","owner","moderator"]},{_id:"delete-own-message",roles:["admin","user"]},{_id:"delete-p",roles:["admin","owner"]},{_id:"delete-user",roles:["admin"]},{_id:"edit-message",roles:["admin","owner","moderator"]},{_id:"edit-other-user-active-status",roles:["admin"]},{_id:"edit-other-user-info",roles:["admin"]},{_id:"edit-other-user-password",roles:["admin"]},{_id:"edit-other-user-avatar",roles:["admin"]},{_id:"edit-other-user-e2ee",roles:["admin"]},{_id:"edit-other-user-totp",roles:["admin"]},{_id:"edit-privileged-setting",roles:["admin"]},{_id:"edit-room",roles:["admin","owner","moderator"]},{_id:"edit-room-avatar",roles:["admin","owner","moderator"]},{_id:"edit-room-retention-policy",roles:["admin"]},{_id:"force-delete-message",roles:["admin","owner"]},{_id:"join-without-join-code",roles:["admin","bot","app"]},{_id:"leave-c",roles:["admin","user","bot","anonymous","app"]},{_id:"leave-p",roles:["admin","user","bot","anonymous","app"]},{_id:"logout-other-user",roles:["admin"]},{_id:"manage-assets",roles:["admin"]},{_id:"manage-email-inbox",roles:["admin"]},{_id:"manage-emoji",roles:["admin"]},{_id:"manage-user-status",roles:["admin"]},{_id:"manage-outgoing-integrations",roles:["admin"]},{_id:"manage-incoming-integrations",roles:["admin"]},{_id:"manage-own-outgoing-integrations",roles:["admin"]},{_id:"manage-own-incoming-integrations",roles:["admin"]},{_id:"manage-oauth-apps",roles:["admin"]},{_id:"manage-selected-settings",roles:["admin"]},{_id:"mention-all",roles:["admin","owner","moderator","user"]},{_id:"mention-here",roles:["admin","owner","moderator","user"]},{_id:"mute-user",roles:["admin","owner","moderator"]},{_id:"remove-user",roles:["admin","owner","moderator"]},{_id:"run-import",roles:["admin"]},{_id:"run-migration",roles:["admin"]},{_id:"set-moderator",roles:["admin","owner"]},{_id:"set-owner",roles:["admin","owner"]},{_id:"send-many-messages",roles:["admin","bot","app"]},{_id:"set-leader",roles:["admin","owner"]},{_id:"unarchive-room",roles:["admin"]},{_id:"view-c-room",roles:["admin","user","bot","app","anonymous"]},{_id:"user-generate-access-token",roles:["admin"]},{_id:"view-d-room",roles:["admin","user","bot","app","guest"]},{_id:"view-full-other-user-info",roles:["admin"]},{_id:"view-history",roles:["admin","user","anonymous"]},{_id:"view-joined-room",roles:["guest","bot","app","anonymous"]},{_id:"view-join-code",roles:["admin"]},{_id:"view-logs",roles:["admin"]},{_id:"view-other-user-channels",roles:["admin"]},{_id:"view-p-room",roles:["admin","user","anonymous","guest"]},{_id:"view-privileged-setting",roles:["admin"]},{_id:"view-room-administration",roles:["admin"]},{_id:"view-statistics",roles:["admin"]},{_id:"view-user-administration",roles:["admin"]},{_id:"preview-c-room",roles:["admin","user","anonymous"]},{_id:"view-outside-room",roles:["admin","owner","moderator","user"]},{_id:"view-broadcast-member-list",roles:["admin","owner","moderator"]},{_id:"call-management",roles:["admin","owner","moderator"]},{_id:"create-invite-links",roles:["admin","owner","moderator"]},{_id:"view-l-room",roles:["livechat-manager","livechat-monitor","livechat-agent","admin"]},{_id:"view-livechat-manager",roles:["livechat-manager","livechat-monitor","admin"]},{_id:"edit-omnichannel-contact",roles:["livechat-manager","livechat-agent","admin"]},{_id:"view-livechat-rooms",roles:["livechat-manager","livechat-monitor","admin"]},{_id:"close-livechat-room",roles:["livechat-manager","livechat-monitor","livechat-agent","admin"]},{_id:"close-others-livechat-room",roles:["livechat-manager","livechat-monitor","admin"]},{_id:"on-hold-livechat-room",roles:["livechat-manager","livechat-monitor","livechat-agent","admin"]},{_id:"on-hold-others-livechat-room",roles:["livechat-manager","livechat-monitor","admin"]},{_id:"save-others-livechat-room-info",roles:["livechat-manager","livechat-monitor"]},{_id:"remove-closed-livechat-rooms",roles:["livechat-manager","livechat-monitor","admin"]},{_id:"view-livechat-analytics",roles:["livechat-manager","livechat-monitor","admin"]},{_id:"view-livechat-queue",roles:["livechat-manager","livechat-monitor","livechat-agent","admin"]},{_id:"transfer-livechat-guest",roles:["livechat-manager","livechat-monitor","admin"]},{_id:"manage-livechat-managers",roles:["livechat-manager","admin"]},{_id:"manage-livechat-agents",roles:["livechat-manager","livechat-monitor","admin"]},{_id:"manage-livechat-departments",roles:["livechat-manager","livechat-monitor","admin"]},{_id:"view-livechat-departments",roles:["livechat-manager","livechat-monitor","admin"]},{_id:"add-livechat-department-agents",roles:["livechat-manager","livechat-monitor","admin"]},{_id:"view-livechat-current-chats",roles:["livechat-manager","livechat-monitor","admin"]},{_id:"view-livechat-real-time-monitoring",roles:["livechat-manager","livechat-monitor","admin"]},{_id:"view-livechat-triggers",roles:["livechat-manager","admin"]},{_id:"view-livechat-customfields",roles:["livechat-manager","admin"]},{_id:"view-livechat-installation",roles:["livechat-manager","admin"]},{_id:"view-livechat-appearance",roles:["livechat-manager","admin"]},{_id:"view-livechat-webhooks",roles:["livechat-manager","admin"]},{_id:"view-livechat-facebook",roles:["livechat-manager","admin"]},{_id:"view-livechat-business-hours",roles:["livechat-manager","livechat-monitor","admin"]},{_id:"view-livechat-room-closed-same-department",roles:["livechat-manager","livechat-monitor","admin"]},{_id:"view-livechat-room-closed-by-another-agent",roles:["livechat-manager","livechat-monitor","admin"]},{_id:"view-livechat-room-customfields",roles:["livechat-manager","livechat-monitor","livechat-agent","admin"]},{_id:"edit-livechat-room-customfields",roles:["livechat-manager","livechat-monitor","livechat-agent","admin"]},{_id:"send-omnichannel-chat-transcript",roles:["livechat-manager","admin"]},{_id:"mail-messages",roles:["admin"]},{_id:"toggle-room-e2e-encryption",roles:["owner"]},{_id:"message-impersonate",roles:["bot","app"]},{_id:"create-team",roles:["admin","user"]},{_id:"delete-team",roles:["admin","owner"]},{_id:"convert-team",roles:["admin","owner"]},{_id:"edit-team",roles:["admin","owner"]},{_id:"add-team-member",roles:["admin","owner","moderator"]},{_id:"edit-team-member",roles:["admin","owner","moderator"]},{_id:"add-team-channel",roles:["admin","owner","moderator"]},{_id:"edit-team-channel",roles:["admin","owner","moderator"]},{_id:"remove-team-channel",roles:["admin","owner","moderator"]},{_id:"view-all-team-channels",roles:["admin","owner"]},{_id:"view-all-teams",roles:["admin"]},{_id:"remove-closed-livechat-room",roles:["livechat-manager","admin"]},{_id:"remove-livechat-department",roles:["livechat-manager","admin"]}];for(const s of e){Permissions.create(s._id,s.roles)}const i=[{name:"admin",scope:"Users",description:"Admin"},{name:"moderator",scope:"Subscriptions",description:"Moderator"},{name:"leader",scope:"Subscriptions",description:"Leader"},{name:"owner",scope:"Subscriptions",description:"Owner"},{name:"user",scope:"Users",description:""},{name:"bot",scope:"Users",description:""},{name:"app",scope:"Users",description:""},{name:"guest",scope:"Users",description:""},{name:"anonymous",scope:"Users",description:""},{name:"livechat-agent",scope:"Users",description:"Livechat Agent"},{name:"livechat-manager",scope:"Users",description:"Livechat Manager"}];for(const t of i){Roles.createOrUpdate(t.name,t.scope,t.description,true,false)}const a=function(e){const i={};const o={level:CONSTANTS.SETTINGS_LEVEL};if(e){o.settingId=e}Permissions.find(o).fetch().forEach(function(e){i[e._id]=e});return i};const r=function(e,i){const o=getSettingPermissionId(e._id);const a={level:CONSTANTS.SETTINGS_LEVEL,settingId:e._id,group:e.group,section:e.section,sorter:e.sorter,roles:[]};if(i[o]&&i[o].roles){a.roles=i[o].roles}if(e.group){a.groupPermissionId=getSettingPermissionId(e.group)}if(e.section){a.sectionPermissionId=getSettingPermissionId(e.section)}const r=Permissions.findOne({_id:o,...a},{fields:{_id:1}});if(!r){try{Permissions.upsert({_id:o},{$set:a})}catch(e){if(!e.message.includes("E11000")){Permissions.upsert({_id:o},{$set:a})}}}delete i[o]};const o=function(){const i=a();Settings.findNotHidden().fetch().forEach(e=>{r(e,i)});for(const e in i){if(i.hasOwnProperty(e)){Permissions.remove({_id:e})}}};o();const n=function(e){const i=a(e);const o=Settings.findOneById(e);if(o){if(!o.hidden){r(o,i)}}};settings.onload("*",n)});