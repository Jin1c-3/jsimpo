"use strict";require("../common");const assert=require("assert");const http=require("http");let serverSocket=null;const server=http.createServer(function(e,t){if(serverSocket){assert.strictEqual(e.socket,serverSocket)}else{serverSocket=e.socket}t.end(e.url)});server.listen(0,function(){makeRequest(expectRequests)});const agent=http.Agent({keepAlive:true});let clientSocket=null;const expectRequests=10;let actualRequests=0;function makeRequest(s){if(s===0){server.close();agent.destroy();return}const e=http.request({port:server.address().port,agent:agent,path:`/${s}`});e.end();e.on("socket",function(e){if(clientSocket){assert.strictEqual(e,clientSocket)}else{clientSocket=e}});e.on("response",function(e){let t="";e.setEncoding("utf8");e.on("data",function(e){t+=e});e.on("end",function(){assert.strictEqual(t,`/${s}`);setTimeout(function(){actualRequests++;makeRequest(s-1)},1)})})}process.on("exit",function(){assert.strictEqual(actualRequests,expectRequests);console.log("ok")});