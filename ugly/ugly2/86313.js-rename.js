var AddToDOM=require("../../dom/AddToDOM");var CanvasPool=require("../../display/canvas/CanvasPool");var Class=require("../../utils/Class");var Components=require("../components");var GameEvents=require("../../core/events");var GameObject=require("../GameObject");var GetTextSize=require("./GetTextSize");var GetValue=require("../../utils/object/GetValue");var RemoveFromDOM=require("../../dom/RemoveFromDOM");var TextRender=require("./TextRender");var TextStyle=require("./TextStyle");var Text=new Class({Extends:GameObject,Mixins:[Components.Alpha,Components.BlendMode,Components.ComputedSize,Components.Crop,Components.Depth,Components.Flip,Components.GetBounds,Components.Mask,Components.Origin,Components.Pipeline,Components.ScrollFactor,Components.Tint,Components.Transform,Components.Visible,TextRender],initialize:function t(e,i,s,r,n){if(i===undefined){i=0}if(s===undefined){s=0}GameObject.call(this,e,"Text");this.renderer=e.sys.renderer;this.setPosition(i,s);this.setOrigin(0,0);this.initPipeline();this.canvas=CanvasPool.create(this);this.context=this.canvas.getContext("2d");this.style=new TextStyle(this,n);this.autoRound=true;this.splitRegExp=/(?:\r\n|\r|\n)/;this._text=undefined;this.padding={left:0,right:0,top:0,bottom:0};this.width=1;this.height=1;this.lineSpacing=0;this.dirty=false;if(this.style.resolution===0){this.style.resolution=1}this._crop=this.resetCropObject();this.texture=e.sys.textures.addCanvas(null,this.canvas,true);this.frame=this.texture.get();this.frame.source.resolution=this.style.resolution;if(this.renderer&&this.renderer.gl){this.renderer.deleteTexture(this.frame.source.glTexture);this.frame.source.glTexture=null}this.initRTL();this.setText(r);if(n&&n.padding){this.setPadding(n.padding)}if(n&&n.lineSpacing){this.setLineSpacing(n.lineSpacing)}e.sys.game.events.on(GameEvents.CONTEXT_RESTORED,function(){this.dirty=true},this)},initRTL:function(){if(!this.style.rtl){return}this.canvas.dir="rtl";this.context.direction="rtl";this.canvas.style.display="none";AddToDOM(this.canvas,this.scene.sys.canvas);this.originX=1},runWordWrap:function(t){var e=this.style;if(e.wordWrapCallback){var i=e.wordWrapCallback.call(e.wordWrapCallbackScope,t,this);if(Array.isArray(i)){i=i.join("\n")}return i}else if(e.wordWrapWidth){if(e.wordWrapUseAdvanced){return this.advancedWordWrap(t,this.context,this.style.wordWrapWidth)}else{return this.basicWordWrap(t,this.context,this.style.wordWrapWidth)}}else{return t}},advancedWordWrap:function(t,e,i){var s="";var r=t.replace(/ +/gi," ").split(this.splitRegExp);var n=r.length;for(var a=0;a<n;a++){var o=r[a];var h="";o=o.replace(/^ *|\s*$/gi,"");var l=e.measureText(o).width;if(l<i){s+=o+"\n";continue}var d=i;var u=o.split(" ");for(var c=0;c<u.length;c++){var f=u[c];var p=f+" ";var v=e.measureText(p).width;if(v>d){if(c===0){var g=p;while(g.length){g=g.slice(0,-1);v=e.measureText(g).width;if(v<=d){break}}if(!g.length){throw new Error("This text's wordWrapWidth setting is less than a single character!")}var x=f.substr(g.length);u[c]=x;h+=g}var y=u[c].length?c:c+1;var m=u.slice(y).join(" ").replace(/[ \n]*$/gi,"");r[a+1]=m+" "+(r[a+1]||"");n=r.length;break}else{h+=p;d-=v}}s+=h.replace(/[ \n]*$/gi,"")+"\n"}s=s.replace(/[\s|\n]*$/gi,"");return s},basicWordWrap:function(t,e,i){var s="";var r=t.split(this.splitRegExp);var n=r.length-1;var a=e.measureText(" ").width;for(var o=0;o<=n;o++){var h=i;var l=r[o].split(" ");var d=l.length-1;for(var u=0;u<=d;u++){var c=l[u];var f=e.measureText(c).width;var p=f;if(u<d){p+=a}if(p>h){if(u>0){s+="\n";h=i}}s+=c;if(u<d){s+=" ";h-=p}else{h-=f}}if(o<n){s+="\n"}}return s},getWrappedText:function(t){if(t===undefined){t=this._text}this.style.syncFont(this.canvas,this.context);var e=this.runWordWrap(t);return e.split(this.splitRegExp)},setText:function(t){if(!t&&t!==0){t=""}if(Array.isArray(t)){t=t.join("\n")}if(t!==this._text){this._text=t.toString();this.updateText()}return this},setStyle:function(t){return this.style.setStyle(t)},setFont:function(t){return this.style.setFont(t)},setFontFamily:function(t){return this.style.setFontFamily(t)},setFontSize:function(t){return this.style.setFontSize(t)},setFontStyle:function(t){return this.style.setFontStyle(t)},setFixedSize:function(t,e){return this.style.setFixedSize(t,e)},setBackgroundColor:function(t){return this.style.setBackgroundColor(t)},setFill:function(t){return this.style.setFill(t)},setColor:function(t){return this.style.setColor(t)},setStroke:function(t,e){return this.style.setStroke(t,e)},setShadow:function(t,e,i,s,r,n){return this.style.setShadow(t,e,i,s,r,n)},setShadowOffset:function(t,e){return this.style.setShadowOffset(t,e)},setShadowColor:function(t){return this.style.setShadowColor(t)},setShadowBlur:function(t){return this.style.setShadowBlur(t)},setShadowStroke:function(t){return this.style.setShadowStroke(t)},setShadowFill:function(t){return this.style.setShadowFill(t)},setWordWrapWidth:function(t,e){return this.style.setWordWrapWidth(t,e)},setWordWrapCallback:function(t,e){return this.style.setWordWrapCallback(t,e)},setAlign:function(t){return this.style.setAlign(t)},setResolution:function(t){return this.style.setResolution(t)},setLineSpacing:function(t){this.lineSpacing=t;return this.updateText()},setPadding:function(t,e,i,s){if(typeof t==="object"){var r=t;var n=GetValue(r,"x",null);if(n!==null){t=n;i=n}else{t=GetValue(r,"left",0);i=GetValue(r,"right",t)}var a=GetValue(r,"y",null);if(a!==null){e=a;s=a}else{e=GetValue(r,"top",0);s=GetValue(r,"bottom",e)}}else{if(t===undefined){t=0}if(e===undefined){e=t}if(i===undefined){i=t}if(s===undefined){s=e}}this.padding.left=t;this.padding.top=e;this.padding.right=i;this.padding.bottom=s;return this.updateText()},setMaxLines:function(t){return this.style.setMaxLines(t)},updateText:function(){var t=this.canvas;var e=this.context;var i=this.style;var s=i.resolution;var r=i.metrics;i.syncFont(t,e);var n=this._text;if(i.wordWrapWidth||i.wordWrapCallback){n=this.runWordWrap(this._text)}var a=n.split(this.splitRegExp);var o=GetTextSize(this,r,a);var h=this.padding;var l;if(i.fixedWidth===0){this.width=o.width+h.left+h.right;l=o.width}else{this.width=i.fixedWidth;l=this.width-h.left-h.right;if(l<o.width){l=o.width}}if(i.fixedHeight===0){this.height=o.height+h.top+h.bottom}else{this.height=i.fixedHeight}var d=this.width;var u=this.height;this.updateDisplayOrigin();d*=s;u*=s;d=Math.max(d,1);u=Math.max(u,1);if(t.width!==d||t.height!==u){t.width=d;t.height=u;this.frame.setSize(d,u);i.syncFont(t,e)}else{e.clearRect(0,0,d,u)}e.save();e.scale(s,s);if(i.backgroundColor){e.fillStyle=i.backgroundColor;e.fillRect(0,0,d,u)}i.syncStyle(t,e);e.textBaseline="alphabetic";e.translate(h.left,h.top);var c;var f;for(var p=0;p<o.lines;p++){c=i.strokeThickness/2;f=i.strokeThickness/2+p*o.lineHeight+r.ascent;if(p>0){f+=o.lineSpacing*p}if(i.rtl){c=d-c}else if(i.align==="right"){c+=l-o.lineWidths[p]}else if(i.align==="center"){c+=(l-o.lineWidths[p])/2}else if(i.align==="justify"){var v=.85;if(o.lineWidths[p]/o.width>=v){var g=o.width-o.lineWidths[p];var x=e.measureText(" ").width;var y=a[p].trim();var m=y.split(" ");g+=(a[p].length-y.length)*x;var T=Math.floor(g/x);var w=0;while(T>0){m[w]+=" ";w=(w+1)%(m.length-1||1);--T}a[p]=m.join(" ")}}if(this.autoRound){c=Math.round(c);f=Math.round(f)}if(i.strokeThickness){this.style.syncShadow(e,i.shadowStroke);e.strokeText(a[p],c,f)}if(i.color){this.style.syncShadow(e,i.shadowFill);e.fillText(a[p],c,f)}}e.restore();if(this.renderer&&this.renderer.gl){this.frame.source.glTexture=this.renderer.canvasToTexture(t,this.frame.source.glTexture,true);this.frame.glTexture=this.frame.source.glTexture}this.dirty=true;var S=this.input;if(S&&!S.customHitArea){S.hitArea.width=this.width;S.hitArea.height=this.height}return this},getTextMetrics:function(){return this.style.getTextMetrics()},text:{get:function(){return this._text},set:function(t){this.setText(t)}},toJSON:function(){var t=Components.ToJSON(this);var e={autoRound:this.autoRound,text:this._text,style:this.style.toJSON(),padding:{left:this.padding.left,right:this.padding.right,top:this.padding.top,bottom:this.padding.bottom}};t.data=e;return t},preDestroy:function(){if(this.style.rtl){RemoveFromDOM(this.canvas)}CanvasPool.remove(this.canvas);this.texture.destroy()}});module.exports=Text;