var AngleBetweenPoints=require("../../math/angle/BetweenPoints");var Body=require("./Body");var Clamp=require("../../math/Clamp");var Class=require("../../utils/Class");var Collider=require("./Collider");var CONST=require("./const");var DistanceBetween=require("../../math/distance/DistanceBetween");var EventEmitter=require("eventemitter3");var Events=require("./events");var FuzzyEqual=require("../../math/fuzzy/Equal");var FuzzyGreaterThan=require("../../math/fuzzy/GreaterThan");var FuzzyLessThan=require("../../math/fuzzy/LessThan");var GetOverlapX=require("./GetOverlapX");var GetOverlapY=require("./GetOverlapY");var GetTilesWithinWorldXY=require("../../tilemaps/components/GetTilesWithinWorldXY");var GetValue=require("../../utils/object/GetValue");var MATH_CONST=require("../../math/const");var ProcessQueue=require("../../structs/ProcessQueue");var ProcessTileCallbacks=require("./tilemap/ProcessTileCallbacks");var Rectangle=require("../../geom/rectangle/Rectangle");var RTree=require("../../structs/RTree");var SeparateTile=require("./tilemap/SeparateTile");var SeparateX=require("./SeparateX");var SeparateY=require("./SeparateY");var Set=require("../../structs/Set");var StaticBody=require("./StaticBody");var TileIntersectsBody=require("./tilemap/TileIntersectsBody");var TransformMatrix=require("../../gameobjects/components/TransformMatrix");var Vector2=require("../../math/Vector2");var Wrap=require("../../math/Wrap");var World=new Class({Extends:EventEmitter,initialize:function e(i,t){EventEmitter.call(this);this.scene=i;this.bodies=new Set;this.staticBodies=new Set;this.pendingDestroy=new Set;this.colliders=new ProcessQueue;this.gravity=new Vector2(GetValue(t,"gravity.x",0),GetValue(t,"gravity.y",0));this.bounds=new Rectangle(GetValue(t,"x",0),GetValue(t,"y",0),GetValue(t,"width",i.sys.scale.width),GetValue(t,"height",i.sys.scale.height));this.checkCollision={up:GetValue(t,"checkCollision.up",true),down:GetValue(t,"checkCollision.down",true),left:GetValue(t,"checkCollision.left",true),right:GetValue(t,"checkCollision.right",true)};this.fps=GetValue(t,"fps",60);this.fixedStep=GetValue(t,"fixedStep",true);this._elapsed=0;this._frameTime=1/this.fps;this._frameTimeMS=1e3*this._frameTime;this.stepsLastFrame=0;this.timeScale=GetValue(t,"timeScale",1);this.OVERLAP_BIAS=GetValue(t,"overlapBias",4);this.TILE_BIAS=GetValue(t,"tileBias",16);this.forceX=GetValue(t,"forceX",false);this.isPaused=GetValue(t,"isPaused",false);this._total=0;this.drawDebug=GetValue(t,"debug",false);this.debugGraphic;this.defaults={debugShowBody:GetValue(t,"debugShowBody",true),debugShowStaticBody:GetValue(t,"debugShowStaticBody",true),debugShowVelocity:GetValue(t,"debugShowVelocity",true),bodyDebugColor:GetValue(t,"debugBodyColor",16711935),staticBodyDebugColor:GetValue(t,"debugStaticBodyColor",255),velocityDebugColor:GetValue(t,"debugVelocityColor",65280)};this.maxEntries=GetValue(t,"maxEntries",16);this.useTree=GetValue(t,"useTree",true);this.tree=new RTree(this.maxEntries);this.staticTree=new RTree(this.maxEntries);this.treeMinMax={minX:0,minY:0,maxX:0,maxY:0};this._tempMatrix=new TransformMatrix;this._tempMatrix2=new TransformMatrix;if(this.drawDebug){this.createDebugGraphic()}},enable:function(e,i){if(i===undefined){i=CONST.DYNAMIC_BODY}if(!Array.isArray(e)){e=[e]}for(var t=0;t<e.length;t++){var r=e[t];if(r.isParent){var s=r.getChildren();for(var a=0;a<s.length;a++){var l=s[a];if(l.isParent){this.enable(l,i)}else{this.enableBody(l,i)}}}else{this.enableBody(r,i)}}},enableBody:function(e,i){if(i===undefined){i=CONST.DYNAMIC_BODY}if(!e.body){if(i===CONST.DYNAMIC_BODY){e.body=new Body(this,e)}else if(i===CONST.STATIC_BODY){e.body=new StaticBody(this,e)}}this.add(e.body);return e},add:function(e){if(e.physicsType===CONST.DYNAMIC_BODY){this.bodies.set(e)}else if(e.physicsType===CONST.STATIC_BODY){this.staticBodies.set(e);this.staticTree.insert(e)}e.enable=true;return e},disable:function(e){if(!Array.isArray(e)){e=[e]}for(var i=0;i<e.length;i++){var t=e[i];if(t.isParent){var r=t.getChildren();for(var s=0;s<r.length;s++){var a=r[s];if(a.isParent){this.disable(a)}else{this.disableBody(a.body)}}}else{this.disableBody(t.body)}}},disableBody:function(e){this.remove(e);e.enable=false},remove:function(e){if(e.physicsType===CONST.DYNAMIC_BODY){this.tree.remove(e);this.bodies.delete(e)}else if(e.physicsType===CONST.STATIC_BODY){this.staticBodies.delete(e);this.staticTree.remove(e)}},createDebugGraphic:function(){var e=this.scene.sys.add.graphics({x:0,y:0});e.setDepth(Number.MAX_VALUE);this.debugGraphic=e;this.drawDebug=true;return e},setBounds:function(e,i,t,r,s,a,l,n){this.bounds.setTo(e,i,t,r);if(s!==undefined){this.setBoundsCollision(s,a,l,n)}return this},setBoundsCollision:function(e,i,t,r){if(e===undefined){e=true}if(i===undefined){i=true}if(t===undefined){t=true}if(r===undefined){r=true}this.checkCollision.left=e;this.checkCollision.right=i;this.checkCollision.up=t;this.checkCollision.down=r;return this},pause:function(){this.isPaused=true;this.emit(Events.PAUSE);return this},resume:function(){this.isPaused=false;this.emit(Events.RESUME);return this},addCollider:function(e,i,t,r,s){if(t===undefined){t=null}if(r===undefined){r=null}if(s===undefined){s=t}var a=new Collider(this,false,e,i,t,r,s);this.colliders.add(a);return a},addOverlap:function(e,i,t,r,s){if(t===undefined){t=null}if(r===undefined){r=null}if(s===undefined){s=t}var a=new Collider(this,true,e,i,t,r,s);this.colliders.add(a);return a},removeCollider:function(e){this.colliders.remove(e);return this},setFPS:function(e){this.fps=e;this._frameTime=1/this.fps;this._frameTimeMS=1e3*this._frameTime;return this},update:function(e,i){if(this.isPaused||this.bodies.size===0){return}var t;var r=this._frameTime;var s=this._frameTimeMS*this.timeScale;this._elapsed+=i;var a;var l=this.bodies.entries;var n=this._elapsed>=s;if(!this.fixedStep){r=i*.001;n=true;this._elapsed=0}for(t=0;t<l.length;t++){a=l[t];if(a.enable){a.preUpdate(n,r)}}if(n){this._elapsed-=s;this.stepsLastFrame=1;if(this.useTree){this.tree.clear();this.tree.load(l)}var o=this.colliders.update();for(t=0;t<o.length;t++){var h=o[t];if(h.active){h.update()}}this.emit(Events.WORLD_STEP,r)}while(this._elapsed>=s){this._elapsed-=s;this.step(r)}},step:function(e){var i;var t;var r=this.bodies.entries;var s=r.length;for(i=0;i<s;i++){t=r[i];if(t.enable){t.update(e)}}if(this.useTree){this.tree.clear();this.tree.load(r)}var a=this.colliders.update();for(i=0;i<a.length;i++){var l=a[i];if(l.active){l.update()}}this.emit(Events.WORLD_STEP,e);this.stepsLastFrame++},postUpdate:function(){var e;var i;var t=this.bodies.entries;var r=t.length;var s=this.bodies;var a=this.staticBodies;if(this.stepsLastFrame){this.stepsLastFrame=0;for(e=0;e<r;e++){i=t[e];if(i.enable){i.postUpdate()}}}if(this.drawDebug){var l=this.debugGraphic;l.clear();for(e=0;e<r;e++){i=t[e];if(i.willDrawDebug()){i.drawDebug(l)}}t=a.entries;r=t.length;for(e=0;e<r;e++){i=t[e];if(i.willDrawDebug()){i.drawDebug(l)}}}var n=this.pendingDestroy;if(n.size>0){var o=this.tree;var h=this.staticTree;t=n.entries;r=t.length;for(e=0;e<r;e++){i=t[e];if(i.physicsType===CONST.DYNAMIC_BODY){o.remove(i);s.delete(i)}else if(i.physicsType===CONST.STATIC_BODY){h.remove(i);a.delete(i)}i.world=undefined;i.gameObject=undefined}n.clear()}},updateMotion:function(e,i){if(e.allowRotation){this.computeAngularVelocity(e,i)}this.computeVelocity(e,i)},computeAngularVelocity:function(e,i){var t=e.angularVelocity;var r=e.angularAcceleration;var s=e.angularDrag;var a=e.maxAngular;if(r){t+=r*i}else if(e.allowDrag&&s){s*=i;if(FuzzyGreaterThan(t-s,0,.1)){t-=s}else if(FuzzyLessThan(t+s,0,.1)){t+=s}else{t=0}}t=Clamp(t,-a,a);var l=t-e.angularVelocity;e.angularVelocity+=l;e.rotation+=e.angularVelocity*i},computeVelocity:function(e,i){var t=e.velocity.x;var r=e.acceleration.x;var s=e.drag.x;var a=e.maxVelocity.x;var l=e.velocity.y;var n=e.acceleration.y;var o=e.drag.y;var h=e.maxVelocity.y;var c=e.speed;var u=e.maxSpeed;var f=e.allowDrag;var d=e.useDamping;if(e.allowGravity){t+=(this.gravity.x+e.gravity.x)*i;l+=(this.gravity.y+e.gravity.y)*i}if(r){t+=r*i}else if(f&&s){if(d){s=Math.pow(s,i);t*=s;c=Math.sqrt(t*t+l*l);if(FuzzyEqual(c,0,.001)){t=0}}else{s*=i;if(FuzzyGreaterThan(t-s,0,.01)){t-=s}else if(FuzzyLessThan(t+s,0,.01)){t+=s}else{t=0}}}if(n){l+=n*i}else if(f&&o){if(d){o=Math.pow(o,i);l*=o;c=Math.sqrt(t*t+l*l);if(FuzzyEqual(c,0,.001)){l=0}}else{o*=i;if(FuzzyGreaterThan(l-o,0,.01)){l-=o}else if(FuzzyLessThan(l+o,0,.01)){l+=o}else{l=0}}}t=Clamp(t,-a,a);l=Clamp(l,-h,h);e.velocity.set(t,l);if(u>-1&&c>u){e.velocity.normalize().scale(u);c=u}e.speed=c},separate:function(e,i,t,r,s,a){if(!a&&!e.enable||!i.enable||e.checkCollision.none||i.checkCollision.none||!this.intersects(e,i)){return false}if(t&&t.call(r,e.gameObject,i.gameObject)===false){return false}if(e.isCircle&&i.isCircle){return this.separateCircle(e,i,s)}if(e.isCircle!==i.isCircle){var l=e.isCircle?i:e;var n=e.isCircle?e:i;var o={x:l.x,y:l.y,right:l.right,bottom:l.bottom};var h=n.center;if(h.y<o.y||h.y>o.bottom){if(h.x<o.x||h.x>o.right){return this.separateCircle(e,i,s)}}}var c=false;var u=false;if(s){c=SeparateX(e,i,s,this.OVERLAP_BIAS);u=SeparateY(e,i,s,this.OVERLAP_BIAS)}else if(this.forceX||Math.abs(this.gravity.y+e.gravity.y)<Math.abs(this.gravity.x+e.gravity.x)){c=SeparateX(e,i,s,this.OVERLAP_BIAS);if(this.intersects(e,i)){u=SeparateY(e,i,s,this.OVERLAP_BIAS)}}else{u=SeparateY(e,i,s,this.OVERLAP_BIAS);if(this.intersects(e,i)){c=SeparateX(e,i,s,this.OVERLAP_BIAS)}}var f=c||u;if(f){if(s){if(e.onOverlap||i.onOverlap){this.emit(Events.OVERLAP,e.gameObject,i.gameObject,e,i)}}else if(e.onCollide||i.onCollide){this.emit(Events.COLLIDE,e.gameObject,i.gameObject,e,i)}}return f},separateCircle:function(e,i,t,r){GetOverlapX(e,i,false,r);GetOverlapY(e,i,false,r);var s=0;if(e.isCircle!==i.isCircle){var a={x:i.isCircle?e.position.x:i.position.x,y:i.isCircle?e.position.y:i.position.y,right:i.isCircle?e.right:i.right,bottom:i.isCircle?e.bottom:i.bottom};var l={x:e.isCircle?e.center.x:i.center.x,y:e.isCircle?e.center.y:i.center.y,radius:e.isCircle?e.halfWidth:i.halfWidth};if(l.y<a.y){if(l.x<a.x){s=DistanceBetween(l.x,l.y,a.x,a.y)-l.radius}else if(l.x>a.right){s=DistanceBetween(l.x,l.y,a.right,a.y)-l.radius}}else if(l.y>a.bottom){if(l.x<a.x){s=DistanceBetween(l.x,l.y,a.x,a.bottom)-l.radius}else if(l.x>a.right){s=DistanceBetween(l.x,l.y,a.right,a.bottom)-l.radius}}s*=-1}else{s=e.halfWidth+i.halfWidth-DistanceBetween(e.center.x,e.center.y,i.center.x,i.center.y)}e.overlapR=s;i.overlapR=s;if(t||s===0||e.immovable&&i.immovable||e.customSeparateX||i.customSeparateX){if(s!==0&&(e.onOverlap||i.onOverlap)){this.emit(Events.OVERLAP,e.gameObject,i.gameObject,e,i)}return s!==0}var n=e.center.x-i.center.x;var o=e.center.y-i.center.y;var h=Math.sqrt(Math.pow(n,2)+Math.pow(o,2));var c=(i.center.x-e.center.x)/h||0;var u=(i.center.y-e.center.y)/h||0;var f=2*(e.velocity.x*c+e.velocity.y*u-i.velocity.x*c-i.velocity.y*u)/(e.mass+i.mass);if(e.immovable||i.immovable){f*=2}if(!e.immovable){e.velocity.x=e.velocity.x-f/e.mass*c;e.velocity.y=e.velocity.y-f/e.mass*u}if(!i.immovable){i.velocity.x=i.velocity.x+f/i.mass*c;i.velocity.y=i.velocity.y+f/i.mass*u}if(!e.immovable&&!i.immovable){s/=2}var d=AngleBetweenPoints(e.center,i.center);var v=(s+MATH_CONST.EPSILON)*Math.cos(d);var y=(s+MATH_CONST.EPSILON)*Math.sin(d);if(!e.immovable){e.x-=v;e.y-=y;e.updateCenter()}if(!i.immovable){i.x+=v;i.y+=y;i.updateCenter()}e.velocity.x*=e.bounce.x;e.velocity.y*=e.bounce.y;i.velocity.x*=i.bounce.x;i.velocity.y*=i.bounce.y;if(e.onCollide||i.onCollide){this.emit(Events.COLLIDE,e.gameObject,i.gameObject,e,i)}return true},intersects:function(e,i){if(e===i){return false}if(!e.isCircle&&!i.isCircle){return!(e.right<=i.position.x||e.bottom<=i.position.y||e.position.x>=i.right||e.position.y>=i.bottom)}else if(e.isCircle){if(i.isCircle){return DistanceBetween(e.center.x,e.center.y,i.center.x,i.center.y)<=e.halfWidth+i.halfWidth}else{return this.circleBodyIntersects(e,i)}}else{return this.circleBodyIntersects(i,e)}},circleBodyIntersects:function(e,i){var t=Clamp(e.center.x,i.left,i.right);var r=Clamp(e.center.y,i.top,i.bottom);var s=(e.center.x-t)*(e.center.x-t);var a=(e.center.y-r)*(e.center.y-r);return s+a<=e.halfWidth*e.halfWidth},overlap:function(e,i,t,r,s){if(t===undefined){t=null}if(r===undefined){r=null}if(s===undefined){s=t}return this.collideObjects(e,i,t,r,s,true)},collide:function(e,i,t,r,s){if(t===undefined){t=null}if(r===undefined){r=null}if(s===undefined){s=t}return this.collideObjects(e,i,t,r,s,false)},collideObjects:function(e,i,t,r,s,a){var l;var n;if(e.isParent&&e.physicsType===undefined){e=e.children.entries}if(i&&i.isParent&&i.physicsType===undefined){i=i.children.entries}var o=Array.isArray(e);var h=Array.isArray(i);this._total=0;if(!o&&!h){this.collideHandler(e,i,t,r,s,a)}else if(!o&&h){for(l=0;l<i.length;l++){this.collideHandler(e,i[l],t,r,s,a)}}else if(o&&!h){if(!i){for(l=0;l<e.length;l++){var c=e[l];for(n=l+1;n<e.length;n++){if(l===n){continue}this.collideHandler(c,e[n],t,r,s,a)}}}else{for(l=0;l<e.length;l++){this.collideHandler(e[l],i,t,r,s,a)}}}else{for(l=0;l<e.length;l++){for(n=0;n<i.length;n++){this.collideHandler(e[l],i[n],t,r,s,a)}}}return this._total>0},collideHandler:function(e,i,t,r,s,a){if(i===undefined&&e.isParent){return this.collideGroupVsGroup(e,e,t,r,s,a)}if(!e||!i){return false}if(e.body){if(i.body){return this.collideSpriteVsSprite(e,i,t,r,s,a)}else if(i.isParent){return this.collideSpriteVsGroup(e,i,t,r,s,a)}else if(i.isTilemap){return this.collideSpriteVsTilemapLayer(e,i,t,r,s,a)}}else if(e.isParent){if(i.body){return this.collideSpriteVsGroup(i,e,t,r,s,a)}else if(i.isParent){return this.collideGroupVsGroup(e,i,t,r,s,a)}else if(i.isTilemap){return this.collideGroupVsTilemapLayer(e,i,t,r,s,a)}}else if(e.isTilemap){if(i.body){return this.collideSpriteVsTilemapLayer(i,e,t,r,s,a)}else if(i.isParent){return this.collideGroupVsTilemapLayer(i,e,t,r,s,a)}}},collideSpriteVsSprite:function(e,i,t,r,s,a){if(!e.body||!i.body){return false}if(this.separate(e.body,i.body,r,s,a)){if(t){t.call(s,e,i)}this._total++}return true},collideSpriteVsGroup:function(e,i,t,r,s,a){var l=e.body;if(i.length===0||!l||!l.enable||l.checkCollision.none){return}var n;var o;var h;if(this.useTree||i.physicsType===CONST.STATIC_BODY){var c=this.treeMinMax;c.minX=l.left;c.minY=l.top;c.maxX=l.right;c.maxY=l.bottom;var u=i.physicsType===CONST.DYNAMIC_BODY?this.tree.search(c):this.staticTree.search(c);o=u.length;for(n=0;n<o;n++){h=u[n];if(l===h||!h.enable||h.checkCollision.none||!i.contains(h.gameObject)){continue}if(this.separate(l,h,r,s,a,true)){if(t){t.call(s,l.gameObject,h.gameObject)}this._total++}}}else{var f=i.getChildren();var d=i.children.entries.indexOf(e);o=f.length;for(n=0;n<o;n++){h=f[n].body;if(!h||n===d||!h.enable){continue}if(this.separate(l,h,r,s,a)){if(t){t.call(s,l.gameObject,h.gameObject)}this._total++}}}},collideGroupVsTilemapLayer:function(e,i,t,r,s,a){var l=e.getChildren();if(l.length===0){return false}var n=false;for(var o=0;o<l.length;o++){if(l[o].body){if(this.collideSpriteVsTilemapLayer(l[o],i,t,r,s,a)){n=true}}}return n},collideTiles:function(e,i,t,r,s){if(!e.body.enable||i.length===0){return false}else{return this.collideSpriteVsTilesHandler(e,i,t,r,s,false,false)}},overlapTiles:function(e,i,t,r,s){if(!e.body.enable||i.length===0){return false}else{return this.collideSpriteVsTilesHandler(e,i,t,r,s,true,false)}},collideSpriteVsTilemapLayer:function(e,i,t,r,s,a){var l=e.body;if(!l.enable||l.checkCollision.none){return false}var n=l.position.x;var o=l.position.y;var h=l.width;var c=l.height;var u=i.layer;if(u.tileWidth>u.baseTileWidth){var f=(u.tileWidth-u.baseTileWidth)*i.scaleX;n-=f;h+=f}if(u.tileHeight>u.baseTileHeight){var d=(u.tileHeight-u.baseTileHeight)*i.scaleY;c+=d}var v=GetTilesWithinWorldXY(n,o,h,c,null,i.scene.cameras.main,i.layer);if(v.length===0){return false}else{return this.collideSpriteVsTilesHandler(e,v,t,r,s,a,true)}},collideSpriteVsTilesHandler:function(e,i,t,r,s,a,l){var n=e.body;var o;var h={left:0,right:0,top:0,bottom:0};var c;var u=false;for(var f=0;f<i.length;f++){o=i[f];c=o.tilemapLayer;var d=c.tileToWorldXY(o.x,o.y);h.left=d.x;h.top=d.y;if(o.baseHeight!==o.height){h.top-=(o.height-o.baseHeight)*c.scaleY}h.right=h.left+o.width*c.scaleX;h.bottom=h.top+o.height*c.scaleY;if(TileIntersectsBody(h,n)&&(!r||r.call(s,e,o))&&ProcessTileCallbacks(o,e)&&(a||SeparateTile(f,n,o,h,c,this.TILE_BIAS,l))){this._total++;u=true;if(t){t.call(s,e,o)}if(a&&n.onOverlap){this.emit(Events.TILE_OVERLAP,e,o,n)}else if(n.onCollide){this.emit(Events.TILE_COLLIDE,e,o,n)}}}return u},collideGroupVsGroup:function(e,i,t,r,s,a){if(e.length===0||i.length===0){return}var l=e.getChildren();for(var n=0;n<l.length;n++){this.collideSpriteVsGroup(l[n],i,t,r,s,a)}},wrap:function(e,i){if(e.body){this.wrapObject(e,i)}else if(e.getChildren){this.wrapArray(e.getChildren(),i)}else if(Array.isArray(e)){this.wrapArray(e,i)}else{this.wrapObject(e,i)}},wrapArray:function(e,i){for(var t=0;t<e.length;t++){this.wrapObject(e[t],i)}},wrapObject:function(e,i){if(i===undefined){i=0}e.x=Wrap(e.x,this.bounds.left-i,this.bounds.right+i);e.y=Wrap(e.y,this.bounds.top-i,this.bounds.bottom+i)},shutdown:function(){this.tree.clear();this.staticTree.clear();this.bodies.clear();this.staticBodies.clear();this.colliders.destroy();this.removeAllListeners()},destroy:function(){this.shutdown();this.scene=null}});module.exports=World;