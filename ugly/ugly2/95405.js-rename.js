define(function(e,r,n){"use strict";var t=e("utils/AppInit"),u=e("command/CommandManager"),a=e("view/MainViewManager"),f=e("language/LanguageManager"),c=e("document/DocumentManager"),g=e("command/Commands"),l=e("editor/EditorManager"),i=e("project/ProjectManager"),o=e("features/PriorityBasedRegistration").RegistrationHandler,s=e("search/SearchResultsView").SearchResultsView,d=e("search/SearchModel").SearchModel,E=e("strings");var R=new o,v=R.registerProvider.bind(R),h=R.removeProvider.bind(R);var F=new d,m;function L(e,r,n){var t=new $.Deferred;if(!e){return t.reject()}e.getReferences(r,n).done(function(e){F.results=e.results;F.numFiles=e.numFiles;F.numMatches=e.numMatches;F.allResultsAvailable=true;F.setQueryInfo({query:e.queryInfo,caseSensitive:true,isRegExp:false});t.resolve()}).fail(function(){t.reject()});return t.promise()}function P(){var n=l.getActiveEditor(),e=n?n.getCursorPos():null,r,t=new $.Deferred,a=E.REFERENCES_NO_RESULTS,i;var o=n.getLanguageForSelection(),s=R.getProvidersForLanguageId(o.getId());s.some(function(e,r){if(e.provider.hasReferences(n)){i=e.provider;return true}});r=L(i,n,e);if(r){r.done(function(){if(m){m.open()}}).fail(function(){if(m){m.close()}n.displayErrorMessageAtCursor(a);t.reject()})}else{if(m){m.close()}n.displayErrorMessageAtCursor(a);t.reject()}return t.promise()}function C(){F.clear()}function _(){if(m){m.close()}}function M(e){u.get(g.CMD_FIND_ALL_REFERENCES).setEnabled(false);if(!e){var r=l.getActiveEditor();if(r){e=f.getLanguageForPath(r.document.file._path).getId()}}var n=R.getProvidersForLanguageId(e),t;n.some(function(e,r){if(e.provider.hasReferences()){t=e.provider;return true}});if(t){u.get(g.CMD_FIND_ALL_REFERENCES).setEnabled(true)}}a.on("currentFileChange",function(e,r,n,t,a){if(!r){u.get(g.CMD_FIND_ALL_REFERENCES).setEnabled(false);return}var i=r.fullPath,o=f.getLanguageForPath(i).getId();M(o);c.getDocumentForPath(i).done(function(r){r.on("languageChanged.reference-in-files",function(){var e=f.getLanguageForPath(r.file.fullPath).getId();M(e)})});if(!t){return}var s=t.fullPath;c.getDocumentForPath(s).done(function(e){e.off("languageChanged.reference-in-files")})});t.htmlReady(function(){m=new s(F,"reference-in-files-results","reference-in-files.results","reference");if(m){m.on("close",function(){C()}).on("getNextPage",function(){if(F.hasResults()){m.showNextPage()}}).on("getLastPage",function(){if(F.hasResults()){m.showLastPage()}})}});i.on("beforeProjectClose",function(){if(m){m.close()}});u.register(E.FIND_ALL_REFERENCES,g.CMD_FIND_ALL_REFERENCES,P);u.get(g.CMD_FIND_ALL_REFERENCES).setEnabled(false);r.registerFindReferencesProvider=v;r.removeFindReferencesProvider=h;r.setMenuItemStateForLanguage=M;r.closeReferencesPanel=_});