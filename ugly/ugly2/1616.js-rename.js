const _=require("underscore-plus");const ChildProcess=require("child_process");const{Emitter}=require("event-kit");const path=require("path");module.exports=class t{constructor({command:t,args:e,options:s={},stdout:r,stderr:i,exit:o,autoStart:n=true}={}){this.emitter=new Emitter;this.command=t;this.args=e;this.options=s;this.stdout=r;this.stderr=i;this.exit=o;if(n===true){this.start()}this.killed=false}start(){if(this.started===true)return;this.started=true;if(process.platform==="win32"&&this.options.shell===undefined){this.spawnWithEscapedWindowsArgs(this.command,this.args,this.options)}else{this.spawn(this.command,this.args,this.options)}this.handleEvents(this.stdout,this.stderr,this.exit)}spawnWithEscapedWindowsArgs(e,t,s){let r=[];if(t){r=t.filter(t=>t!=null).map(t=>{if(this.isExplorerCommand(e)&&/^\/[a-zA-Z]+,.*$/.test(t)){return t}else{return`"${t.toString().replace(/"/g,'\\"')}"`}})}r.unshift(/\s|&|\^|\(|\)|\||#/.test(e)?`"${e}"`:e);const i=_.clone(s);i.windowsVerbatimArguments=true;this.spawn(this.getCmdPath(),["/s","/d","/c",`"${r.join(" ")}"`],i)}onWillThrowError(t){return this.emitter.on("will-throw-error",t)}bufferStream(t,r,e){t.setEncoding("utf8");let i="";t.on("data",t=>{if(this.killed)return;let e=i.length;i+=t;let s=t.lastIndexOf("\n");if(s!==-1){let t=s+e+1;r(i.substring(0,t));i=i.substring(t)}});t.on("close",()=>{if(this.killed)return;if(i.length>0)r(i);e()})}killOnWindows(){if(!this.process)return;const e=this.process.pid;const t="wmic";const s=["process","where",`(ParentProcessId=${e})`,"get","processid"];let r;try{r=ChildProcess.spawn(t,s)}catch(t){this.killProcess();return}r.on("error",()=>{});let i="";r.stdout.on("data",t=>{i+=t});r.stdout.on("close",()=>{for(let t of i.split(/\s+/)){if(!/^\d{1,10}$/.test(t))continue;t=parseInt(t,10);if(!t||t===e)continue;try{process.kill(t)}catch(t){}}this.killProcess()})}killProcess(){if(this.process)this.process.kill();this.process=null}isExplorerCommand(t){if(t==="explorer.exe"||t==="explorer"){return true}else if(process.env.SystemRoot){return t===path.join(process.env.SystemRoot,"explorer.exe")||t===path.join(process.env.SystemRoot,"explorer")}else{return false}}getCmdPath(){if(process.env.comspec){return process.env.comspec}else if(process.env.SystemRoot){return path.join(process.env.SystemRoot,"System32","cmd.exe")}else{return"cmd.exe"}}kill(){if(this.killed)return;this.killed=true;if(process.platform==="win32"){this.killOnWindows()}else{this.killProcess()}}spawn(t,e,s){try{this.process=ChildProcess.spawn(t,e,s)}catch(t){process.nextTick(()=>this.handleError(t))}}handleEvents(t,e,s){if(!this.process)return;const r=()=>{if(this.killed)return;if(i&&o&&n&&typeof s==="function"){s(l)}};let i=true;let o=true;let n=true;let l=0;if(t){i=false;this.bufferStream(this.process.stdout,t,()=>{i=true;r()})}if(e){o=false;this.bufferStream(this.process.stderr,e,()=>{o=true;r()})}if(s){n=false;this.process.on("exit",t=>{l=t;n=true;r()})}this.process.on("error",t=>{this.handleError(t)})}handleError(t){let e=false;const s=()=>{e=true};this.emitter.emit("will-throw-error",{error:t,handle:s});if(t.code==="ENOENT"&&t.syscall.indexOf("spawn")===0){t=new Error(`Failed to spawn command \`${this.command}\`. Make sure \`${this.command}\` is installed and on your PATH`,t.path);t.name="BufferedProcessError"}if(!e)throw t}};