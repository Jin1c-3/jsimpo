"use strict";var BN=require("bn.js");var elliptic=require("../../elliptic");var utils=elliptic.utils;var getNAF=utils.getNAF;var getJSF=utils.getJSF;var assert=utils.assert;function BaseCurve(e,t){this.type=e;this.p=new BN(t.p,16);this.red=t.prime?BN.red(t.prime):BN.mont(this.p);this.zero=new BN(0).toRed(this.red);this.one=new BN(1).toRed(this.red);this.two=new BN(2).toRed(this.red);this.n=t.n&&new BN(t.n,16);this.g=t.g&&this.pointFromJSON(t.g,t.gRed);this._wnafT1=new Array(4);this._wnafT2=new Array(4);this._wnafT3=new Array(4);this._wnafT4=new Array(4);var r=this.n&&this.p.div(this.n);if(!r||r.cmpn(100)>0){this.redN=null}else{this._maxwellTrick=true;this.redN=this.n.toRed(this.red)}}module.exports=BaseCurve;BaseCurve.prototype.point=function e(){throw new Error("Not implemented")};BaseCurve.prototype.validate=function e(){throw new Error("Not implemented")};BaseCurve.prototype._fixedNafMul=function e(t,r){assert(t.precomputed);var n=t._getDoubles();var i=getNAF(r,1);var o=(1<<n.step+1)-(n.step%2===0?2:1);o/=3;var s=[];for(var a=0;a<i.length;a+=n.step){var u=0;for(var r=a+n.step-1;r>=a;r--)u=(u<<1)+i[r];s.push(u)}var l=this.jpoint(null,null,null);var p=this.jpoint(null,null,null);for(var d=o;d>0;d--){for(var a=0;a<s.length;a++){var u=s[a];if(u===d)p=p.mixedAdd(n.points[a]);else if(u===-d)p=p.mixedAdd(n.points[a].neg())}l=l.add(p)}return l.toP()};BaseCurve.prototype._wnafMul=function e(t,r){var n=4;var i=t._getNAFPoints(n);n=i.wnd;var o=i.points;var s=getNAF(r,n);var a=this.jpoint(null,null,null);for(var u=s.length-1;u>=0;u--){for(var r=0;u>=0&&s[u]===0;u--)r++;if(u>=0)r++;a=a.dblp(r);if(u<0)break;var l=s[u];assert(l!==0);if(t.type==="affine"){if(l>0)a=a.mixedAdd(o[l-1>>1]);else a=a.mixedAdd(o[-l-1>>1].neg())}else{if(l>0)a=a.add(o[l-1>>1]);else a=a.add(o[-l-1>>1].neg())}}return t.type==="affine"?a.toP():a};BaseCurve.prototype._wnafMulAdd=function e(t,r,n,i,o){var s=this._wnafT1;var a=this._wnafT2;var u=this._wnafT3;var l=0;for(var p=0;p<i;p++){var d=r[p];var h=d._getNAFPoints(t);s[p]=h.wnd;a[p]=h.points}for(var p=i-1;p>=1;p-=2){var f=p-1;var v=p;if(s[f]!==1||s[v]!==1){u[f]=getNAF(n[f],s[f]);u[v]=getNAF(n[v],s[v]);l=Math.max(u[f].length,l);l=Math.max(u[v].length,l);continue}var c=[r[f],null,null,r[v]];if(r[f].y.cmp(r[v].y)===0){c[1]=r[f].add(r[v]);c[2]=r[f].toJ().mixedAdd(r[v].neg())}else if(r[f].y.cmp(r[v].y.redNeg())===0){c[1]=r[f].toJ().mixedAdd(r[v]);c[2]=r[f].add(r[v].neg())}else{c[1]=r[f].toJ().mixedAdd(r[v]);c[2]=r[f].toJ().mixedAdd(r[v].neg())}var g=[-3,-1,-5,-7,0,7,5,1,3];var m=getJSF(n[f],n[v]);l=Math.max(m[0].length,l);u[f]=new Array(l);u[v]=new Array(l);for(var y=0;y<l;y++){var w=m[0][y]|0;var B=m[1][y]|0;u[f][y]=g[(w+1)*3+(B+1)];u[v][y]=0;a[f]=c}}var A=this.jpoint(null,null,null);var b=this._wnafT4;for(var p=l;p>=0;p--){var N=0;while(p>=0){var _=true;for(var y=0;y<i;y++){b[y]=u[y][p]|0;if(b[y]!==0)_=false}if(!_)break;N++;p--}if(p>=0)N++;A=A.dblp(N);if(p<0)break;for(var y=0;y<i;y++){var P=b[y];var d;if(P===0)continue;else if(P>0)d=a[y][P-1>>1];else if(P<0)d=a[y][-P-1>>1].neg();if(d.type==="affine")A=A.mixedAdd(d);else A=A.add(d)}}for(var p=0;p<i;p++)a[p]=null;if(o)return A;else return A.toP()};function BasePoint(e,t){this.curve=e;this.type=t;this.precomputed=null}BaseCurve.BasePoint=BasePoint;BasePoint.prototype.eq=function e(){throw new Error("Not implemented")};BasePoint.prototype.validate=function e(){return this.curve.validate(this)};BaseCurve.prototype.decodePoint=function e(t,r){t=utils.toArray(t,r);var n=this.p.byteLength();if((t[0]===4||t[0]===6||t[0]===7)&&t.length-1===2*n){if(t[0]===6)assert(t[t.length-1]%2===0);else if(t[0]===7)assert(t[t.length-1]%2===1);var i=this.point(t.slice(1,1+n),t.slice(1+n,1+2*n));return i}else if((t[0]===2||t[0]===3)&&t.length-1===n){return this.pointFromX(t.slice(1,1+n),t[0]===3)}throw new Error("Unknown point format")};BasePoint.prototype.encodeCompressed=function e(t){return this.encode(t,true)};BasePoint.prototype._encode=function e(t){var r=this.curve.p.byteLength();var n=this.getX().toArray("be",r);if(t)return[this.getY().isEven()?2:3].concat(n);return[4].concat(n,this.getY().toArray("be",r))};BasePoint.prototype.encode=function e(t,r){return utils.encode(this._encode(r),t)};BasePoint.prototype.precompute=function e(t){if(this.precomputed)return this;var r={doubles:null,naf:null,beta:null};r.naf=this._getNAFPoints(8);r.doubles=this._getDoubles(4,t);r.beta=this._getBeta();this.precomputed=r;return this};BasePoint.prototype._hasDoubles=function e(t){if(!this.precomputed)return false;var r=this.precomputed.doubles;if(!r)return false;return r.points.length>=Math.ceil((t.bitLength()+1)/r.step)};BasePoint.prototype._getDoubles=function e(t,r){if(this.precomputed&&this.precomputed.doubles)return this.precomputed.doubles;var n=[this];var i=this;for(var o=0;o<r;o+=t){for(var s=0;s<t;s++)i=i.dbl();n.push(i)}return{step:t,points:n}};BasePoint.prototype._getNAFPoints=function e(t){if(this.precomputed&&this.precomputed.naf)return this.precomputed.naf;var r=[this];var n=(1<<t)-1;var i=n===1?null:this.dbl();for(var o=1;o<n;o++)r[o]=r[o-1].add(i);return{wnd:t,points:r}};BasePoint.prototype._getBeta=function e(){return null};BasePoint.prototype.dblp=function e(t){var r=this;for(var n=0;n<t;n++)r=r.dbl();return r};