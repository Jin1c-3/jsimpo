import _ from"underscore";import{FileUploadClass,FileUpload}from"../lib/FileUpload";import{settings}from"../../../settings";import"../../ufs/Webdav/server.js";const get=function(e,a,o){this.store.getReadStream(e._id,e).on("error",()=>{console.error("An error ocurred when fetching the file");o.writeHead(503);o.end()}).on("data",e=>{o.write(e)}).on("end",o.end.bind(o))};const copy=function(e,a){this.store.getReadStream(e._id,e).pipe(a)};const WebdavUploads=new FileUploadClass({name:"Webdav:Uploads",get:get,copy:copy});const WebdavAvatars=new FileUploadClass({name:"Webdav:Avatars",get:get,copy:copy});const WebdavUserDataFiles=new FileUploadClass({name:"Webdav:UserDataFiles",get:get,copy:copy});const configure=_.debounce(function(){const e=settings.get("FileUpload_Webdav_Upload_Folder_Path");const a=settings.get("FileUpload_Webdav_Server_URL");const o=settings.get("FileUpload_Webdav_Username");const t=settings.get("FileUpload_Webdav_Password");if(!a||!o||!t){return}const s={connection:{credentials:{server:a,username:o,password:t}},uploadFolderPath:e};WebdavUploads.store=FileUpload.configureUploadsStore("Webdav",WebdavUploads.name,s);WebdavAvatars.store=FileUpload.configureUploadsStore("Webdav",WebdavAvatars.name,s);WebdavUserDataFiles.store=FileUpload.configureUploadsStore("Webdav",WebdavUserDataFiles.name,s)},500);settings.get(/^FileUpload_Webdav_/,configure);