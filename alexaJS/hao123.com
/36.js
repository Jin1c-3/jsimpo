(function () {function getByClass(className, node, index) {return (node || document).querySelectorAll('.' + className)[index || 0];};function makeSearchLink(query, tn, node) {var link = 'https://www.baidu.com/s?wd=' + encodeURIComponent(query) + '&tn=' + tn;if (node) {node.href = link;}return link;};function request(url, param, callBack) {var xhr = new XMLHttpRequest();var list = [];for (var key in param) {if (param.hasOwnProperty(key)) {list.push(key + '=' + param[key]);}}xhr.open('GET', url + '?' + list.join('&'));xhr.onreadystatechange = function () {if (xhr.readyState === 4) {if (xhr.status === 200) {var res = JSON.parse(xhr.response);callBack(res);} else {callBack([]);}}};xhr.send();};function renderQuery(name) {var firstLine = links[0].data;var secondLine = links[1].data;firstLine.push({title: '违章查询',url: makeSearchLink('违章查询', '50000246_hao_pg'),needProcess: true});firstLine.push({title: '网盘',url: 'https://pan.baidu.com'});var linkTpl = [];for (var key in firstLine) {linkTpl.push('<div class="header-line">'+ '<div class="link-item line-item ' + (firstLine[key].needProcess ? 'has-limit' : '') + '">'+ '<a  href="' + firstLine[key].url + '" target="_blank">' + firstLine[key].title + '</a>'+ '</div>'+ (secondLine[key] ? ('<div class="link-item line-item">'+ '<a  href="' + secondLine[key].url + '" target="_blank">' + secondLine[key].title + '</a>'+ '</div>') : '')+'</div>');};getByClass('head-item-links-area').innerHTML = linkTpl.join('');request('/api/gethitthecity', {}, function (data) {if (data.isHit) {var originText = getByClass('has-limit').innerHTML.replace('查询', '');originText += ('<a  href="" class="no-car" target="_blank"> 限号</a>');getByClass('has-limit').innerHTML = originText;makeSearchLink(name + '限行', '50000247_hao_pg', getByClass('no-car'));}});};function bindWeatherLink(cityName) {var w_tn = '50000211_hao_pg';makeSearchLink(cityName + '一周天气预报', w_tn, getByClass('weather-week'));makeSearchLink(cityName + '一周天气预报', w_tn, getByClass('more-icon'));makeSearchLink(cityName + '天气预报', w_tn, getByClass('weather-today'));makeSearchLink(cityName + '明天天气', w_tn, getByClass('weather-tomorrow'));};function bindCalendarLink() {var c_tn = '50000167_hao_pg';makeSearchLink('日历', c_tn, getByClass('solar-date'));makeSearchLink('星座运势', c_tn, getByClass('lucky-date'));makeSearchLink('日历', c_tn, getByClass('week-date'));makeSearchLink('农历查询', c_tn, getByClass('lunar-date'));};function createSwiper(node) {var current = 0;var warnNodeList;var exactNode;function renderWarns(warns, data) {var tagColor = ['yellow-tag', 'orange-tag', 'blue-tag', 'red-tag'];var airTagColor = ['air-green-tag', 'air-lightgreen-tag', 'air-orange-tag', 'air-lightred-tag', 'air-red-tag', 'air-darkred-tag'];var tpl = '<div class="weather-info" style="top: 0px;">'+ '<span class="weather-temp">' + data.min + '～' + data.max + '℃ </span>'+ '<span class="weather-air">' + data.air + '</span>'+ '</div>';var itemTagColor;for (var key in warns) {if (warns.hasOwnProperty(key)) {if(warns[key].name === 'pollution') {itemTagColor = airTagColor[warns[key].level - 1] + ' air-weather-tag';} else {itemTagColor = tagColor[warns[key].level - 1];}tpl += '<div class="weather-tag ' + itemTagColor + '">'+ (warns[key].icon ? '<i class="new-head-icon warn-icon" style="background-image: url('+ warns[key].icon + ')"></i>' : '')+ warns[key].disc+ '</div>';}};node.innerHTML = tpl;warnNodeList = node.children;current = 0;};function getNext() {var newNode = warnNodeList[current++];!warnNodeList[current] && (current = 0);return newNode;};function recur() {var list = [];var running = false;function more(callBack, defer) {list.push(function () {setTimeout(function () {callBack && callBack();list[0] && list.shift()();}, defer || 300);});!running && list[0] && (running = true) && list.shift()();return more;};return more;};function checkout() {setTimeout(function () {if (!exactNode) {exactNode = getNext();}var newNode = getNext();recur()(function () {exactNode.style.top = '-100%';newNode.style.top = '0px';}, 0)(function () {exactNode.style.opacity = 0;}, 300)(function () {exactNode.style.top = '100%';}, 300)(function () {exactNode.style.opacity = 1;exactNode = newNode;}, 0);checkout();}, 3000);};checkout();return renderWarns;};function warnFormat(data) {var warns = [];var w = data.alarm.w;var levelMap = {'红色': 5,'蓝色': 4,'橙色': 3,'黄色': 2,'绿色': 1};for (var key in w) {if (w.hasOwnProperty(key)) {warns.push({icon: HAO.httpsTrans('http://sc0.hao123img.com/res/weather/yj/i' + w[key].w4 + '.png'),disc: w[key].w5.length >= 4 ? w[key].w5 : w[key].w5 + '预警',level: levelMap[w[key].w7]});}};var levelDisc = data.aqi.levelLong || '';levelDisc = levelDisc.replace('污染', '');warns.push({name: 'pollution',level: parseInt(data.aqi.levelnum),disc: levelDisc});return warns;};function weatherFormat(data, day) {var info = {status: day.weathern_zh || day.weatherd_zh,min: day.fd,max: day.fc,air: data.aqi.level,icon: day.icon_url};return info;};var cityInfo = {cityCode: [],cityStr: '',updateCity: function (data) {this.cityCode = data.cityCode;this.cityStr = data.cityStr;var cityName = this.cityStr[2] || this.cityStr[1] || this.cityStr[0];getByClass('city-name').innerText = cityName;var param = {t: 2,provice: this.cityStr[0],city: this.cityStr[1],district: this.cityStr[2]};bindWeatherLink(cityName);makeSearchLink(cityName + '限行', '50000247_hao_pg', getByClass('no-car'));request('/api/newforecast', param, function (data) {var weather = {today: weatherFormat(data, data.forecast5d.f.f1[0]),tomorrow: weatherFormat(data, data.forecast5d.f.f1[1]),warns: warnFormat(data)};renderWeather(weather);});}};function renderWeather(data) {function renderDay(node, day) {getByClass('weather-status', node).innerText = day.status;getByClass('weather-temp', node).innerText = day.min + '～' + day.max + '℃';(getByClass('weather-air', node) || {}).innerText = day.air;getByClass('status-icon', node).style.backgroundImage = 'url(' + day.icon + ')';};renderDay(getByClass('weather-today'), data.today);renderDay(getByClass('weather-tomorrow'), data.tomorrow);swiper(data.warns, data.today);};function getSelectedName(node) {var name = ((node.options[node.selectedIndex] || {}).innerText || '').split(' ');return name[1] || name[0];};function getAreaList(pid, cid, fn) {function preProcess(data) {var list = [];for (var key in data) {if (data.hasOwnProperty(key)) {list.push({id: data[key].id,name: data[key].firstchar + ' ' + data[key].name});}};fn(list);};var param = {};pid && (param.pid = pid);cid && (param.cid = cid);request('/api/citymenu', param, preProcess);};function setSelect(node, list) {var text = '';var index = 0;var item;for (var key in list) {item = list[key];text += '<option value="' + item.id + '"' + (!index ? 'selected' : '') + '>' + item.name + '</option>';index++;}node.innerHTML = text;};function chooseProvince(e) {e.stopPropagation();getAreaList($province.value, null, function (data){setSelect($city, data);setSelect($dist, [data[0]]);});};function chooseCity(e) {e.stopPropagation();getAreaList($province.value, $city.value, function (data){setSelect($dist, data);});};function confirm(e) {var newCity = {cityCode: [$province.value, $city.value, $dist.value],cityStr: [getSelectedName($province), getSelectedName($city), getSelectedName($dist)]};cityInfo.updateCity(newCity);close(e);};function close(e) {stop(e);selectBoard.style.display !== 'none' && (selectBoard.style.display = 'none');};function open(e) {stop(e);selectBoard.style.display = 'block';};function stop(e) {e.stopPropagation();};function bindEvent(node, event, fn) {node.addEventListener? node.addEventListener(event, fn): node.attachEvent('on' + event, fn);};var initDist = {name: '北京',id: '01'};var initCity = {name: '北京',id: '00'};var initProv = {name: '北京',id: '$01'};var links = JSON.parse(getByClass('head-links').innerText);var $weatherData = JSON.parse(getByClass('head-weatherData').innerText);var $today = JSON.parse(getByClass('head-today').innerText);getByClass('page-width').removeChild(getByClass('head-weatherData'));getByClass('page-width').removeChild(getByClass('head-today'));getByClass('page-width').removeChild(getByClass('head-links'));var selectBoard = getByClass('select-area');var $province = getByClass('select-province');var $city = getByClass('select-city');var $dist = getByClass('select-dist');var swiper = createSwiper(getByClass('weather-tag-area'));bindEvent(selectBoard, 'click', stop);bindEvent(getByClass('city-change-btn'), 'click', open);bindEvent(getByClass('select-cancel-btn'), 'click', close);bindEvent(getByClass('select-confirm-btn'), 'click', confirm);bindEvent($province, 'change', chooseProvince);bindEvent($city, 'change', chooseCity);bindEvent(window, 'click', close);renderQuery(initDist.name);swiper(warnFormat($weatherData), weatherFormat($weatherData, $today));setSelect($province, [initProv]);setSelect($city, [initCity]);setSelect($dist, [initDist]);bindWeatherLink(initDist.name || initCity.name || initProv.name);bindCalendarLink();getAreaList(null, null, function (data) {setSelect($province, data);});})();