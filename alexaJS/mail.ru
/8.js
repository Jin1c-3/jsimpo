
					var xray=function(){'use strict';function a(a){for(n.push(a);n.length>o.maxSize;)n.shift()}function b(a){return b="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},b(a)}function c(a){return a&&"object"===b(a)&&!d(a)}function d(a){return"[object Array]"===Object.prototype.toString.call(a)}function e(){for(var a,b={},d=0;d<arguments.length;++d)for(var f in a=arguments[d],a)b[f]=b[f]&&c(b[f])&&c(a[f])?e(b[f],a[f]):a[f];return b}function f(a){var b=encodeURIComponent(JSON.stringify(a));return{size:b.length,raw:b}}function g(){this._batchesByUrls={},this._timeoutId=null,this._config={maxBatchSize:6e4,maxChunkSize:4e3,timeout:1000,idle:!1},"undefined"!=typeof window&&window.addEventListener("beforeunload",this.process.bind(this,!0))}function h(a){return"s".concat(a,"s").replace(/s+/g,"s").replace(/^s$/g,"")}function j(a){for(var b in a)("undefined"==typeof a[b]||null===a[b])&&delete a[b];return a}function k(a,b){for(var c=-1,d=0;d<a.length;d++)if(b===a[d]){c=d;break}return c}function l(){this._config={xrayRadarUrl:"https://xray.mail.ru",pgid:(Date.now()+Math.random()).toString(36),radarPrefix:"",r:"undefined"!=typeof document&&document.referrer||"",defaultParams:{p:"mail",t_feature:"",v:1,skipdwh:!1}}}function m(a,b){for(var c=a.split("&"),d=c[0],e={},f=1;f<c.length;++f){var g=c[f].split("="),h=decodeURIComponent(g[0]),j=decodeURIComponent(g[1]);try{j=JSON.parse(j)}catch(a){}e[h]=j}b=b||{},b.immediately?z.sendImmediately(d,e,b.ga):z.send(d,e,b.ga)}var n=[],o={maxSize:500,getLog:function(){return Array.prototype.slice.call(n,0)},clear:function(){n=[]}},p={log:function(){try{(console.debug||console.log).apply(console,arguments)}catch(a){}},error:function(){try{console.error.apply(console,arguments)}catch(a){}},warn:function(){try{console.warn.apply(console,arguments)}catch(a){}}},q=["p","email","split","utm","r","pgid","o_ss","o_v"],r=!1;g.prototype.setConfig=function(a){var b=Math.max;if(!r)return a.timeout=b(1e3,a.timeout||0),this._config=e(this._config,a),void(r=!0);var c=[];for(var d in a){if(d in this._config){c.push(d);continue}this._config[d]=a[d]}c.length&&p.warn("Queue config field(s) "+c.join(", ")+" are already set and can't be modified")},g.prototype.getConfig=function(){return e(this._config,{})},g.prototype.push=function(b,c){a(c);var d=b+"/batch?"+g._buildQueryString(c);c=g._stringifyParams(c);var e=f(c);if(e.size+2>this._config.maxBatchSize)return void p.error("Radar #"+c.uid+" body is too long: "+e.raw);this._batchesByUrls[d]||(this._batchesByUrls[d]=[[]]);var h,j=this._batchesByUrls[d];for(h=0;h<j.length;++h){var k=j[h];if(f(k.concat([c])).size<=this._config.maxBatchSize){k.push(c);break}}h===j.length&&j.push([c]),this._timeoutId||"function"!=typeof setTimeout||(this._timeoutId=setTimeout(this.process.bind(this),this._config.timeout))},g.prototype.process=function(a){for(var b in clearTimeout(this._timeoutId),this._timeoutId=null,this._batchesByUrls){for(var c=this._batchesByUrls[b],d=0;d<c.length;++d)this._send(b,c[d],a);delete this._batchesByUrls[b]}},g.prototype.isIdle=function(){return this._config.idle},g._buildQueryString=function(a){for(var b=[],c=0;c<q.length;++c){var d=q[c],e="string"==typeof a[d]?a[d]:JSON.stringify(a[d]);(delete a[d],"undefined"!=typeof e&&e.length)&&b.push(encodeURIComponent(d)+"="+encodeURIComponent(e))}var f=[];for(var g in a.baseQuery)f.push(g);f=f.sort();for(var h,j=0;j<f.length;++j)h=f[j],b.push(encodeURIComponent(h)+"="+encodeURIComponent(a.baseQuery[h]));return delete a.baseQuery,b.join("&")},g.prototype._send=function(a,b,c){var d={url:a,data:"batch="+encodeURIComponent(JSON.stringify(b)),type:"POST",async:!0};if(!this._config.idle){if("undefined"==typeof XMLHttpRequest&&!navigator.sendBeacon)return void fetch(a,{method:d.type,body:d.data});if(c&&window.navigator.sendBeacon)return void window.navigator.sendBeacon(d.url,d.data);try{var e=new XMLHttpRequest,f="function"==typeof this._config.beforeSend&&!this._config.beforeSend(e,d);if(f)return void e.abort();e.open(d.type,d.url,d.async),e.withCredentials=!0,e.send(d.data)}catch(a){p.error("xray.send failed:",a)}}},g._stringifyParams=function(a){var b={};for(var c in a){if("i"==c){b.i=g._stringifyI(a.i);continue}b[c]="string"==typeof a[c]?a[c]:JSON.stringify(a[c])}return b},g._stringifyI=function(a){var b=[];for(var c in a){var d=a[c];b.push(c+":"+d)}return b.join(",")};var s=0,t=["radarPrefix","split","r","pgid","utm","o_ss","o_v"],u=!1,v=new g,w={rlog_dot_error:"xray_rlog_dot_error",rlog_msg_abs:"xray_rlog_msg_abs",too_long:"xray_too_long",not_configured:"xray_not_configured"},x=32,y=64;l.prototype.logger=o,l.prototype.setConfig=function(a,b){a=a||{},u&&this._deleteProtectedParams(a),this.unsafeSetConfig(a,b)},l.prototype.unsafeSetConfig=function(a,b){a=a||{},u=!0,a.split&&(a.split=h(a.split)),a.defaultParams&&a.defaultParams.i&&(a.defaultParams.i=this._formatIntervals(a.defaultParams.i),delete this._config.defaultParams.i),this._config=b?a:e(this._config,a),a.gaTrackingId&&this._initGA(a.gaTrackingId)},l.prototype._deleteProtectedParams=function(a){for(var b=0;b<t.length;++b)delete a[t[b]];return a},l.prototype.addSplit=function(a){this._config.split=h("".concat(this._config.split||"","s").concat(a))},l.prototype.getConfig=function(){return e(this._config,{})},l.prototype.getTotalSended=function(){return s},l.prototype.setQueueConfig=g.prototype.setConfig.bind(v),l.prototype.getQueueConfig=g.prototype.getConfig.bind(v),l.prototype.getInstanceCopy=function(){var a=new l;return u=!1,a.setConfig(this._config,!0),a},l.prototype.send=function(a,b,c){this._send(a,b,c,!0)},l.prototype._send=function(a,b,c,f){if(f&&!u&&a!==w.not_configured){var g=b||{};g.t=a,this._logOwnError(g,w.not_configured),p.warn("Your xray instance is not configured")}if(b=e(b||{},{}),this._config.middlewares)for(var h=0;h<this._config.middlewares.length;h++){var j=this._config.middlewares[h],k=j(a,b,c);a=k.t,b=k.params,c=k.ga}a=d(a)?a.join("_"):a,b.i&&(b.i=this._formatIntervals(b.i)),b=e(this._config.defaultParams,this._config.expid?{dwh:{expid:this._config.expid}}:{},b,{t:a,split:this._config.split,r:this._config.r,pgid:this._config.pgid,utm:this._config.utm,o_ss:this._config.o_ss,o_v:this._config.o_v,baseQuery:this._config.baseQuery,uid:s++}),b.skipdwh&&b.dwh&&delete b.dwh;for(var l=[b.t_feature,this._config.radarPrefix],m=0;m<l.length;++m)l[m]&&(b.t=l[m]+"_"+b.t);delete b.t_feature;try{b=this._validateParams(b,f)}catch(a){return p.log("xray",b.uid,b),void p.error(a.message)}if(this._config.verbose&&p.log("xray",b.uid,b.t,b,c?"GA: "+!!c:void 0),v.push(this._config.xrayRadarUrl,b),!0===c&&!this._config.gaTrackingId)return void p.error("Radar #"+b.uid+": no GA tracking id specified");var n="string"==typeof c?c:this._config.gaTrackingId;if(!!c&&n&&!v.isIdle()){if(b.i){for(var o in b.i)this._sendGA(a+"_"+o,b.i[o],n);return}this._sendGA(a,b.v,n)}},l.prototype.sendImmediately=function(a,b,c){this.send(a,b,c),v.process()},l.prototype.addMiddleware=function(a){this._config.middlewares||(this._config.middlewares=[]),-1===k(this._config.middlewares,a)&&this._config.middlewares.push(a)},l.prototype.removeMiddleware=function(a){if(this._config.middlewares){var b=k(this._config.middlewares,a);-1<b&&this._config.middlewares.splice(b,1)}},l.prototype._sendGA=function(a,b,c){"function"!=typeof gtag&&this._initGA(c);var d=a.split(/_/g),e=d[1]||d[0],f=d[1]?d[0]:"",g=d.slice(2).join("_"),h={value:b,send_to:c};f&&(h.event_category=f),g&&(h.event_label=g),gtag("event",e,h)},l.prototype._initGA=function(a){if(!window.gtag){var b=document.createElement("script");b.src="https://www.googletagmanager.com/gtag/js?id="+a,b.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(b),window.dataLayer=window.dataLayer||[],window.gtag=function(){window.dataLayer.push(arguments)},gtag("js",new Date)}gtag("config",a,{send_page_view:!1})},l.prototype._logOwnError=function(a,b,c){var d="xray_err",e=a.p;if(e){if(e.length+8+1>x){e=e.slice(0,x-8-1)}d="".concat(e,"_").concat("xray_err")}var f=a.t;f.length>y&&(f=f.slice(0,y)),this._send(b,{skipdwh:!0,rlog:d,rlog_message:{t:f,err:b,value:c}},!1,!1)},l.prototype._validateParams=function(a,b){a=j(a),a.rlog&&-1!==a.rlog.indexOf(".")&&(b&&this._logOwnError(a,w.rlog_dot_error,a.rlog),p.error("Radar #".concat(a.uid,": rlog can not contain file extension")),delete a.rlog,delete a.rlog_message),a.rlog&&a.rlog_message||(a.rlog_message&&(b&&this._logOwnError(a,w.rlog_msg_abs),p.error("Radar #".concat(a.uid,": rlog_message would not be sent without rlog"))),delete a.rlog,delete a.rlog_message);var c={32:[a.p,a.rlog],64:[a.p+"_"+a.t]};for(var d in a.i)c[32].push(d),c[64].push(a.p+"_"+a.t+"_"+d);for(var e in c)for(var f=c[e],g=0;g<f.length;++g)if(f[g]&&f[g].length>e)throw b&&this._logOwnError(a,w.too_long,f[g].slice(0,e)),new Error("Radar #".concat(a.uid,": value is too long: ").concat(c[e][g])+" (len: ".concat(f[g].length,", limit: ").concat(e,")"));return a},l.prototype._formatIntervals=function(a){if(c(a))return a;var b={};if(d(a)){for(var e,f=0;f<a.length;++f)e=a[f].split(":"),b[e[0]]=+e[1]||this._config.defaultParams.v;return b}if("string"==typeof a){var g=a.split(",");return this._formatIntervals(g)}};var z=new l;return m.setConfig=function(a){z.setConfig(j({verbose:a.verbose,pgid:a.pgid,split:a.split,xrayRadarUrl:a.xrayRadarUrl||a.XRAY_RADAR_URL,radarPrefix:a.radarPrefix||a.RadarPrefix,utm:a.utm,o_ss:a.o_ss,o_v:a.o_v,baseQuery:a.baseQuery,gaTrackingId:a.gaTrackingId||a.GA_TRACKING_ID,defaultParams:a.defaultParams||j({p:a.project,email:a.ActiveEmail})})),z.setQueueConfig(j({maxBatchSize:a.MAX_BATCH_SIZE,maxChunkSize:a.MAX_CHUNK_SIZE,beforeSend:a.beforeSend,timeout:a.timeout,idle:a.idle}))},m.getConfig=l.prototype.getConfig.bind(z),m.addSplit=l.prototype.addSplit.bind(z),m.unsafeSetConfig=l.prototype.unsafeSetConfig.bind(z),m.setQueueConfig=l.prototype.setQueueConfig.bind(z),m.getQueueConfig=l.prototype.getQueueConfig.bind(z),m.getTotalSended=l.prototype.getTotalSended.bind(z),m.send=l.prototype.send.bind(z),m.sendImmediately=l.prototype.sendImmediately.bind(z),m.getInstanceCopy=l.prototype.getInstanceCopy.bind(z),m.addMiddleware=l.prototype.addMiddleware.bind(z),m.removeMiddleware=l.prototype.removeMiddleware.bind(z),"undefined"!=typeof window&&"function"==typeof window.define&&window.define.amd&&window.define("@mail/xray",function(){return m}),m}();
					//# sourceURL=xray.min.js
				