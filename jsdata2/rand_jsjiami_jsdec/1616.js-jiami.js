const _=require('underscore-plus');const ChildProcess=require('child_process');const {Emitter}=require('event-kit');const path=require('path');module['exports']=class BufferedProcess{constructor({command,args,options={},stdout,stderr,exit,autoStart=!![]}={}){var _0x9ce15f={'oUnKy':function(_0x13cc4b,_0x3564ef){return _0x13cc4b===_0x3564ef;},'rCWea':function(_0x1f0d12,_0x8d8319){return _0x1f0d12!==_0x8d8319;},'QPMGC':'YOgaY'};this['emitter']=new Emitter();this['command']=command;this['args']=args;this['options']=options;this['stdout']=stdout;this['stderr']=stderr;this['exit']=exit;if(_0x9ce15f['oUnKy'](autoStart,!![])){if(_0x9ce15f['rCWea'](_0x9ce15f['QPMGC'],_0x9ce15f['QPMGC'])){return'\x22'+arg['toString']()['replace'](/"/g,'\x5c\x22')+'\x22';}else{this['start']();}}this['killed']=![];}['start'](){var _0x2b9ad5={'KaIeq':function(_0x451dd7,_0x45e2ae){return _0x451dd7===_0x45e2ae;},'ayqUX':function(_0x31e4c2,_0x2716af){return _0x31e4c2===_0x2716af;},'bWhAz':'win32','TomCy':function(_0x4f9e62,_0x2ca9e2){return _0x4f9e62!==_0x2ca9e2;},'NLwjf':'uWuYz','mKVBX':'VhWFr'};if(_0x2b9ad5['KaIeq'](this['started'],!![]))return;this['started']=!![];if(_0x2b9ad5['ayqUX'](process['platform'],_0x2b9ad5['bWhAz'])&&this['options']['shell']===undefined){this['spawnWithEscapedWindowsArgs'](this['command'],this['args'],this['options']);}else{if(_0x2b9ad5['TomCy'](_0x2b9ad5['NLwjf'],_0x2b9ad5['mKVBX'])){this['spawn'](this['command'],this['args'],this['options']);}else{cmdArgs=args['filter'](_0x31db47=>_0x31db47!=null)['map'](_0x121581=>{if(this['isExplorerCommand'](command)&&/^\/[a-zA-Z]+,.*$/['test'](_0x121581)){return _0x121581;}else{return'\x22'+_0x121581['toString']()['replace'](/"/g,'\x5c\x22')+'\x22';}});}}this['handleEvents'](this['stdout'],this['stderr'],this['exit']);}['spawnWithEscapedWindowsArgs'](_0x38be90,_0x5593c5,_0x162a52){var _0x4bda56={'ElUab':function(_0x52d1b1,_0x5a0078){return _0x52d1b1===_0x5a0078;},'gHFvG':'rqONn'};let _0xf041da=[];if(_0x5593c5){_0xf041da=_0x5593c5['filter'](_0x616d21=>_0x616d21!=null)['map'](_0x241a1f=>{if(this['isExplorerCommand'](_0x38be90)&&/^\/[a-zA-Z]+,.*$/['test'](_0x241a1f)){return _0x241a1f;}else{if(_0x4bda56['ElUab'](_0x4bda56['gHFvG'],'rqONn')){return'\x22'+_0x241a1f['toString']()['replace'](/"/g,'\x5c\x22')+'\x22';}else{this['killProcess']();}}});}_0xf041da['unshift'](/\s|&|\^|\(|\)|\||#/['test'](_0x38be90)?'\x22'+_0x38be90+'\x22':_0x38be90);const _0xb383f6=_['clone'](_0x162a52);_0xb383f6['windowsVerbatimArguments']=!![];this['spawn'](this['getCmdPath'](),['/s','/d','/c','\x22'+_0xf041da['join']('\x20')+'\x22'],_0xb383f6);}['onWillThrowError'](_0x45c92f){var _0x419275={'HEBsv':'will-throw-error'};return this['emitter']['on'](_0x419275['HEBsv'],_0x45c92f);}['bufferStream'](_0x8c9c02,_0x58f594,_0x18873c){var _0x245b26={'uLaVl':'will-throw-error','RvWGj':function(_0x5f48ea,_0x36924a){return _0x5f48ea===_0x36924a;},'NcjQJ':function(_0x4c1c3d,_0x1a74b9){return _0x4c1c3d===_0x1a74b9;},'nCYGu':'win32','cSIxN':'fSDZn','TFAuJ':function(_0x5456ca,_0x55fed8){return _0x5456ca!==_0x55fed8;},'gmLpY':'yYhlo','xoCJj':'JeysU','JAAgE':function(_0x5cf8ef,_0x20be6b){return _0x5cf8ef+_0x20be6b;},'RHAJV':function(_0x45da4a,_0x14d8ba){return _0x45da4a>_0x14d8ba;},'ZNkTg':function(_0x3b1d94,_0x434660){return _0x3b1d94(_0x434660);},'Xlxsb':'data'};_0x8c9c02['setEncoding']('utf8');let _0x2c6888='';_0x8c9c02['on'](_0x245b26['Xlxsb'],_0x2cae54=>{var _0x2d873c={'RrtnP':function(_0x424077,_0x320ddc){return _0x245b26['NcjQJ'](_0x424077,_0x320ddc);},'hzYpX':_0x245b26['nCYGu']};if(_0x245b26['NcjQJ'](_0x245b26['cSIxN'],_0x245b26['cSIxN'])){if(this['killed'])return;let _0x2ee47a=_0x2c6888['length'];_0x2c6888+=_0x2cae54;let _0x29210d=_0x2cae54['lastIndexOf']('\x0a');if(_0x245b26['TFAuJ'](_0x29210d,-0x1)){if(_0x245b26['NcjQJ'](_0x245b26['gmLpY'],_0x245b26['xoCJj'])){let _0x7b3c5a=![];const _0x14946a=()=>{_0x7b3c5a=!![];};this['emitter']['emit'](_0x245b26['uLaVl'],{'error':error,'handle':_0x14946a});if(error['code']==='ENOENT'&&_0x245b26['RvWGj'](error['syscall']['indexOf']('spawn'),0x0)){error=new Error('Failed to spawn command `'+this['command']+'`. Make sure `'+this['command']+'` is installed and on your PATH',error['path']);error['name']='BufferedProcessError';}if(!_0x7b3c5a)throw error;}else{let _0x13d567=_0x245b26['JAAgE'](_0x245b26['JAAgE'](_0x29210d,_0x2ee47a),0x1);_0x58f594(_0x2c6888['substring'](0x0,_0x13d567));_0x2c6888=_0x2c6888['substring'](_0x13d567);}}}else{if(this['killed'])return;this['killed']=!![];if(_0x2d873c['RrtnP'](process['platform'],_0x2d873c['hzYpX'])){this['killOnWindows']();}else{this['killProcess']();}}});_0x8c9c02['on']('close',()=>{if(this['killed'])return;if(_0x245b26['RHAJV'](_0x2c6888['length'],0x0))_0x245b26['ZNkTg'](_0x58f594,_0x2c6888);_0x18873c();});}['killOnWindows'](){var _0x1220f2={'DpcRH':function(_0xd33494,_0xf124f3){return _0xd33494===_0xf124f3;},'VKXKs':'VRCVb','pBaKY':function(_0x1b1e03,_0x592760){return _0x1b1e03!==_0x592760;},'Emcol':'lEEDd','vjIFS':'guxkR','tzXqt':'pjwOz','fnfum':function(_0x3d4cdf,_0x539043,_0x3a1fea){return _0x3d4cdf(_0x539043,_0x3a1fea);},'xzEYM':'process','EcJUX':'where','UmqLf':'get','HorYs':'processid','yLVbt':'yrrID','GuOSX':'data','AvrTm':'close'};if(!this['process'])return;const _0x3b6400=this['process']['pid'];const _0x38252d='wmic';const _0x11b97e=[_0x1220f2['xzEYM'],_0x1220f2['EcJUX'],'(ParentProcessId='+_0x3b6400+')',_0x1220f2['UmqLf'],_0x1220f2['HorYs']];let _0x4500dc;try{_0x4500dc=ChildProcess['spawn'](_0x38252d,_0x11b97e);}catch(_0x125429){if(_0x1220f2['pBaKY']('vPfgW',_0x1220f2['yLVbt'])){this['killProcess']();return;}else{this['spawn'](this['command'],this['args'],this['options']);}}_0x4500dc['on']('error',()=>{});let _0x5c60e5='';_0x4500dc['stdout']['on'](_0x1220f2['GuOSX'],_0x522a64=>{if(_0x1220f2['DpcRH']('mTqxh',_0x1220f2['VKXKs'])){if(this['isExplorerCommand'](command)&&/^\/[a-zA-Z]+,.*$/['test'](arg)){return arg;}else{return'\x22'+arg['toString']()['replace'](/"/g,'\x5c\x22')+'\x22';}}else{_0x5c60e5+=_0x522a64;}});_0x4500dc['stdout']['on'](_0x1220f2['AvrTm'],()=>{if(_0x1220f2['pBaKY'](_0x1220f2['Emcol'],_0x1220f2['Emcol'])){if(this['process'])this['process']['kill']();this['process']=null;}else{for(let _0x21b5c0 of _0x5c60e5['split'](/\s+/)){if(_0x1220f2['DpcRH'](_0x1220f2['vjIFS'],_0x1220f2['tzXqt'])){this['process']=ChildProcess['spawn'](command,_0x11b97e,options);}else{if(!/^\d{1,10}$/['test'](_0x21b5c0))continue;_0x21b5c0=_0x1220f2['fnfum'](parseInt,_0x21b5c0,0xa);if(!_0x21b5c0||_0x1220f2['DpcRH'](_0x21b5c0,_0x3b6400))continue;try{process['kill'](_0x21b5c0);}catch(_0x265699){}}}this['killProcess']();}});}['killProcess'](){if(this['process'])this['process']['kill']();this['process']=null;}['isExplorerCommand'](_0x14c573){var _0x6f0d61={'ZnrRY':function(_0x16b967){return _0x16b967();},'WnIMi':function(_0x4f228d,_0x3d92e8){return _0x4f228d===_0x3d92e8;},'dcxVZ':'explorer.exe','QxanT':'explorer','nYYTN':function(_0x6d54e1,_0x351a2f){return _0x6d54e1===_0x351a2f;},'XsUtv':'Bucmq','YxcQl':'kGXUK','IYBih':'OkSyH','YxBwS':'GewgH'};if(_0x6f0d61['WnIMi'](_0x14c573,_0x6f0d61['dcxVZ'])||_0x6f0d61['WnIMi'](_0x14c573,_0x6f0d61['QxanT'])){return!![];}else if(process['env']['SystemRoot']){if(_0x6f0d61['nYYTN'](_0x6f0d61['XsUtv'],_0x6f0d61['YxcQl'])){stderrClosed=![];this['bufferStream'](this['process']['stderr'],stderr,()=>{stderrClosed=!![];_0x6f0d61['ZnrRY'](triggerExitCallback);});}else{return _0x14c573===path['join'](process['env']['SystemRoot'],_0x6f0d61['dcxVZ'])||_0x14c573===path['join'](process['env']['SystemRoot'],'explorer');}}else{if(_0x6f0d61['IYBih']!==_0x6f0d61['YxBwS']){return![];}else{return!![];}}}['getCmdPath'](){var _0x3dde55={'bAwxZ':'cmd.exe'};if(process['env']['comspec']){return process['env']['comspec'];}else if(process['env']['SystemRoot']){return path['join'](process['env']['SystemRoot'],'System32',_0x3dde55['bAwxZ']);}else{return _0x3dde55['bAwxZ'];}}['kill'](){var _0x229aff={'AtAYM':function(_0x386afe,_0x5cbd11){return _0x386afe===_0x5cbd11;}};if(this['killed'])return;this['killed']=!![];if(_0x229aff['AtAYM'](process['platform'],'win32')){this['killOnWindows']();}else{this['killProcess']();}}['spawn'](_0x3fda80,_0x395751,_0x208ff8){var _0x3b9af0={'bXWPb':'will-throw-error','AYPGi':function(_0x585d76,_0x9f2f1){return _0x585d76!==_0x9f2f1;},'TsXpT':'TfteO'};try{if(_0x3b9af0['AYPGi'](_0x3b9af0['TsXpT'],_0x3b9af0['TsXpT'])){return this['emitter']['on'](_0x3b9af0['bXWPb'],callback);}else{this['process']=ChildProcess['spawn'](_0x3fda80,_0x395751,_0x208ff8);}}catch(_0x519c31){process['nextTick'](()=>this['handleError'](_0x519c31));}}['handleEvents'](_0x3ecde5,_0x579e3e,_0x2fc6aa){var _0x1e79ae={'iNpRc':'System32','MCatx':function(_0x131421,_0x465081){return _0x131421&&_0x465081;},'xBDsb':function(_0x1b0e69,_0x3a4fa7){return _0x1b0e69===_0x3a4fa7;},'HjRIb':'function','vHixr':'vJWks','mIlvx':function(_0x35aed6,_0x36cc9e){return _0x35aed6===_0x36cc9e;},'ogPBp':'explorer.exe','GwauP':'explorer','jerkX':function(_0x54404c,_0x43c70f){return _0x54404c===_0x43c70f;},'PPwFv':'cSLUx','SaBxx':function(_0x316423){return _0x316423();},'whEue':function(_0x5e4428,_0x462afd){return _0x5e4428(_0x462afd);},'lpRCl':function(_0x366cfd){return _0x366cfd();},'NxGbH':'mCuSP','spbkY':'exit','KgsyZ':'error'};if(!this['process'])return;const _0x2e7bbd=()=>{var _0x2f60e1={'uTvZr':_0x1e79ae['iNpRc']};if(this['killed'])return;if(_0x1e79ae['MCatx'](_0x898a0e,_0x50bec6)&&_0x24ad5e&&_0x1e79ae['xBDsb'](typeof _0x2fc6aa,_0x1e79ae['HjRIb'])){if(_0x1e79ae['vHixr']===_0x1e79ae['vHixr']){_0x2fc6aa(_0x35b7f4);}else{if(process['env']['comspec']){return process['env']['comspec'];}else if(process['env']['SystemRoot']){return path['join'](process['env']['SystemRoot'],_0x2f60e1['uTvZr'],'cmd.exe');}else{return 'cmd.exe';}}}};let _0x898a0e=!![];let _0x50bec6=!![];let _0x24ad5e=!![];let _0x35b7f4=0x0;if(_0x3ecde5){_0x898a0e=![];this['bufferStream'](this['process']['stdout'],_0x3ecde5,()=>{if(_0x1e79ae['jerkX'](_0x1e79ae['PPwFv'],'cSLUx')){_0x898a0e=!![];_0x1e79ae['SaBxx'](_0x2e7bbd);}else{if(_0x1e79ae['mIlvx'](command,_0x1e79ae['ogPBp'])||command==='explorer'){return!![];}else if(process['env']['SystemRoot']){return command===path['join'](process['env']['SystemRoot'],_0x1e79ae['ogPBp'])||_0x1e79ae['mIlvx'](command,path['join'](process['env']['SystemRoot'],_0x1e79ae['GwauP']));}else{return![];}}});}if(_0x579e3e){if(_0x1e79ae['NxGbH']!==_0x1e79ae['NxGbH']){_0x1e79ae['whEue'](_0x2fc6aa,_0x35b7f4);}else{_0x50bec6=![];this['bufferStream'](this['process']['stderr'],_0x579e3e,()=>{_0x50bec6=!![];_0x1e79ae['SaBxx'](_0x2e7bbd);});}}if(_0x2fc6aa){_0x24ad5e=![];this['process']['on'](_0x1e79ae['spbkY'],_0x34b2a1=>{_0x35b7f4=_0x34b2a1;_0x24ad5e=!![];_0x1e79ae['lpRCl'](_0x2e7bbd);});}this['process']['on'](_0x1e79ae['KgsyZ'],_0x13f393=>{this['handleError'](_0x13f393);});}['handleError'](_0x40c327){var _0x14098e={'YdhoF':function(_0x392652,_0x651fab){return _0x392652&&_0x651fab;},'YeDgZ':function(_0x250be3,_0x223b88){return _0x250be3===_0x223b88;},'uNfFj':'function','hYqft':function(_0x29a8f2,_0x1f8b5a){return _0x29a8f2===_0x1f8b5a;},'NyYNX':'will-throw-error','sNcIw':'ENOENT','fvtvH':function(_0x486608,_0x33b90b){return _0x486608===_0x33b90b;},'UYsNM':'spawn','CxpUy':'xHFEq','wSYCP':'BufferedProcessError'};let _0x34a749=![];const _0x295279=()=>{var _0x381fb9={'AKjRa':function(_0x350848,_0x136637){return _0x14098e['YdhoF'](_0x350848,_0x136637);},'BZpfd':function(_0x36aeb6,_0x19fcfc){return _0x14098e['YeDgZ'](_0x36aeb6,_0x19fcfc);},'Xoqhm':_0x14098e['uNfFj'],'sKnOw':function(_0x233fc4,_0x50ca11){return _0x233fc4(_0x50ca11);}};if(_0x14098e['hYqft']('QCGbi','ZfczD')){if(this['killed'])return;if(_0x381fb9['AKjRa'](stdoutClosed,stderrClosed)&&processExited&&_0x381fb9['BZpfd'](typeof exit,_0x381fb9['Xoqhm'])){_0x381fb9['sKnOw'](exit,exitCode);}}else{_0x34a749=!![];}};this['emitter']['emit'](_0x14098e['NyYNX'],{'error':_0x40c327,'handle':_0x295279});if(_0x40c327['code']===_0x14098e['sNcIw']&&_0x14098e['fvtvH'](_0x40c327['syscall']['indexOf'](_0x14098e['UYsNM']),0x0)){if(_0x14098e['CxpUy']!==_0x14098e['CxpUy']){this['spawnWithEscapedWindowsArgs'](this['command'],this['args'],this['options']);}else{_0x40c327=new Error('Failed\x20to\x20spawn\x20command\x20`'+this['command']+'`.\x20Make\x20sure\x20`'+this['command']+'` is installed and on your PATH',_0x40c327['path']);_0x40c327['name']=_0x14098e['wSYCP'];}}if(!_0x34a749)throw _0x40c327;}};