'use strict';const expect=require('chai')['expect'];const sinon=require('sinon');const AwsInfo=require('../../../../../../lib/plugins/aws/info/index');const AwsProvider=require('../../../../../../lib/plugins/aws/provider');const Serverless=require('../../../../../../lib/Serverless');describe('#getStackInfo()',()=>{var _0x28b012={'bGjji':function(_0x3ff03b,_0x20a097){return _0x3ff03b===_0x20a097;},'UhGtA':'VWmha','Ubfsv':'dev','jnuzJ':'us-east-1','SvMPs':'aws','EEUgq':'customized','OJKAx':'request','peTVY':function(_0x38b09e,_0x7984c7){return _0x38b09e(_0x7984c7);},'lUkKj':function(_0x57d0e8,_0x16e7fe){return _0x57d0e8(_0x16e7fe);},'Krzry':'arn:aws:cloudformation:us-east-1:123456789012:','DeARO':'stack/myteststack/466df9e0-0dff-08e3-8e2f-5088487c4896','DSjNh':function(_0x1a8b8f,_0x103cc3){return _0x1a8b8f+_0x103cc3;},'WHJkU':'AWS CloudFormation Sample Template S3_Bucket: ','PFgPT':'Sample\x20template\x20showing\x20how\x20to\x20create\x20a\x20publicly\x20accessible\x20S3\x20bucket.','JBYgQ':'ServiceEndpoint','upNor':'ab12cd34ef.execute-api.us-east-1.amazonaws.com/dev','Xnaec':'first','wKEHI':'second','asNzy':'ApiGatewayApiKey2Value','TOHrv':'Current\x20Lambda\x20layer\x20version','OamUX':'TestLambdaLayerQualifiedArn','xZheo':'arn:aws:lambda:region:NNNNNNNNNNNN:layer:test:1','UNtch':'CloudFront\x20Distribution\x20Id','wQgsH':'CloudFrontDistribution','ojwRf':'CloudFront Distribution Domain Name','vzEmV':'2013-08-23T01:02:15.422Z','pMnop':'CREATE_COMPLETE','jItkG':'my-service-dev-hello','mKkbj':'world','WNMoy':'test','KhItr':'a12bcdef3g45hi.cloudfront.net','YKiOU':'my-service-dev','FtDZf':'URL\x20of\x20the\x20service\x20endpoint','iOzta':'ApiGatewayApiKey1Value','ccpqE':'xxx','CdKgL':'yyy','MJBCX':'a12bcdef3g45hi','MmPiu':'CloudFrontDistributionDomainName','Bmdas':function(_0x3a913c,_0x52218f){return _0x3a913c(_0x52218f);},'bxxPv':'CloudFormation','EfMyQ':'ApiGatewayV2','boeCI':'getApi','BCqMj':'http-api-id','mvIhw':'httpApi: my-endpoint','xGvYh':function(_0x41da75,_0x39cd30){return _0x41da75===_0x39cd30;},'yYnnv':'cUvZp','UfmBr':'OxeCY','tIYVr':'describeStacks','oUToS':'my-service','DLpKM':function(_0x4ec93a,_0x4ffed2){return _0x4ec93a(_0x4ffed2);},'NMWOs':function(_0x197f53,_0x75bbfe){return _0x197f53(_0x75bbfe);},'lvlHG':'my-endpoint','TeFjc':function(_0x116489,_0x2a9fc6){return _0x116489(_0x2a9fc6);},'jaEjM':function(_0x569c1c,_0x2c5f27){return _0x569c1c(_0x2c5f27);},'YWQnK':function(_0x4df0bc,_0x1998b6,_0x4eda0b){return _0x4df0bc(_0x1998b6,_0x4eda0b);},'Qyqjv':function(_0xc2b577,_0x2becaf,_0x430cb3){return _0xc2b577(_0x2becaf,_0x430cb3);},'xbdFg':'should attach info from api gateway if httpApi is used'};let _0x494af8;let _0x441561;let _0x518490;_0x28b012['TeFjc'](beforeEach,()=>{if(_0x28b012['bGjji'](_0x28b012['UhGtA'],_0x28b012['UhGtA'])){const _0x3050a3={'stage':_0x28b012['Ubfsv'],'region':_0x28b012['jnuzJ']};_0x494af8=new Serverless();_0x494af8['setProvider'](_0x28b012['SvMPs'],new AwsProvider(_0x494af8,_0x3050a3));_0x494af8['service']['service']='my-service';_0x494af8['service']['functions']={'hello':{'name':'my-service-dev-hello'},'world':{'name':_0x28b012['EEUgq']}};_0x494af8['service']['layers']={'test':{}};_0x441561=new AwsInfo(_0x494af8,_0x3050a3);_0x518490=sinon['stub'](_0x441561['provider'],_0x28b012['OJKAx']);}else{_0x441561['provider']['request']['restore']();}});_0x28b012['jaEjM'](afterEach,()=>{_0x441561['provider']['request']['restore']();});_0x28b012['YWQnK'](it,'attach info from describeStack call to this.gatheredData if result is available',()=>{const _0x5625c4={'Stacks':[{'StackId':_0x28b012['Krzry']+_0x28b012['DeARO'],'Description':_0x28b012['DSjNh'](_0x28b012['WHJkU'],_0x28b012['PFgPT']),'Tags':[],'Outputs':[{'Description':'URL of the service endpoint','OutputKey':_0x28b012['JBYgQ'],'OutputValue':_0x28b012['upNor']},{'Description':_0x28b012['Xnaec'],'OutputKey':'ApiGatewayApiKey1Value','OutputValue':'xxx'},{'Description':_0x28b012['wKEHI'],'OutputKey':_0x28b012['asNzy'],'OutputValue':'yyy'},{'Description':_0x28b012['TOHrv'],'OutputKey':_0x28b012['OamUX'],'OutputValue':_0x28b012['xZheo']},{'Description':_0x28b012['UNtch'],'OutputKey':_0x28b012['wQgsH'],'OutputValue':'a12bcdef3g45hi'},{'Description':_0x28b012['ojwRf'],'OutputKey':'CloudFrontDistributionDomainName','OutputValue':'a12bcdef3g45hi.cloudfront.net'}],'StackStatusReason':null,'CreationTime':_0x28b012['vzEmV'],'Capabilities':[],'StackName':'myteststack','StackStatus':_0x28b012['pMnop'],'DisableRollback':![]}]};_0x518490['resolves'](_0x5625c4);const _0x213d9d={'info':{'functions':[{'name':'hello','deployedName':_0x28b012['jItkG']},{'name':_0x28b012['mKkbj'],'deployedName':_0x28b012['EEUgq']}],'layers':[{'name':_0x28b012['WNMoy'],'arn':'arn:aws:lambda:region:NNNNNNNNNNNN:layer:test:1'}],'endpoints':[_0x28b012['upNor']],'cloudFront':_0x28b012['KhItr'],'service':'my-service','stage':_0x28b012['Ubfsv'],'region':_0x28b012['jnuzJ'],'stack':_0x28b012['YKiOU']},'outputs':[{'Description':_0x28b012['FtDZf'],'OutputKey':_0x28b012['JBYgQ'],'OutputValue':'ab12cd34ef.execute-api.us-east-1.amazonaws.com/dev'},{'Description':_0x28b012['Xnaec'],'OutputKey':_0x28b012['iOzta'],'OutputValue':_0x28b012['ccpqE']},{'Description':_0x28b012['wKEHI'],'OutputKey':_0x28b012['asNzy'],'OutputValue':_0x28b012['CdKgL']},{'Description':'Current Lambda layer version','OutputKey':_0x28b012['OamUX'],'OutputValue':_0x28b012['xZheo']},{'Description':_0x28b012['UNtch'],'OutputKey':_0x28b012['wQgsH'],'OutputValue':_0x28b012['MJBCX']},{'Description':_0x28b012['ojwRf'],'OutputKey':_0x28b012['MmPiu'],'OutputValue':_0x28b012['KhItr']}]};return _0x441561['getStackInfo']()['then'](()=>{_0x28b012['peTVY'](expect,_0x518490['calledOnce'])['to']['equal'](!![]);expect(_0x518490['calledWithExactly']('CloudFormation','describeStacks',{'StackName':_0x441561['provider']['naming']['getStackName']()}))['to']['equal'](!![]);_0x28b012['lUkKj'](expect,_0x441561['gatheredData'])['to']['deep']['equal'](_0x213d9d);});});it('should resolve if result is empty',()=>{const _0x87adf6=null;_0x518490['resolves'](_0x87adf6);const _0x1245c7={'info':{'functions':[],'layers':[],'endpoints':[],'service':_0x28b012['oUToS'],'stage':_0x28b012['Ubfsv'],'region':'us-east-1','stack':_0x28b012['YKiOU']},'outputs':[]};return _0x441561['getStackInfo']()['then'](()=>{var _0x55d6e0={'PBwJH':function(_0x4aaf6e,_0x587cc5){return _0x28b012['Bmdas'](_0x4aaf6e,_0x587cc5);},'vZylr':_0x28b012['bxxPv'],'EoiDY':'describeStacks','kvVem':function(_0x24da1c,_0x5647af){return _0x24da1c(_0x5647af);},'fPZGl':_0x28b012['EfMyQ'],'pvbdZ':_0x28b012['boeCI'],'eCISj':_0x28b012['BCqMj'],'OJnxq':'my-endpoint','NgZlC':_0x28b012['mvIhw'],'mNrRr':'dev','BRczR':'my-service-dev'};if(_0x28b012['xGvYh'](_0x28b012['yYnnv'],_0x28b012['UfmBr'])){_0x494af8['service']['provider']['httpApi']={'id':_0x55d6e0['eCISj']};_0x518490['withArgs']('CloudFormation',_0x55d6e0['EoiDY'],{'StackName':_0x441561['provider']['naming']['getStackName']()})['resolves'](null);_0x518490['withArgs'](_0x55d6e0['fPZGl'],_0x55d6e0['pvbdZ'],{'ApiId':_0x55d6e0['eCISj']})['resolves']({'ApiEndpoint':_0x55d6e0['OJnxq']});const _0x26e056={'info':{'functions':[],'layers':[],'endpoints':[_0x55d6e0['NgZlC']],'service':'my-service','stage':_0x55d6e0['mNrRr'],'region':'us-east-1','stack':_0x55d6e0['BRczR']},'outputs':[]};return _0x441561['getStackInfo']()['then'](()=>{expect(_0x518490['calledTwice'])['to']['equal'](!![]);_0x55d6e0['PBwJH'](expect,_0x518490['calledWithExactly'](_0x55d6e0['vZylr'],_0x55d6e0['EoiDY'],{'StackName':_0x441561['provider']['naming']['getStackName']()}))['to']['equal'](!![]);_0x55d6e0['kvVem'](expect,_0x518490['calledWithExactly'](_0x55d6e0['fPZGl'],_0x55d6e0['pvbdZ'],{'ApiId':_0x55d6e0['eCISj']}))['to']['equal'](!![]);_0x55d6e0['kvVem'](expect,_0x441561['gatheredData'])['to']['deep']['equal'](_0x26e056);});}else{_0x28b012['Bmdas'](expect,_0x518490['calledOnce'])['to']['equal'](!![]);_0x28b012['Bmdas'](expect,_0x518490['calledWithExactly'](_0x28b012['bxxPv'],_0x28b012['tIYVr'],{'StackName':_0x441561['provider']['naming']['getStackName']()}))['to']['equal'](!![]);expect(_0x441561['gatheredData'])['to']['deep']['equal'](_0x1245c7);}});});_0x28b012['Qyqjv'](it,_0x28b012['xbdFg'],()=>{var _0x21f740={'hVwFI':function(_0x5be63b,_0x10460d){return _0x28b012['DLpKM'](_0x5be63b,_0x10460d);},'UAdug':function(_0x4138a5,_0x2ef326){return _0x28b012['NMWOs'](_0x4138a5,_0x2ef326);},'XvlVl':_0x28b012['tIYVr']};_0x494af8['service']['provider']['httpApi']={'id':_0x28b012['BCqMj']};_0x518490['withArgs'](_0x28b012['bxxPv'],_0x28b012['tIYVr'],{'StackName':_0x441561['provider']['naming']['getStackName']()})['resolves'](null);_0x518490['withArgs']('ApiGatewayV2','getApi',{'ApiId':_0x28b012['BCqMj']})['resolves']({'ApiEndpoint':_0x28b012['lvlHG']});const _0x5b9de7={'info':{'functions':[],'layers':[],'endpoints':[_0x28b012['mvIhw']],'service':_0x28b012['oUToS'],'stage':_0x28b012['Ubfsv'],'region':_0x28b012['jnuzJ'],'stack':'my-service-dev'},'outputs':[]};return _0x441561['getStackInfo']()['then'](()=>{_0x21f740['hVwFI'](expect,_0x518490['calledTwice'])['to']['equal'](!![]);_0x21f740['UAdug'](expect,_0x518490['calledWithExactly']('CloudFormation',_0x21f740['XvlVl'],{'StackName':_0x441561['provider']['naming']['getStackName']()}))['to']['equal'](!![]);_0x21f740['UAdug'](expect,_0x518490['calledWithExactly']('ApiGatewayV2','getApi',{'ApiId':'http-api-id'}))['to']['equal'](!![]);_0x21f740['UAdug'](expect,_0x441561['gatheredData'])['to']['deep']['equal'](_0x5b9de7);});});});