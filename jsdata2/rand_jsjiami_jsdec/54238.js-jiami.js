'use strict';const common=require('../common');if(!common['hasCrypto'])common['skip']('missing crypto');const assert=require('assert');const tls=require('tls');const CIPHERS='PSK+HIGH:TLS_AES_128_GCM_SHA256';const USERS={'UserA':Buffer['allocUnsafe'](0x80),'UserB':Buffer['from']('82072606b502b0f4025e90eb75fe137d','hex')};const TEST_DATA='x';const serverOptions={'ciphers':CIPHERS,'pskCallback'(_0x352329,_0x2bd186){var _0x1a654e={'Qukgf':function(_0x36a370,_0x32c2ce){return _0x36a370 instanceof _0x32c2ce;},'OMgGz':function(_0x3fe616,_0x2116b1){return _0x3fe616===_0x2116b1;},'buqAX':'string'};assert['ok'](_0x1a654e['Qukgf'](_0x352329,tls['TLSSocket']));assert['ok'](_0x1a654e['OMgGz'](typeof _0x2bd186,_0x1a654e['buqAX']));return USERS[_0x2bd186];}};function test(_0x5dc976,_0x3870c0,_0x1da0d1){var _0x7953b4={'lDbNp':'close','HKeJH':'error','ZkeBc':function(_0xb3cad8,_0x2050c1){return _0xb3cad8===_0x2050c1;},'eOgWC':'Xriar','GvVkB':'data','rqCmQ':function(_0x2e163f,_0x30d74c){return _0x2e163f!==_0x30d74c;},'Yptsx':'kdgZT'};const _0xb05aa6=!_0x1da0d1?common['mustCall'](_0x3e6352=>{_0x3e6352['pipe'](_0x3e6352);}):common['mustNotCall']();const _0x56373b=tls['createServer'](serverOptions,_0xb05aa6);_0x56373b['listen'](0x0,common['mustCall'](()=>{var _0x3d0afc={'MrLBo':_0x7953b4['HKeJH'],'wfRWt':function(_0x11d815,_0x17bce2){return _0x7953b4['ZkeBc'](_0x11d815,_0x17bce2);},'xZmxN':_0x7953b4['eOgWC'],'mSXes':_0x7953b4['GvVkB']};if(_0x7953b4['rqCmQ'](_0x7953b4['Yptsx'],_0x7953b4['Yptsx'])){var _0x539e19={'oNHMO':_0x7953b4['lDbNp']};const _0x5ccbf1=tls['connect'](options,common['mustCall'](()=>{_0x5ccbf1['end'](TEST_DATA);_0x5ccbf1['on']('data',common['mustCall'](_0x1b8ef2=>{assert['strictEqual'](_0x1b8ef2['toString'](),TEST_DATA);}));_0x5ccbf1['on'](_0x539e19['oNHMO'],common['mustCall'](()=>_0x56373b['close']()));}));}else{const _0x3eff20={'port':_0x56373b['address']()['port'],'ciphers':CIPHERS,'checkServerIdentity':()=>{},'pskCallback':common['mustCall'](()=>_0x5dc976),..._0x3870c0};if(!_0x1da0d1){const _0x2b09ba=tls['connect'](_0x3eff20,common['mustCall'](()=>{var _0x11be6a={'jEBOI':_0x3d0afc['MrLBo']};if(_0x3d0afc['wfRWt']('BLVFh',_0x3d0afc['xZmxN'])){const _0xfa0820=tls['connect'](_0x3eff20,common['mustNotCall']());_0xfa0820['on'](_0x11be6a['jEBOI'],common['mustCall'](_0x3a49e9=>{assert['strictEqual'](_0x3a49e9['message'],_0x1da0d1);_0x56373b['close']();}));}else{_0x2b09ba['end'](TEST_DATA);_0x2b09ba['on'](_0x3d0afc['mSXes'],common['mustCall'](_0x903c85=>{assert['strictEqual'](_0x903c85['toString'](),TEST_DATA);}));_0x2b09ba['on']('close',common['mustCall'](()=>_0x56373b['close']()));}}));}else{const _0xf73d9a=tls['connect'](_0x3eff20,common['mustNotCall']());_0xf73d9a['on']('error',common['mustCall'](_0xf5b129=>{assert['strictEqual'](_0xf5b129['message'],_0x1da0d1);_0x56373b['close']();}));}}}));}const DISCONNECT_MESSAGE='Client\x20network\x20socket\x20disconnected\x20before\x20'+'secure TLS connection was established';test({'psk':USERS['UserA'],'identity':'UserA'});test({'psk':USERS['UserA'],'identity':'UserA'},{'maxVersion':'TLSv1.2'});test({'psk':USERS['UserA'],'identity':'UserA'},{'minVersion':'TLSv1.3'});test({'psk':USERS['UserB'],'identity':'UserB'});test({'psk':USERS['UserB'],'identity':'UserB'},{'minVersion':'TLSv1.3'});test({'psk':USERS['UserB'],'identity':'UserC'},{},DISCONNECT_MESSAGE);test({'psk':USERS['UserA'],'identity':'UserB'},{},DISCONNECT_MESSAGE);test({'psk':USERS['UserB'],'identity':'UserB'});