import{$appendChild,$getChildrenByClass,$getChildrenByName,$getParent,$namespaceId,XFAObject,XFAObjectArray,XmlObject}from'./xfa_object.js';import{warn}from'../../shared/util.js';const namePattern=/^[^.[]+/;const indexPattern=/^[^\]]+/;const operators={'dot':0x0,'dotDot':0x1,'dotHash':0x2,'dotBracket':0x3,'dotParen':0x4};const shortcuts=new Map([['$data',(root,current)=>root['datasets']['data']],['$template',(root,current)=>root['template']],['$connectionSet',(root,current)=>root['connectionSet']],['$form',(root,current)=>root['form']],['$layout',(root,current)=>root['layout']],['$host',(root,current)=>root['host']],['$dataWindow',(root,current)=>root['dataWindow']],['$event',(root,current)=>root['event']],['!',(root,current)=>root['datasets']],['$xfa',(root,current)=>root],['xfa',(root,current)=>root],['$',(root,current)=>current]]);const somCache=new WeakMap();function parseIndex(index){var zOZrdz={'qVUkP':function(x,y){return x!==y;},'qMkvh':'wkfZR'};index=index['trim']();if(index==='*'){if(zOZrdz['qVUkP']('wkfZR',zOZrdz['qMkvh'])){cached=new Map();somCache['set'](node,cached);}else{return Infinity;}}return parseInt(index,0xa)||0x0;}function parseExpression(expr,dotDotAllowed,noExpr=!![]){var PgzteZ={'gLkGS':function(callee,param1,param2){return callee(param1,param2);},'SSdiY':function(x,y){return x||y;},'nSTdX':function(callee,param1){return callee(param1);},'OijWz':function(x,y){return x+y;},'rAjog':function(x,y){return x<y;},'vmtVr':function(x,y){return x===y;},'USvZx':'GDteh','Kmfmu':function(x,y){return x+y;},'tOTHU':function(x,y){return x===y;},'RHTyp':'GoCYd','fyytN':'qbecB','hMiWG':'XFA - SOM expression contains a FormCalc subexpression which is not supported for now.','KneBo':'XFA - SOM expression contains a JavaScript subexpression which is not supported for now.','GnZVv':function(x,y){return x===y;},'dQmYN':'fuekv','paPXm':'xPfrF'};let match=expr['match'](namePattern);if(!match){return null;}let [name]=match;const parsed=[{'name':name,'cacheName':PgzteZ['OijWz']('.',name),'index':0x0,'js':null,'formCalc':null,'operator':operators['dot']}];let pos=name['length'];while(PgzteZ['rAjog'](pos,expr['length'])){const spos=pos;const char=expr['charAt'](pos++);if(PgzteZ['vmtVr'](char,'[')){match=expr['slice'](pos)['match'](indexPattern);if(!match){if(PgzteZ['USvZx']!==PgzteZ['USvZx']){isQualified=!![];root=[PgzteZ['gLkGS'](fn,root,container)];i=0x1;}else{PgzteZ['nSTdX'](warn,'XFA - Invalid index in SOM expression');return null;}}parsed[parsed['length']-0x1]['index']=parseIndex(match[0x0]);pos+=PgzteZ['Kmfmu'](match[0x0]['length'],0x1);continue;}let operator;switch(expr['charAt'](pos)){case'.':if(!dotDotAllowed){if(PgzteZ['tOTHU'](PgzteZ['RHTyp'],PgzteZ['RHTyp'])){return null;}else{children=children['children'];}}pos++;operator=operators['dotDot'];break;case'#':pos++;operator=operators['dotHash'];break;case'[':if(noExpr){if(PgzteZ['fyytN']==='YFYSs'){root=PgzteZ['SSdiY'](container,root);}else{PgzteZ['nSTdX'](warn,PgzteZ['hMiWG']);return null;}}operator=operators['dotBracket'];break;case'(':if(noExpr){PgzteZ['nSTdX'](warn,PgzteZ['KneBo']);return null;}operator=operators['dotParen'];break;default:operator=operators['dot'];break;}match=expr['slice'](pos)['match'](namePattern);if(!match){if(PgzteZ['GnZVv'](PgzteZ['dQmYN'],PgzteZ['paPXm'])){PgzteZ['nSTdX'](warn,'XFA - Cannot create a node.');return null;}else{break;}}[name]=match;pos+=name['length'];parsed['push']({'name':name,'cacheName':expr['slice'](spos,pos),'operator':operator,'index':0x0,'js':null,'formCalc':null});}return parsed;}function searchNode(root,container,expr,dotDotAllowed=!![],useCache=!![]){var MfpDOl={'jupqe':function(callee,param1,param2){return callee(param1,param2);},'LpFHf':function(x,y){return x===y;},'tZnrJ':function(x,y){return x||y;},'YoSOD':function(x,y){return x===y;},'mhNWH':'OeLTb','gTGUZ':function(x,y){return x instanceof y;},'nstPv':function(x,y){return x!==y;},'OzaxP':'ptDsZ','Nkrrs':function(x,y){return x===y;},'ienjW':'xATAn','AwbXI':'dccNY','OIWTx':function(x,y){return x===y;},'jStOk':'bOgRP','jWDnW':'slirv','TenUw':function(callee,param1){return callee(param1);}};const parsed=MfpDOl['jupqe'](parseExpression,expr,dotDotAllowed);if(!parsed){return null;}const fn=shortcuts['get'](parsed[0x0]['name']);let i=0x0;let isQualified;if(fn){isQualified=!![];root=[fn(root,container)];i=0x1;}else{isQualified=MfpDOl['LpFHf'](container,null);root=[MfpDOl['tZnrJ'](container,root)];}for(let ii=parsed['length'];i<ii;i++){const {name,cacheName,operator,index}=parsed[i];const nodes=[];for(const node of root){if(MfpDOl['YoSOD'](MfpDOl['mhNWH'],'oFdLT')){return createNodes(root,parsed['slice'](i));}else{if(!MfpDOl['gTGUZ'](node,XFAObject)){if(MfpDOl['nstPv']('XRktR',MfpDOl['OzaxP'])){continue;}else{return null;}}let children,cached;if(useCache){if(MfpDOl['Nkrrs']('XbBQT','cHRyi')){return null;}else{cached=somCache['get'](node);if(!cached){cached=new Map();somCache['set'](node,cached);}children=cached['get'](cacheName);}}if(!children){switch(operator){case operators['dot']:children=node[$getChildrenByName](name,![]);break;case operators['dotDot']:children=node[$getChildrenByName](name,!![]);break;case operators['dotHash']:children=node[$getChildrenByClass](name);if(MfpDOl['gTGUZ'](children,XFAObjectArray)){children=children['children'];}else{if(MfpDOl['ienjW']==='xATAn'){children=[children];}else{return null;}}break;default:break;}if(useCache){if(MfpDOl['Nkrrs'](MfpDOl['AwbXI'],'dccNY')){cached['set'](cacheName,children);}else{return Infinity;}}}if(children['length']>0x0){nodes['push'](children);}}}if(nodes['length']===0x0&&!isQualified&&MfpDOl['OIWTx'](i,0x0)){if(MfpDOl['OIWTx']('bOgRP',MfpDOl['jStOk'])){const parent=container[$getParent]();container=parent;if(!container){if(MfpDOl['OIWTx'](MfpDOl['jWDnW'],MfpDOl['jWDnW'])){return null;}else{children=children['children'];}}i=-0x1;root=[container];continue;}else{cached['set'](cacheName,children);}}if(MfpDOl['TenUw'](isFinite,index)){root=nodes['filter'](node=>index<node['length'])['map'](node=>node[index]);}else{root=nodes['reduce']((acc,node)=>acc['concat'](node),[]);}}if(MfpDOl['OIWTx'](root['length'],0x0)){return null;}return root;}function createNodes(root,path){var hQrtBm={'UQZsQ':function(callee,param1,param2){return callee(param1,param2);},'GnSdz':function(callee,param1){return callee(param1);},'kPONR':function(x,y){return x<=y;},'ABdfE':function(x,y){return x!==y;},'FNZbU':'nvvDO'};let node=null;for(const {name,index}of path){for(let i=0x0,ii=!hQrtBm['GnSdz'](isFinite,index)?0x0:index;hQrtBm['kPONR'](i,ii);i++){if(hQrtBm['ABdfE']('cgOmW',hQrtBm['FNZbU'])){node=new XmlObject(root[$namespaceId],name);root[$appendChild](node);}else{root=hQrtBm['UQZsQ'](fn,root,container);i=0x1;}}root=node;}return node;}function createDataNode(root,container,expr){var MxNdiN={'kMNIU':function(callee,param1,param2){return callee(param1,param2);},'ATKIW':function(callee,param1){return callee(param1);},'yAWzI':'XFA - SOM expression contains a JavaScript subexpression which is not supported for now.','lIruq':function(callee,param1,param2){return callee(param1,param2);},'GyNTg':'MDSqz','vNgSv':function(x,y){return x!==y;},'UPQRp':'gpFMg','ShUxT':function(x,y){return x<y;},'AQdfc':function(callee,param1,param2){return callee(param1,param2);},'eGvJC':function(x,y){return x instanceof y;},'iwGJP':function(x,y){return x===y;},'llDQr':'BMVIl','FrQOw':'pROWX','lEYoK':function(x,y){return x<y;},'tDMho':function(x,y){return x instanceof y;},'xcIbl':function(x,y){return x!==y;},'wOnUj':'SQBML','WJdHv':'wEiTH','vQMVY':function(x,y){return x-y;}};const parsed=MxNdiN['ATKIW'](parseExpression,expr);if(!parsed){if(MxNdiN['GyNTg']==='MDSqz'){return null;}else{parsed[i]['index']=0x0;return MxNdiN['kMNIU'](createNodes,root,parsed['slice'](i));}}if(parsed['some'](x=>x['operator']===operators['dotDot'])){if(MxNdiN['vNgSv'](MxNdiN['UPQRp'],'LKsqP')){return null;}else{MxNdiN['ATKIW'](warn,MxNdiN['yAWzI']);return null;}}const fn=shortcuts['get'](parsed[0x0]['name']);let i=0x0;if(fn){root=fn(root,container);i=0x1;}else{if('jXOWD'==='jXOWD'){root=container||root;}else{children=[children];}}for(let ii=parsed['length'];MxNdiN['ShUxT'](i,ii);i++){const {name,operator,index}=parsed[i];if(!MxNdiN['ATKIW'](isFinite,index)){parsed[i]['index']=0x0;return MxNdiN['AQdfc'](createNodes,root,parsed['slice'](i));}let children;switch(operator){case operators['dot']:children=root[$getChildrenByName](name,![]);break;case operators['dotDot']:children=root[$getChildrenByName](name,!![]);break;case operators['dotHash']:children=root[$getChildrenByClass](name);if(MxNdiN['eGvJC'](children,XFAObjectArray)){if(MxNdiN['iwGJP'](MxNdiN['llDQr'],MxNdiN['llDQr'])){children=children['children'];}else{cached=somCache['get'](node);if(!cached){cached=new Map();somCache['set'](node,cached);}children=cached['get'](cacheName);}}else{if(MxNdiN['iwGJP']('pROWX',MxNdiN['FrQOw'])){children=[children];}else{index=index['trim']();if(index==='*'){return Infinity;}return MxNdiN['lIruq'](parseInt,index,0xa)||0x0;}}break;default:break;}if(children['length']===0x0){return MxNdiN['AQdfc'](createNodes,root,parsed['slice'](i));}if(MxNdiN['lEYoK'](index,children['length'])){const child=children[index];if(!MxNdiN['tDMho'](child,XFAObject)){if(MxNdiN['xcIbl'](MxNdiN['wOnUj'],MxNdiN['wOnUj'])){root=nodes['filter'](_0x501e82=>index<_0x501e82['length'])['map'](_0x5b6c40=>_0x5b6c40[index]);}else{MxNdiN['ATKIW'](warn,'XFA\x20-\x20Cannot\x20create\x20a\x20node.');return null;}}root=child;}else{if(MxNdiN['WJdHv']==='CARnR'){node=new XmlObject(root[$namespaceId],name);root[$appendChild](node);}else{parsed[i]['index']=MxNdiN['vQMVY'](index,children['length']);return MxNdiN['AQdfc'](createNodes,root,parsed['slice'](i));}}}return null;}export{createDataNode,searchNode};