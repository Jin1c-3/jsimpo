'use strict';const expect=require('chai')['expect'];const AwsCompileWebsocketsEvents=require('../../../../../../../../../../lib/plugins/aws/package/compile/events/websockets/index');const Serverless=require('../../../../../../../../../../lib/Serverless');const AwsProvider=require('../../../../../../../../../../lib/plugins/aws/provider');const runServerless=require('../../../../../../../../../utils/run-serverless');describe('#validate()',()=>{var _0x36a2c7={'WJDQt':'us-east-1','MSQFk':'$connect','aEDgs':function(_0x103d3b,_0x4606bf){return _0x103d3b(_0x4606bf);},'oiKRE':'first','NwYXX':'auth','wjcEZ':'arn:','bkZPg':':apigateway:','vxBlb':'AWS::Region','xeTSp':':lambda:path/2015-03-31/functions/','RmBme':'/invocations','aoCPQ':'route.request.header.Auth','qQQnf':'arn:aws:auth','eivYk':'AWS::Partition','pbLqK':'route.request.querystring.Auth','dAPQp':'AuthLambdaFunction','aTfkl':function(_0x5c8747,_0x105685){return _0x5c8747(_0x105685);},'RkPpE':'$default','qtdto':function(_0x2b5d86,_0x5ae1b4){return _0x2b5d86(_0x5ae1b4);},'wThkR':function(_0x53848a,_0x2bdce5){return _0x53848a(_0x2bdce5);},'eBIxa':function(_0x39fd38,_0x973f95,_0x55d498){return _0x39fd38(_0x973f95,_0x55d498);},'knsaz':'should support the simplified string syntax','dngXU':function(_0x304073,_0x2cc196,_0x7a643b){return _0x304073(_0x2cc196,_0x7a643b);},'EcsJB':'should support the extended object syntax','SymsN':'should add authorizer config when authorizer is specified as a string','riXgX':function(_0x15ad91,_0x20b3dd,_0x5ebfe8){return _0x15ad91(_0x20b3dd,_0x5ebfe8);},'YwXIM':'should add authorizer config when authorizer is specified as a string with arn','zPxrY':'should add authorizer config when authorizer is specified as an object','dWPNy':'should\x20add\x20authorizer\x20config\x20when\x20authorizer\x20is\x20specified\x20as\x20an\x20object\x20with\x20arn','EIsEp':function(_0x35ac76,_0x2a0990,_0x2d7c8b){return _0x35ac76(_0x2a0990,_0x2d7c8b);},'CKnbi':function(_0x4d8812,_0x2aed18,_0x48c9ef){return _0x4d8812(_0x2aed18,_0x48c9ef);},'otNyO':'should ignore non-websocket events'};let _0x3fed4f;let _0x2c06a4;_0x36a2c7['wThkR'](beforeEach,()=>{const _0x205059={'stage':'dev','region':_0x36a2c7['WJDQt']};_0x3fed4f=new Serverless();_0x3fed4f['setProvider']('aws',new AwsProvider(_0x3fed4f,_0x205059));_0x2c06a4=new AwsCompileWebsocketsEvents(_0x3fed4f,_0x205059);});_0x36a2c7['eBIxa'](it,_0x36a2c7['knsaz'],()=>{_0x2c06a4['serverless']['service']['functions']={'first':{'events':[{'websocket':_0x36a2c7['MSQFk']}]}};const _0x4cf347=_0x2c06a4['validate']();_0x36a2c7['aEDgs'](expect,_0x4cf347['events'])['to']['deep']['equal']([{'functionName':_0x36a2c7['oiKRE'],'route':_0x36a2c7['MSQFk']}]);});_0x36a2c7['dngXU'](it,_0x36a2c7['EcsJB'],()=>{_0x2c06a4['serverless']['service']['functions']={'first':{'events':[{'websocket':{'route':'$connect'}}]}};const _0x4e904c=_0x2c06a4['validate']();_0x36a2c7['aEDgs'](expect,_0x4e904c['events'])['to']['deep']['equal']([{'functionName':_0x36a2c7['oiKRE'],'route':_0x36a2c7['MSQFk']}]);});it(_0x36a2c7['SymsN'],()=>{_0x2c06a4['serverless']['service']['functions']={'first':{'events':[{'websocket':{'route':_0x36a2c7['MSQFk'],'authorizer':_0x36a2c7['NwYXX']}}]}};const _0x389d2a=_0x2c06a4['validate']();expect(_0x389d2a['events'])['to']['deep']['equal']([{'functionName':_0x36a2c7['oiKRE'],'route':_0x36a2c7['MSQFk'],'authorizer':{'name':_0x36a2c7['NwYXX'],'uri':{'Fn::Join':['',[_0x36a2c7['wjcEZ'],{'Ref':'AWS::Partition'},_0x36a2c7['bkZPg'],{'Ref':_0x36a2c7['vxBlb']},_0x36a2c7['xeTSp'],{'Fn::GetAtt':['AuthLambdaFunction','Arn']},_0x36a2c7['RmBme']]]},'identitySource':[_0x36a2c7['aoCPQ']],'permission':'AuthLambdaFunction'}}]);});_0x36a2c7['riXgX'](it,_0x36a2c7['YwXIM'],()=>{_0x2c06a4['serverless']['service']['functions']={'first':{'events':[{'websocket':{'route':_0x36a2c7['MSQFk'],'authorizer':_0x36a2c7['qQQnf']}}]}};const _0x2cf5b6=_0x2c06a4['validate']();_0x36a2c7['aEDgs'](expect,_0x2cf5b6['events'])['to']['deep']['equal']([{'functionName':_0x36a2c7['oiKRE'],'route':_0x36a2c7['MSQFk'],'authorizer':{'name':'auth','uri':{'Fn::Join':['',['arn:',{'Ref':_0x36a2c7['eivYk']},_0x36a2c7['bkZPg'],{'Ref':_0x36a2c7['vxBlb']},_0x36a2c7['xeTSp'],_0x36a2c7['qQQnf'],'/invocations']]},'identitySource':[_0x36a2c7['aoCPQ']],'permission':'arn:aws:auth'}}]);});_0x36a2c7['riXgX'](it,_0x36a2c7['zPxrY'],()=>{_0x2c06a4['serverless']['service']['functions']={'first':{'events':[{'websocket':{'route':_0x36a2c7['MSQFk'],'authorizer':{'name':_0x36a2c7['NwYXX'],'identitySource':[_0x36a2c7['aoCPQ'],_0x36a2c7['pbLqK']]}}}]}};const _0xebd33a=_0x2c06a4['validate']();expect(_0xebd33a['events'])['to']['deep']['equal']([{'functionName':_0x36a2c7['oiKRE'],'route':_0x36a2c7['MSQFk'],'authorizer':{'name':_0x36a2c7['NwYXX'],'uri':{'Fn::Join':['',['arn:',{'Ref':'AWS::Partition'},_0x36a2c7['bkZPg'],{'Ref':_0x36a2c7['vxBlb']},_0x36a2c7['xeTSp'],{'Fn::GetAtt':[_0x36a2c7['dAPQp'],'Arn']},_0x36a2c7['RmBme']]]},'identitySource':[_0x36a2c7['aoCPQ'],_0x36a2c7['pbLqK']],'permission':'AuthLambdaFunction'}}]);});it(_0x36a2c7['dWPNy'],()=>{_0x2c06a4['serverless']['service']['functions']={'first':{'events':[{'websocket':{'route':_0x36a2c7['MSQFk'],'authorizer':{'arn':_0x36a2c7['qQQnf'],'identitySource':[_0x36a2c7['aoCPQ'],_0x36a2c7['pbLqK']]}}}]}};const _0x1c1c27=_0x2c06a4['validate']();_0x36a2c7['aTfkl'](expect,_0x1c1c27['events'])['to']['deep']['equal']([{'functionName':_0x36a2c7['oiKRE'],'route':_0x36a2c7['MSQFk'],'authorizer':{'name':_0x36a2c7['NwYXX'],'uri':{'Fn::Join':['',[_0x36a2c7['wjcEZ'],{'Ref':_0x36a2c7['eivYk']},_0x36a2c7['bkZPg'],{'Ref':'AWS::Region'},_0x36a2c7['xeTSp'],_0x36a2c7['qQQnf'],'/invocations']]},'identitySource':[_0x36a2c7['aoCPQ'],_0x36a2c7['pbLqK']],'permission':'arn:aws:auth'}}]);});_0x36a2c7['EIsEp'](it,'should\x20add\x20routeResponse\x20when\x20routeResponseSelectionExpression\x20is\x20configured',()=>{if('JzVfr'!=='JzVfr'){_0x2c06a4['serverless']['service']['functions']={'first':{'events':[{'websocket':_0x36a2c7['MSQFk']}]}};const _0x260ae2=_0x2c06a4['validate']();expect(_0x260ae2['events'])['to']['deep']['equal']([{'functionName':'first','route':_0x36a2c7['MSQFk']}]);}else{_0x2c06a4['serverless']['service']['functions']={'first':{'events':[{'websocket':{'route':_0x36a2c7['MSQFk'],'routeResponseSelectionExpression':_0x36a2c7['RkPpE']}}]}};const _0x7307e6=_0x2c06a4['validate']();_0x36a2c7['qtdto'](expect,_0x7307e6['events'])['to']['deep']['equal']([{'functionName':'first','route':'$connect','routeResponseSelectionExpression':_0x36a2c7['RkPpE']}]);}});_0x36a2c7['CKnbi'](it,_0x36a2c7['otNyO'],()=>{_0x2c06a4['serverless']['service']['functions']={'first':{'events':[{'ignored':{}}]}};const _0x3d2de8=_0x2c06a4['validate']();expect(_0x3d2de8['events'])['to']['be']['an']('Array')['with']['length'](0x0);});});describe('#validate() using runServerless util',()=>{var _0x4bf221={'TNNaS':function(_0xdd8bf3,_0x3c0cbd){return _0xdd8bf3(_0x3c0cbd);},'tSaDD':'Array','DhKiO':function(_0x1eb79d,_0x5c439e){return _0x1eb79d===_0x5c439e;},'eMQDv':'OdbtS','SxBYF':'authName','PbHrR':'function','XyZYR':'index.handler','hTVfN':'$connect','NukWp':'arn','TAiEx':'arnName','uffbM':'package','IUkOv':function(_0x31fbfa,_0x5d3fe9,_0x1edd66){return _0x31fbfa(_0x5d3fe9,_0x1edd66);},'wOZvP':'should use provided authorizer name when name field is supplied'};_0x4bf221['IUkOv'](it,_0x4bf221['wOZvP'],async()=>{if(_0x4bf221['DhKiO'](_0x4bf221['eMQDv'],_0x4bf221['eMQDv'])){const _0x84fc41=_0x4bf221['SxBYF'];const {cfTemplate,awsNaming}=await _0x4bf221['TNNaS'](runServerless,{'fixture':_0x4bf221['PbHrR'],'configExt':{'functions':{'first':{'handler':_0x4bf221['XyZYR'],'events':[{'websocket':{'route':_0x4bf221['hTVfN'],'authorizer':{'name':_0x84fc41,'arn':{'Fn::Join':[':',[_0x4bf221['NukWp'],_0x4bf221['TAiEx']]]}}}}]}}},'command':_0x4bf221['uffbM']});const _0x194519=cfTemplate['Resources'];const _0x4e1d2a=awsNaming;expect(_0x194519[_0x4e1d2a['getWebsocketsAuthorizerLogicalId'](_0x84fc41)])['to']['exist'];expect(_0x194519[_0x4e1d2a['getWebsocketsAuthorizerLogicalId'](_0x84fc41)]['Properties']['Name'])['to']['deep']['equal'](_0x84fc41);}else{awsCompileWebsocketsEvents['serverless']['service']['functions']={'first':{'events':[{'ignored':{}}]}};const _0x46a3db=awsCompileWebsocketsEvents['validate']();_0x4bf221['TNNaS'](expect,_0x46a3db['events'])['to']['be']['an'](_0x4bf221['tSaDD'])['with']['length'](0x0);}});});