import _0x422846 from'path';import _0x2b7f9a from'jsdom';import _0x457208 from'consola';import{Builder,BundleBuilder,getPort,loadFixture,Nuxt,rp,waitFor}from'../utils';let port;const url=route=>'http://localhost:'+port+route;let nuxt=null;let builder=null;let transpile=null;let output=null;let loadersOptions;let vueLoader;let postcssLoader;describe('basic dev',()=>{var kENODv={'uaNJX':function(x,y){return x===y;},'eUlej':'QFbad','WMQrx':function(x,y){return x-y;},'cPiSR':'log','cwzYj':'This is a test ssr log','lkMLg':'test-app.js','CsTnp':'test-app.[contenthash].js','yFrgm':function(callee,param1){return callee(param1);},'oMTSk':'nuxt-test','NyKSk':'postcss-preset-env','pImzH':'RTNme','ZDjNw':'basic','CNucH':'.nuxt-dev','LctmO':'test-[name].[contenthash].js','unlko':'@scoped/packageA','SKIBa':'@scoped\packageB','vDVbp':'vue.test.js','ucKPo':'[hash:base64:6]','gvUJw':function(callee,param1){return callee(param1);},'bvNLB':function(callee){return callee();},'oBsqm':'localhost','fyfoB':'vue-test','ZSyhm':function(callee,param1){return callee(param1);},'JtcJX':'node_modules/test.js','LFnKg':function(callee,param1){return callee(param1);},'FyWKV':'node_modules/vue.test.js','PHhUR':'node_modules/test.vue.js','ridxH':function(callee,param1){return callee(param1);},'hmFNv':function(callee,param1){return callee(param1);},'vVSNc':'node_modules/@scoped/packageB/src/index.js','gGQFK':function(callee,param1){return callee(param1);},'JEkUj':'node_modules/normal-test','lriuZ':function(callee,param1){return callee(param1);},'fFZBY':'Notice: Please do not use contenthash in dev mode to prevent memory leak','cIThh':function(x,y){return x===y;},'coHNH':'VEzah','cyVBV':'file','kauei':'fontUrl','smXQY':'imgUrl','PdnsJ':'vue','QcMfe':'css','DDrZs':'less','iAaMg':'sass','gFzEf':'scss','ABItW':'stylus','wlYAk':'vueStyle','yLFBz':function(callee,param1){return callee(param1);},'VfyRG':'postcss-import','BoHJb':'postcss-url','QiEKZ':function(callee,param1){return callee(param1);},'AhJfG':'node_modules/vue-test','OnwpY':function(callee,param1){return callee(param1);},'cfpME':function(x,y){return x!==y;},'MRSCz':'TovHc','FtWLt':'<h1>My\x20component!</h1>','yiZUi':'/stateless','ePmmQ':function(x,y){return x===y;},'xBIqA':'EnCby','IhFAp':'IPRiw','LCiNa':'hEGQL','jZxfv':'bdFNM','hbJfJ':function(callee,param1){return callee(param1);},'VQnEN':'Resource was not loaded. Status: 500','eEjrM':'application/json','zIetC':function(callee,param1,param2){return callee(param1,param2);},'vdfpo':function(callee,param1){return callee(param1);},'DhJBb':'/error','qeXmx':'text/json; charset=utf-8','SQOMF':'groupCollapsed','lfskx':function(callee,param1){return callee(param1);},'TBVar':'%cNuxt SSR','TQlLY':'background: #2E495E;border-radius: 0.5em;color: white;font-weight: bold;padding: 2px 0.5em;','rplBE':function(callee,param1){return callee(param1);},'UqsCY':'kriNX','wUmoB':'Check\x20build:done\x20hook\x20called','dHSHR':'Config: build.filenames','ZudWm':'Config: build.loaders','aODev':function(callee,param1,param2){return callee(param1,param2);},'IOzHA':'Config:\x20preset-env\x20and\x20cssnano\x20are\x20at\x20then\x20end\x20of\x20postcss\x20plugins','UdlLq':'/__open-in-editor (open-in-editor)','RpMqj':function(callee,param1,param2){return callee(param1,param2);},'liYma':function(callee,param1,param2){return callee(param1,param2);},'jyUaC':'/error should return json format error (Youch)','ltFGm':'/ should display ssr log in collapsed group'};beforeAll(async()=>{var GpoDZp={'GXICz':kENODv['lkMLg'],'kmkBZ':kENODv['CsTnp'],'dJxJz':function(callee,param1){return kENODv['yFrgm'](callee,param1);},'jIWBJ':'postcss-url','KGejd':kENODv['oMTSk'],'gnToX':kENODv['NyKSk']};if(kENODv['uaNJX'](kENODv['pImzH'],kENODv['pImzH'])){const config=await loadFixture(kENODv['ZDjNw'],{'dev':!![],'debug':!![],'buildDir':kENODv['CNucH'],'build':{'filenames':{'app':({isDev})=>{return isDev?GpoDZp['GXICz']:GpoDZp['kmkBZ'];},'chunk':kENODv['LctmO']},'transpile':[kENODv['unlko'],kENODv['SKIBa'],kENODv['vDVbp'],/vue-test/,({isModern})=>isModern?'modern-test':'normal-test'],'loaders':{'cssModules':{'modules':{'localIdentName':kENODv['ucKPo']}}},'extend'({module:{rules},output:wpOutput},{isClient,loaders}){if(kENODv['uaNJX'](kENODv['eUlej'],'fkhIu')){const _0x1b49fe=postcssLoader['options']['plugins']['map'](_0x337967=>{return _0x337967['postcssPlugin'];});GpoDZp['dJxJz'](expect,_0x1b49fe)['toEqual'](['postcss-import',GpoDZp['jIWBJ'],GpoDZp['KGejd'],GpoDZp['gnToX'],'cssnano']);}else{if(isClient){const babelLoader=rules['find'](loader=>loader['test']['test']('.jsx'));transpile=file=>!babelLoader['exclude'](file);output=wpOutput;loadersOptions=loaders;vueLoader=rules['find'](loader=>loader['test']['test']('.vue'));const cssLoaders=rules['find'](loader=>loader['test']['test']('.css'))['oneOf'][0x0]['use'];postcssLoader=cssLoaders[kENODv['WMQrx'](cssLoaders['length'],0x1)];}}}},'hooks':{'vue-renderer:ssr:context':({nuxt})=>{nuxt['logs']=[{'type':kENODv['cPiSR'],'args':[kENODv['cwzYj']]}];}},'render':{'ssrLog':'collapsed'}});nuxt=new Nuxt(config);await nuxt['ready']();builder=new Builder(nuxt,BundleBuilder);await builder['build']();await kENODv['gvUJw'](waitFor,0x7d0);port=await kENODv['bvNLB'](getPort);await nuxt['server']['listen'](port,kENODv['oBsqm']);}else{const _0x534e61=rules['find'](_0x5b26df=>_0x5b26df['test']['test']('.jsx'));transpile=_0x41f558=>!_0x534e61['exclude'](_0x41f558);output=wpOutput;loadersOptions=loaders;vueLoader=rules['find'](_0x2e2ac8=>_0x2e2ac8['test']['test']('.vue'));const _0x28e755=rules['find'](_0x59f3a1=>_0x59f3a1['test']['test']('.css'))['oneOf'][0x0]['use'];postcssLoader=_0x28e755[_0x28e755['length']-0x1];}});test(kENODv['wUmoB'],()=>{kENODv['gvUJw'](expect,builder['__hook_built_called__'])['toBe'](!![]);});kENODv['zIetC'](test,'Config: build.transpile',()=>{kENODv['gvUJw'](expect,kENODv['gvUJw'](transpile,kENODv['fyfoB']))['toBe'](!![]);kENODv['ZSyhm'](expect,transpile(_0x422846['normalize'](kENODv['JtcJX'])))['toBe'](![]);kENODv['LFnKg'](expect,transpile(_0x422846['normalize']('node_modules/vue-test')))['toBe'](!![]);kENODv['LFnKg'](expect,transpile(_0x422846['normalize'](kENODv['FyWKV'])))['toBe'](!![]);kENODv['LFnKg'](expect,kENODv['LFnKg'](transpile,_0x422846['normalize'](kENODv['PHhUR'])))['toBe'](!![]);kENODv['ridxH'](expect,transpile(_0x422846['normalize']('node_modules/@scoped/packageA/src/index.js')))['toBe'](!![]);kENODv['hmFNv'](expect,transpile(_0x422846['normalize'](kENODv['vVSNc'])))['toBe'](!![]);kENODv['gGQFK'](expect,kENODv['gGQFK'](transpile,_0x422846['normalize'](kENODv['JEkUj'])))['toBe'](!![]);});kENODv['zIetC'](test,kENODv['dHSHR'],()=>{kENODv['gGQFK'](expect,output['filename'])['toBe'](kENODv['lkMLg']);expect(output['chunkFilename'])['toBe']('test-[name].[contenthash].js');kENODv['lriuZ'](expect,_0x457208['warn'])['toBeCalledWith'](kENODv['fFZBY']);});test(kENODv['ZudWm'],()=>{if(kENODv['cIThh'](kENODv['coHNH'],'cIYqQ')){nuxt['logs']=[{'type':kENODv['cPiSR'],'args':[kENODv['cwzYj']]}];}else{kENODv['lriuZ'](expect,Object['keys'](loadersOptions))['toHaveLength'](0xc);kENODv['lriuZ'](expect,loadersOptions)['toHaveProperty'](kENODv['cyVBV'],kENODv['kauei'],kENODv['smXQY'],'pugPlain',kENODv['PdnsJ'],kENODv['QcMfe'],'cssModules',kENODv['DDrZs'],kENODv['iAaMg'],kENODv['gFzEf'],kENODv['ABItW'],kENODv['wlYAk']);const {cssModules,vue}=loadersOptions;expect(cssModules['modules']['localIdentName'])['toBe'](kENODv['ucKPo']);kENODv['yLFBz'](expect,vueLoader['options'])['toBe'](vue);}});kENODv['aODev'](test,kENODv['IOzHA'],()=>{const plugins=postcssLoader['options']['plugins']['map'](plugin=>{return plugin['postcssPlugin'];});kENODv['yLFBz'](expect,plugins)['toEqual']([kENODv['VfyRG'],kENODv['BoHJb'],kENODv['oMTSk'],kENODv['NyKSk'],'cssnano']);});test(kENODv['yiZUi'],async()=>{var pjSNza={'Ecrvq':function(callee,param1){return kENODv['yLFBz'](callee,param1);},'Fxhis':kENODv['fyfoB'],'EhDRm':kENODv['JtcJX'],'PGOwD':function(callee,param1){return kENODv['QiEKZ'](callee,param1);},'TAMMv':function(callee,param1){return kENODv['QiEKZ'](callee,param1);},'fNyEx':kENODv['AhJfG'],'zeVhs':function(callee,param1){return kENODv['QiEKZ'](callee,param1);},'YzBcz':kENODv['FyWKV'],'Dfeos':'node_modules/test.vue.js','FUEuj':function(callee,param1){return kENODv['QiEKZ'](callee,param1);},'mxxpI':'node_modules/@scoped/packageA/src/index.js','fpYFC':function(callee,param1){return kENODv['OnwpY'](callee,param1);},'eXXga':kENODv['vVSNc'],'PGCQX':kENODv['JEkUj']};if(kENODv['cfpME'](kENODv['MRSCz'],'TovHc')){expect(pjSNza['Ecrvq'](transpile,pjSNza['Fxhis']))['toBe'](!![]);pjSNza['Ecrvq'](expect,transpile(_0x422846['normalize'](pjSNza['EhDRm'])))['toBe'](![]);pjSNza['PGOwD'](expect,pjSNza['TAMMv'](transpile,_0x422846['normalize'](pjSNza['fNyEx'])))['toBe'](!![]);pjSNza['zeVhs'](expect,transpile(_0x422846['normalize'](pjSNza['YzBcz'])))['toBe'](!![]);pjSNza['zeVhs'](expect,pjSNza['zeVhs'](transpile,_0x422846['normalize'](pjSNza['Dfeos'])))['toBe'](!![]);expect(pjSNza['FUEuj'](transpile,_0x422846['normalize'](pjSNza['mxxpI'])))['toBe'](!![]);pjSNza['fpYFC'](expect,pjSNza['fpYFC'](transpile,_0x422846['normalize'](pjSNza['eXXga'])))['toBe'](!![]);expect(pjSNza['fpYFC'](transpile,_0x422846['normalize'](pjSNza['PGCQX'])))['toBe'](!![]);}else{const window=await nuxt['server']['renderAndGetWindow'](url('/stateless'));const html=window['document']['body']['innerHTML'];expect(html)['toContain'](kENODv['FtWLt']);kENODv['OnwpY'](expect,nuxt['__hook_render_routeDone__'])['toBe'](kENODv['yiZUi']);window['close']();}});kENODv['aODev'](test,kENODv['UdlLq'],async()=>{const {body}=await rp(kENODv['OnwpY'](url,'/__open-in-editor?file=pages/index.vue'));expect(body)['toBe']('');});kENODv['RpMqj'](test,'/__open-in-editor should return error (open-in-editor)',async()=>{if(kENODv['ePmmQ'](kENODv['xBIqA'],kENODv['IhFAp'])){return plugin['postcssPlugin'];}else{await kENODv['OnwpY'](expect,kENODv['OnwpY'](rp,kENODv['OnwpY'](url,'/__open-in-editor?file=')))['rejects']['toMatchObject']({'response':{'statusCode':0x1f4,'body':'launch-editor-middleware: required query param "file" is missing.'}});}});test('/error should return error stack trace (Youch)',async()=>{if(kENODv['ePmmQ'](kENODv['LCiNa'],kENODv['jZxfv'])){return isDev?'test-app.js':kENODv['CsTnp'];}else{await kENODv['OnwpY'](expect,nuxt['server']['renderAndGetWindow'](kENODv['hbJfJ'](url,'/error')))['rejects']['toThrow'](kENODv['VQnEN']);}});kENODv['liYma'](test,kENODv['jyUaC'],async()=>{const opts={'headers':{'accept':kENODv['eEjrM']}};await expect(kENODv['zIetC'](rp,kENODv['vdfpo'](url,kENODv['DhJBb']),opts))['rejects']['toMatchObject']({'response':{'statusCode':0x1f4,'headers':{'content-type':kENODv['qeXmx']}}});});kENODv['liYma'](test,kENODv['ltFGm'],async()=>{const virtualConsole=new _0x2b7f9a['VirtualConsole']();const groupCollapsed=jest['fn']();const groupEnd=jest['fn']();const log=jest['fn']();virtualConsole['on'](kENODv['SQOMF'],groupCollapsed);virtualConsole['on']('groupEnd',groupEnd);virtualConsole['on'](kENODv['cPiSR'],log);await nuxt['server']['renderAndGetWindow'](kENODv['lfskx'](url,'/'),{'virtualConsole':virtualConsole});kENODv['lfskx'](expect,groupCollapsed)['toHaveBeenCalledWith'](kENODv['TBVar'],kENODv['TQlLY']);expect(groupEnd)['toHaveBeenCalled']();kENODv['rplBE'](expect,log)['toHaveBeenCalledWith'](kENODv['cwzYj']);});afterAll(async()=>{if(kENODv['ePmmQ']('kriNX',kENODv['UqsCY'])){await builder['close']();}else{kENODv['rplBE'](expect,builder['__hook_built_called__'])['toBe'](!![]);}});});