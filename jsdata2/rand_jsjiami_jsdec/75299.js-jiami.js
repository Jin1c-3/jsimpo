import{Meteor}from'meteor/meteor';import{Email}from'meteor/email';import{TAPi18n}from'meteor/rocketchat:tap-i18n';import _0x554914 from'underscore';import _0xadc3d5 from'underscore.string';import _0x535518 from'juice';import _0x1f9f05 from'string-strip-html';import{escapeHTML}from'@rocket.chat/string-helpers';import{settings}from'../../settings/server';import{replaceVariables}from'./utils.js';let contentHeader;let contentFooter;let body;let Settings={'get':()=>{}};let lng='en';settings['get']('Language',(key,value)=>{var zMufjj={'xnHGn':function(x,y){return x||y;}};lng=zMufjj['xnHGn'](value,'en');});export const replacekey=(str,key,value='')=>str['replace'](new RegExp('(\x5c['+key+'\]|__'+key+'__)','igm'),value);export const translate=str=>replaceVariables(str,(match,key)=>TAPi18n['__'](key,{'lng':lng}));export const replace=function replace(str,data={}){var xAcfIC={'IkJBX':function(callee,param1){return callee(param1);},'KLPpz':function(callee,param1){return callee(param1);},'vxYGs':'email_style','ecGjg':function(x,y){return x!==y;},'eRWFa':'rhJsC','XAUIc':'XssKx','UfiVx':'Site_Name','HgmUw':'Site_Url'};if(!str){if(xAcfIC['ecGjg'](xAcfIC['eRWFa'],xAcfIC['XAUIc'])){return'';}else{var VhAKwf={'CmOwg':function(callee,param1){return xAcfIC['IkJBX'](callee,param1);},'ckjtW':function(callee,param1){return xAcfIC['KLPpz'](callee,param1);}};let _0x54c2a8='';Settings['get'](template,(_0x135e1b,_0x48e7a0)=>{_0x54c2a8=_0x48e7a0||'';fn(escape?VhAKwf['CmOwg'](inlinecss,_0x54c2a8):_0x54c2a8);});Settings['get'](xAcfIC['vxYGs'],()=>{VhAKwf['ckjtW'](fn,escape?inlinecss(_0x54c2a8):_0x54c2a8);});}}const options={'Site_Name':Settings['get'](xAcfIC['UfiVx']),'Site_URL':Settings['get'](xAcfIC['HgmUw']),'Site_URL_Slash':Settings['get'](xAcfIC['HgmUw'])['replace'](/\/?$/,'/'),...data['name']&&{'fname':_0xadc3d5['strLeft'](data['name'],'\x20'),'lname':_0xadc3d5['strRightBack'](data['name'],'\x20')},...data};return Object['entries'](options)['reduce']((ret,[key,value])=>replacekey(ret,key,value),translate(str));};const nonEscapeKeys=['room_path'];export const replaceEscaped=(str,data={})=>replace(str,{'Site_Name':escapeHTML(settings['get']('Site_Name')),'Site_Url':escapeHTML(settings['get']('Site_Url')),...Object['entries'](data)['reduce']((ret,[key,value])=>{var tODQcT={'QNHRv':function(callee,param1){return callee(param1);}};ret[key]=nonEscapeKeys['includes'](key)?value:tODQcT['QNHRv'](escapeHTML,value);return ret;},{})});export const wrap=(html,data={})=>{var kCBmEi={'xvomw':'email_plain_text_only','OQpdP':function(callee,param1,param2){return callee(param1,param2);},'iFjxW':'{{body}}'};if(settings['get'](kCBmEi['xvomw'])){return kCBmEi['OQpdP'](replace,html,data);}return kCBmEi['OQpdP'](replaceEscaped,body['replace'](kCBmEi['iFjxW'],html),data);};export const inlinecss=html=>_0x535518['inlineContent'](html,Settings['get']('email_style'));export const getTemplate=(template,fn,escape=!![])=>{var tBKPKq={'dJnHD':function(x,y){return x||y;},'yqXRB':function(callee,param1){return callee(param1);},'suWKc':function(callee,param1){return callee(param1);},'uFixy':function(x,y){return x!==y;},'jSpCL':'VPZMd','NkoCh':function(callee,param1){return callee(param1);},'nckdQ':function(callee,param1){return callee(param1);},'BjNNU':function(x,y){return x===y;},'WvJGM':'YaEec','uAiGQ':function(callee,param1){return callee(param1);},'rQYAW':function(callee,param1){return callee(param1);},'WYFCC':'email_style'};let html='';Settings['get'](template,(key,value)=>{if(tBKPKq['uFixy'](tBKPKq['jSpCL'],tBKPKq['jSpCL'])){html=tBKPKq['dJnHD'](value,'');tBKPKq['yqXRB'](fn,escape?tBKPKq['suWKc'](inlinecss,html):html);}else{html=value||'';tBKPKq['NkoCh'](fn,escape?tBKPKq['nckdQ'](inlinecss,html):html);}});Settings['get'](tBKPKq['WYFCC'],()=>{if(tBKPKq['BjNNU'](tBKPKq['WvJGM'],'YaEec')){tBKPKq['uAiGQ'](fn,escape?tBKPKq['rQYAW'](inlinecss,html):html);}else{text=_0x1f9f05(html)['result'];}});};export const getTemplateWrapped=(template,fn)=>{var dDULAZ={'LjzGh':'gfVjT','cGQAo':function(x,y){return x||y;},'gzFec':'Email_Header','kEtBE':'email_style'};let html='';const wrapInlineCSS=_0x554914['debounce'](()=>fn(wrap(inlinecss(html))),0x64);Settings['get'](dDULAZ['gzFec'],()=>html&&wrapInlineCSS());Settings['get']('Email_Footer',()=>html&&wrapInlineCSS());Settings['get'](dDULAZ['kEtBE'],()=>html&&wrapInlineCSS());Settings['get'](template,(key,value)=>{var NvpMvT={'fhiES':function(callee){return callee();}};if('gfVjT'!==dDULAZ['LjzGh']){html=value||'';return html&&NvpMvT['fhiES'](wrapInlineCSS);}else{html=dDULAZ['cGQAo'](value,'');return html&&wrapInlineCSS();}});};export const setSettings=_0xadc3d5=>{var PMLgKR={'FRdeL':'1|0|2|4|3','jjHMF':function(x,y){return x||y;},'dQiLH':function(callee,param1){return callee(param1);},'FgSvj':'Email_Header','AhYtU':function(callee,param1,param2,param3){return callee(param1,param2,param3);},'mrlwe':'Email_Footer'};var qWelUs=PMLgKR['FRdeL']['split']('|'),EWMswG=0x0;while(!![]){switch(qWelUs[EWMswG++]){case'0':Settings=_0xadc3d5;continue;case'1':var NWraWT={'nmYBO':function(x,y){return PMLgKR['jjHMF'](x,y);},'zjtQO':function(callee,param1){return PMLgKR['dQiLH'](callee,param1);}};continue;case'2':getTemplate(PMLgKR['FgSvj'],value=>{contentHeader=replace(NWraWT['nmYBO'](value,''));body=NWraWT['zjtQO'](inlinecss,contentHeader+' {{body}} '+contentFooter);},![]);continue;case'3':body=inlinecss(contentHeader+' {{body}} '+contentFooter);continue;case'4':PMLgKR['AhYtU'](getTemplate,PMLgKR['mrlwe'],value=>{contentFooter=replace(value||'');body=inlinecss(contentHeader+' {{body}} '+contentFooter);},![]);continue;}break;}};export const rfcMailPatternWithName=/^(?:.*<)?([a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)(?:>?)$/;export const checkAddressFormat=from=>rfcMailPatternWithName['test'](from);export const sendNoWrap=({to,from,replyTo,subject,html,text,headers})=>{var OcfQQJ={'IpTSq':'email_plain_text_only','czuwj':function(callee,param1,param2){return callee(param1,param2);},'GtYiB':'{{body}}','Hffwf':function(callee,param1){return callee(param1);},'RdOvx':function(x,y){return x===y;},'VuNqx':'kHeWo','Ddswq':'pfKqb','hOkqV':'wlAOU'};if(!OcfQQJ['Hffwf'](checkAddressFormat,to)){return;}if(!text){if(OcfQQJ['RdOvx'](OcfQQJ['VuNqx'],'kWNiS')){return'';}else{text=_0x1f9f05(html)['result'];}}if(settings['get'](OcfQQJ['IpTSq'])){if(OcfQQJ['RdOvx'](OcfQQJ['Ddswq'],OcfQQJ['hOkqV'])){if(settings['get'](OcfQQJ['IpTSq'])){return replace(html,data);}return OcfQQJ['czuwj'](replaceEscaped,body['replace'](OcfQQJ['GtYiB'],html),data);}else{html=undefined;}}Meteor['defer'](()=>Email['send']({'to':to,'from':from,'replyTo':replyTo,'subject':subject,'html':html,'text':text,'headers':headers}));};export const send=({to,from,replyTo,subject,html,text,data,headers})=>sendNoWrap({'to':to,'from':from,'replyTo':replyTo,'subject':replace(subject,data),'text':text?replace(text,data):_0x1f9f05(replace(html,data))['result'],'html':wrap(html,data),'headers':headers});export const checkAddressFormatAndThrow=(from,func)=>{var NTSOWU={'MlWJx':function(callee,param1){return callee(param1);},'NiaWv':'error-invalid-from-address','VjuKq':'Invalid from address'};if(NTSOWU['MlWJx'](checkAddressFormat,from)){return!![];}throw new Meteor['Error'](NTSOWU['NiaWv'],NTSOWU['VjuKq'],{'function':func});};export const getHeader=()=>contentHeader;export const getFooter=()=>contentFooter;