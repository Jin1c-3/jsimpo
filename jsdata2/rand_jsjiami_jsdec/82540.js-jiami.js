const sessionMiddleware=require('../../../../../core/server/services/auth')['session'];const models=require('../../../../../core/server/models');const sinon=require('sinon');const should=require('should');describe('Session Service',function(){var _0x3fb134={'eICUQ':function(_0x2acefe,_0x5d41d5){return _0x2acefe===_0x5d41d5;},'TVzrv':'uyewD','aItgF':'OlwbG','CxwJW':'zEZNP','aGuOB':function(_0x5a55b9){return _0x5a55b9();},'uZRgZ':function(_0x29ce61){return _0x29ce61();},'jEofn':'get','LKelc':'user-agent','EDYPH':'http://ghost.org/path','jJDKm':'127.0.0.1','iiKMp':'sendStatus','zjTKi':function(_0x49d4b0,_0x2223ab){return _0x49d4b0!==_0x2223ab;},'MtLdQ':'nirPx','nqZxG':'http://host.tld','MaTOR':function(_0x320826,_0x3d861e){return _0x320826===_0x3d861e;},'ezWHz':'tNRNS','mBKQg':'origin','TaoBg':'bububang','FQPOr':function(_0x4af71e){return _0x4af71e();},'slPcR':'destroy','unBMf':function(_0x8a73bf,_0x13a019){return _0x8a73bf!==_0x13a019;},'gPftB':'VjxmL','iVhBj':function(_0x1b2f77,_0x4c9509,_0x11d326){return _0x1b2f77(_0x4c9509,_0x11d326);},'txOpx':'sets\x20req.session.user_id,origin,user_agent,ip\x20and\x20calls\x20sendStatus\x20with\x20201\x20if\x20the\x20check\x20succeeds','Bjqux':'LMYIG','TtqkX':function(_0x1cca37,_0x933105){return _0x1cca37!==_0x933105;},'xmBTF':function(_0x575c42,_0x163a85,_0x49b8fd){return _0x575c42(_0x163a85,_0x49b8fd);},'DjqCL':'calls req.session.destroy','lvoui':function(_0x378aea,_0xb5c555,_0x41fd6f){return _0x378aea(_0xb5c555,_0x41fd6f);},'qGeaF':'calls sendStatus with 204 if destroy does not error','vzqle':function(_0x2f4f48,_0x16cb60){return _0x2f4f48(_0x16cb60);},'wkdMW':function(_0x5bdf60,_0x39694e,_0x4f18ad){return _0x5bdf60(_0x39694e,_0x4f18ad);},'rDrBQ':'createSession'};_0x3fb134['vzqle'](before,function(){models['init']();});afterEach(function(){sinon['restore']();});const _0x388060=function _0x388060(){if(_0x3fb134['eICUQ'](_0x3fb134['TVzrv'],_0x3fb134['aItgF'])){should['equal'](destroyStub['callCount'],0x1);done();}else{return{'session':{'destroy'(){}},'user':null,'body':{},'get'(){}};}};const _0x541803=function _0x541803(){return{'sendStatus'(){}};};_0x3fb134['wkdMW'](describe,_0x3fb134['rDrBQ'],function(){if(_0x3fb134['unBMf']('QIurI',_0x3fb134['gPftB'])){it('sets req.session.origin from the Referer header',function(_0x274c4c){var _0x2af496={'YfaTN':'http://ghost.org','IiKJp':'oops'};if(_0x3fb134['eICUQ'](_0x3fb134['CxwJW'],_0x3fb134['CxwJW'])){const _0x717aa4=_0x3fb134['aGuOB'](_0x388060);const _0x46debd=_0x3fb134['uZRgZ'](_0x541803);sinon['stub'](_0x717aa4,_0x3fb134['jEofn'])['withArgs'](_0x3fb134['LKelc'])['returns']('')['withArgs']('origin')['returns']('')['withArgs']('referrer')['returns'](_0x3fb134['EDYPH']);_0x717aa4['ip']=_0x3fb134['jJDKm'];_0x717aa4['user']=models['User']['forge']({'id':0x17});sinon['stub'](_0x46debd,_0x3fb134['iiKMp'])['callsFake'](function(){should['equal'](_0x717aa4['session']['origin'],_0x2af496['YfaTN']);_0x274c4c();});sessionMiddleware['createSession'](_0x717aa4,_0x46debd);}else{fn(new Error(_0x2af496['IiKJp']));}});_0x3fb134['iVhBj'](it,_0x3fb134['txOpx'],function(_0x36999b){var _0x244663={'MwZwI':function(_0x285685){return _0x285685();},'mUOlG':'destroy','IFbTS':function(_0x1f228f,_0x12a231){return _0x3fb134['zjTKi'](_0x1f228f,_0x12a231);},'bUcdM':_0x3fb134['MtLdQ'],'PafRI':_0x3fb134['nqZxG'],'mFBQi':'InternalServerError'};if(_0x3fb134['MaTOR'](_0x3fb134['ezWHz'],_0x3fb134['ezWHz'])){const _0x9dda85=_0x388060();const _0x53dbc6=_0x541803();sinon['stub'](_0x9dda85,_0x3fb134['jEofn'])['withArgs'](_0x3fb134['mBKQg'])['returns'](_0x3fb134['nqZxG'])['withArgs'](_0x3fb134['LKelc'])['returns'](_0x3fb134['TaoBg']);_0x9dda85['ip']=_0x3fb134['jJDKm'];_0x9dda85['user']=models['User']['forge']({'id':0x17});sinon['stub'](_0x53dbc6,_0x3fb134['iiKMp'])['callsFake'](function(_0xb15979){var _0x85dee2={'auPum':function(_0x5dbe5a){return _0x244663['MwZwI'](_0x5dbe5a);}};if(_0x244663['IFbTS']('nirPx',_0x244663['bUcdM'])){const _0x133341=_0x244663['MwZwI'](_0x388060);const _0x4d5dcd=_0x541803();const _0x2aa648=sinon['stub'](_0x133341['session'],_0x244663['mUOlG'])['callsFake'](function(_0x524fae){_0x85dee2['auPum'](_0x524fae);});sinon['stub'](_0x4d5dcd,'sendStatus')['callsFake'](function(){should['equal'](_0x2aa648['callCount'],0x1);_0x36999b();});sessionMiddleware['destroySession'](_0x133341,_0x4d5dcd);}else{var _0x1035f4='5|0|2|1|4|3'['split']('|'),_0x15dc00=0x0;while(!![]){switch(_0x1035f4[_0x15dc00++]){case'0':should['equal'](_0x9dda85['session']['origin'],_0x244663['PafRI']);continue;case'1':should['equal'](_0x9dda85['session']['ip'],'127.0.0.1');continue;case'2':should['equal'](_0x9dda85['session']['user_agent'],'bububang');continue;case'3':_0x36999b();continue;case'4':should['equal'](_0xb15979,0xc9);continue;case'5':should['equal'](_0x9dda85['session']['user_id'],0x17);continue;}break;}}});sessionMiddleware['createSession'](_0x9dda85,_0x53dbc6);}else{should['equal'](err['errorType'],_0x244663['mFBQi']);_0x36999b();}});}else{var _0x6d0ab8={'ECiFj':function(_0xa74c8a){return _0xa74c8a();}};const _0x75eac4=_0x388060();const _0x33da7e=_0x3fb134['FQPOr'](_0x541803);sinon['stub'](_0x75eac4['session'],_0x3fb134['slPcR'])['callsFake'](function(_0x423c87){_0x6d0ab8['ECiFj'](_0x423c87);});sinon['stub'](_0x33da7e,'sendStatus')['callsFake'](function(_0x1e5d57){should['equal'](_0x1e5d57,0xcc);done();});sessionMiddleware['destroySession'](_0x75eac4,_0x33da7e);}});_0x3fb134['wkdMW'](describe,'destroySession',function(){var _0x346af8={'PqKxr':function(_0xbdd41a){return _0x3fb134['FQPOr'](_0xbdd41a);},'GazAX':_0x3fb134['Bjqux'],'ydyeP':'oops','VJIZp':function(_0x1d1911){return _0x1d1911();},'ewWtv':_0x3fb134['LKelc'],'OCvZk':_0x3fb134['mBKQg'],'IWarG':'127.0.0.1','KanBD':'rENyF','RYfKy':'destroy','TgYgA':function(_0x568c01,_0x94d9d5){return _0x3fb134['TtqkX'](_0x568c01,_0x94d9d5);},'ICxsu':'uIdkx','LSRal':function(_0x212ba6){return _0x3fb134['FQPOr'](_0x212ba6);},'XHoYo':'sendStatus'};_0x3fb134['xmBTF'](it,_0x3fb134['DjqCL'],function(_0x32f038){var _0x4b916c={'NgKtA':function(_0x2bc86b){return _0x346af8['PqKxr'](_0x2bc86b);},'EXbga':_0x346af8['GazAX']};const _0x283a52=_0x388060();const _0x16ba1c=_0x346af8['PqKxr'](_0x541803);const _0x5d2cd1=sinon['stub'](_0x283a52['session'],'destroy')['callsFake'](function(_0x53bf3e){if('LMYIG'===_0x4b916c['EXbga']){_0x4b916c['NgKtA'](_0x53bf3e);}else{_0x4b916c['NgKtA'](_0x53bf3e);}});sinon['stub'](_0x16ba1c,'sendStatus')['callsFake'](function(){should['equal'](_0x5d2cd1['callCount'],0x1);_0x32f038();});sessionMiddleware['destroySession'](_0x283a52,_0x16ba1c);});it('calls\x20next\x20with\x20InternalServerError\x20if\x20destroy\x20errors',function(_0x45d40c){var _0x2c8a5e={'LJHUQ':function(_0x5c1848,_0x468b25){return _0x5c1848(_0x468b25);},'CJBAc':_0x346af8['ydyeP'],'YovaM':function(_0x2b3221){return _0x346af8['VJIZp'](_0x2b3221);},'sTvfv':_0x346af8['ewWtv'],'TIzfq':_0x346af8['OCvZk'],'RjMZS':'http://ghost.org/path','djxZW':_0x346af8['IWarG'],'TGaee':'sendStatus','XWvGT':_0x346af8['KanBD']};const _0xa7b713=_0x346af8['VJIZp'](_0x388060);const _0x1a4078=_0x541803();sinon['stub'](_0xa7b713['session'],_0x346af8['RYfKy'])['callsFake'](function(_0xdd0fa7){_0x2c8a5e['LJHUQ'](_0xdd0fa7,new Error(_0x2c8a5e['CJBAc']));});sessionMiddleware['destroySession'](_0xa7b713,_0x1a4078,function next(_0x3c8c19){if(_0x2c8a5e['XWvGT']===_0x2c8a5e['XWvGT']){should['equal'](_0x3c8c19['errorType'],'InternalServerError');_0x2c8a5e['YovaM'](_0x45d40c);}else{var _0x1ca18e={'wBWok':function(_0x4c822a){return _0x2c8a5e['YovaM'](_0x4c822a);}};const _0x1fe7e8=_0x2c8a5e['YovaM'](_0x388060);const _0x474f61=_0x2c8a5e['YovaM'](_0x541803);sinon['stub'](_0x1fe7e8,'get')['withArgs'](_0x2c8a5e['sTvfv'])['returns']('')['withArgs'](_0x2c8a5e['TIzfq'])['returns']('')['withArgs']('referrer')['returns'](_0x2c8a5e['RjMZS']);_0x1fe7e8['ip']=_0x2c8a5e['djxZW'];_0x1fe7e8['user']=models['User']['forge']({'id':0x17});sinon['stub'](_0x474f61,_0x2c8a5e['TGaee'])['callsFake'](function(){should['equal'](_0x1fe7e8['session']['origin'],'http://ghost.org');_0x1ca18e['wBWok'](_0x45d40c);});sessionMiddleware['createSession'](_0x1fe7e8,_0x474f61);}});});_0x3fb134['lvoui'](it,_0x3fb134['qGeaF'],function(_0x2d26d4){var _0x31d80f={'CThpj':function(_0xef1a71){return _0xef1a71();}};if(_0x346af8['TgYgA'](_0x346af8['ICxsu'],_0x346af8['ICxsu'])){models['init']();}else{const _0x31f714=_0x346af8['LSRal'](_0x388060);const _0x6b5013=_0x346af8['LSRal'](_0x541803);sinon['stub'](_0x31f714['session'],_0x346af8['RYfKy'])['callsFake'](function(_0x2e6378){_0x31d80f['CThpj'](_0x2e6378);});sinon['stub'](_0x6b5013,_0x346af8['XHoYo'])['callsFake'](function(_0x48e8d9){should['equal'](_0x48e8d9,0xcc);_0x2d26d4();});sessionMiddleware['destroySession'](_0x31f714,_0x6b5013);}});});});