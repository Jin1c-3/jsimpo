import{AppsEngineException}from'@rocket.chat/apps-engine/definition/exceptions';import{Meteor}from'meteor/meteor';import{AppEvents,Apps}from'../../../apps/server';import{callbacks}from'../../../callbacks';import{Messages,Rooms,Subscriptions}from'../../../models';import{Team}from'../../../../server/sdk';import{RoomMemberActions,roomTypes}from'../../../utils/server';export const addUserToRoom=function(rid,user,inviter,silenced){var KzjvkH={'Ujbmq':'error-app-prevented','FAzRx':function(x,y){return x instanceof y;},'KSiZQ':function(x,y){return x===y;},'sqqLz':'wLkuD','tgHnr':'afterAddedToRoom','hdwkF':'afterJoinRoom','kIDWC':function(x,y){return x!==y;},'TiVmn':'eWCOi','cYrkS':'uVVAi','iwFii':'nVphm','LYyjP':function(x,y){return x===y;},'MiFzA':'FySye','supSt':function(x,y){return x===y;},'sIgkg':function(x,y){return x===y;},'oXluu':'ndEbS'};const now=new Date();const room=Rooms['findOneById'](rid);const roomConfig=roomTypes['getConfig'](room['t']);if(!roomConfig['allowMemberAction'](room,RoomMemberActions['JOIN'])&&!roomConfig['allowMemberAction'](room,RoomMemberActions['INVITE'])){return;}const subscription=Subscriptions['findOneByRoomIdAndUserId'](rid,user['_id']);if(subscription){if(KzjvkH['kIDWC'](KzjvkH['TiVmn'],KzjvkH['cYrkS'])){return;}else{throw new Meteor[('Error')](KzjvkH['Ujbmq'],error['message']);}}try{if(KzjvkH['kIDWC'](KzjvkH['iwFii'],'nVphm')){Messages['createUserAddedWithRoomIdAndUser'](rid,user,{'ts':now,'u':{'_id':inviter['_id'],'username':inviter['username']}});}else{Promise['await'](Apps['triggerEvent'](AppEvents['IPreRoomUserJoined'],room,user,inviter));}}catch(_0x56e981){if(KzjvkH['FAzRx'](_0x56e981,AppsEngineException)){throw new Meteor[('Error')](KzjvkH['Ujbmq'],_0x56e981['message']);}throw _0x56e981;}if(room['t']==='c'||room['t']==='p'||KzjvkH['LYyjP'](room['t'],'l')){callbacks['run']('beforeAddedToRoom',{'user':user,'inviter':inviter},room);callbacks['run']('beforeJoinRoom',user,room);}Promise['await'](Apps['triggerEvent'](AppEvents['IPreRoomUserJoined'],room,user,inviter)['catch'](error=>{if(KzjvkH['FAzRx'](error,AppsEngineException)){throw new Meteor[('Error')](KzjvkH['Ujbmq'],error['message']);}throw error;}));Subscriptions['createWithRoomAndUser'](room,user,{'ts':now,'open':!![],'alert':!![],'unread':0x1,'userMentions':0x1,'groupMentions':0x0});if(!silenced){if(inviter){if(KzjvkH['kIDWC'](KzjvkH['MiFzA'],'FySye')){if(error instanceof AppsEngineException){throw new Meteor[('Error')](KzjvkH['Ujbmq'],error['message']);}throw error;}else{Messages['createUserAddedWithRoomIdAndUser'](rid,user,{'ts':now,'u':{'_id':inviter['_id'],'username':inviter['username']}});}}else if(room['prid']){Messages['createUserJoinWithRoomIdAndUserDiscussion'](rid,user,{'ts':now});}else if(room['teamMain']){Messages['createUserJoinTeamWithRoomIdAndUser'](rid,user,{'ts':now});}else{Messages['createUserJoinWithRoomIdAndUser'](rid,user,{'ts':now});}}if(KzjvkH['supSt'](room['t'],'c')||KzjvkH['sIgkg'](room['t'],'p')){Meteor['defer'](function(){var EfMRpL={'eZjUn':'afterAddedToRoom'};if(KzjvkH['KSiZQ'](KzjvkH['sqqLz'],KzjvkH['sqqLz'])){callbacks['run'](KzjvkH['tgHnr'],{'user':user,'inviter':inviter},room);callbacks['run'](KzjvkH['hdwkF'],user,room);Apps['triggerEvent'](AppEvents['IPostRoomUserJoined'],room,user,inviter);}else{var hOJKHh={'qudKh':EfMRpL['eZjUn']};Meteor['defer'](function(){callbacks['run'](hOJKHh['qudKh'],{'user':user,'inviter':inviter},room);callbacks['run']('afterJoinRoom',user,room);Apps['triggerEvent'](AppEvents['IPostRoomUserJoined'],room,user,inviter);});}});}if(room['teamMain']&&room['teamId']){if(KzjvkH['kIDWC'](KzjvkH['oXluu'],'ndEbS')){Promise['await'](Team['addMember'](inviter,user['_id'],room['teamId']));}else{Promise['await'](Team['addMember'](inviter,user['_id'],room['teamId']));}}return!![];};