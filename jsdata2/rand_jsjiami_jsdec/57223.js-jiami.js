// META: global=window,worker,jsshell
// META: script=../resources/recording-streams.js
// META: script=../resources/rs-utils.js
// META: script=../resources/test-utils.js
'use strict';// The size() function of the readable strategy can re-entrantly call back into the ReadableStream implementation. This
             // makes it risky to cache state across the call to ReadableStreamDefaultControllerEnqueue. These tests attempt to catch
             // such errors. They are separated from the other strategy tests because no real user code should ever do anything like
             // this.
const error1=new Error('error1');error1['name']='error1';promise_test(()=>{var _0x24087f={'PoAcS':function(_0x15ae88,_0x339a16){return _0x15ae88<_0x339a16;},'HsXNp':function(_0x4e4ce6,_0x1e4c9e){return _0x4e4ce6(_0x1e4c9e);}};let _0xffb969;let _0x3e9bd1=0x0;const _0x5e3430=new ReadableStream({'start'(_0x409abf){_0xffb969=_0x409abf;}},{'size'(){++_0x3e9bd1;if(_0x24087f['PoAcS'](_0x3e9bd1,0x2)){_0xffb969['enqueue']('b');}return 0x1;}});_0xffb969['enqueue']('a');_0xffb969['close']();return _0x24087f['HsXNp'](readableStreamToArray,_0x5e3430)['then'](_0x6668b1=>assert_array_equals(_0x6668b1,['b','a'],'array should contain two chunks'));},'enqueue() inside size() should work');promise_test(()=>{var _0x13d944={'jRZuM':function(_0x5bc150,_0x440e70){return _0x5bc150!==_0x440e70;},'KWVmH':'rEKly'};let _0x4e358e;const _0x904e9b=new ReadableStream({'start'(_0x1d17c9){_0x4e358e=_0x1d17c9;}},{'size'(){if(_0x13d944['jRZuM'](_0x13d944['KWVmH'],_0x13d944['KWVmH'])){pipeToPromise=_0x904e9b['pipeTo'](ws);}else{_0x4e358e['close']();return 0x1;}}});_0x4e358e['enqueue']('a');return readableStreamToArray(_0x904e9b)['then'](_0x36bfb8=>assert_array_equals(_0x36bfb8,[],'array should contain no chunks'));},'close() inside size() should not crash');promise_test(()=>{var _0x1706fa={'kDFxr':'AGkZb','WWHYy':'QBdHm','qowpz':function(_0x21feaf,_0x1971d4){return _0x21feaf===_0x1971d4;},'GczVt':'DlIzs','IEDrQ':function(_0x77b705,_0x3e8b8b){return _0x77b705===_0x3e8b8b;}};let _0x2620c;let _0x1aeefe=0x0;const _0x4355eb=new ReadableStream({'start'(_0xf8343d){if(_0x1706fa['kDFxr']!==_0x1706fa['WWHYy']){_0x2620c=_0xf8343d;}else{_0x2620c=_0xf8343d;}}},{'size'(){if(_0x1706fa['qowpz'](_0x1706fa['GczVt'],_0x1706fa['GczVt'])){++_0x1aeefe;if(_0x1706fa['IEDrQ'](_0x1aeefe,0x2)){_0x2620c['close']();}return 0x1;}else{readResolved=!![];}}});_0x2620c['enqueue']('a');_0x2620c['enqueue']('b');return readableStreamToArray(_0x4355eb)['then'](_0x31851c=>assert_array_equals(_0x31851c,['a','b'],'array should contain two chunks'));},'close\x20request\x20inside\x20size()\x20should\x20work');promise_test(_0x139500=>{var _0x3b2449={'UFEcU':function(_0x141bfe,_0x37f914,_0x79778a,_0x50d902,_0x238399){return _0x141bfe(_0x37f914,_0x79778a,_0x50d902,_0x238399);},'liNrG':function(_0x340cbf,_0x2ecac3){return _0x340cbf===_0x2ecac3;},'btlOm':'lMWXs','aGadz':'CKVKD','UGgQs':'read() should reject'};let _0x4093c0;const _0x24fcc7=new ReadableStream({'start'(_0x303f37){var _0x5e008b={'IBVCw':function(_0x14022b,_0x17a92b,_0x3515cd,_0x28547a,_0x3a127f){return _0x3b2449['UFEcU'](_0x14022b,_0x17a92b,_0x3515cd,_0x28547a,_0x3a127f);}};if(_0x3b2449['liNrG'](_0x3b2449['btlOm'],_0x3b2449['aGadz'])){let _0x5d1502;const _0xed2ba3=new ReadableStream({'start'(_0x6925f3){_0x5d1502=_0x6925f3;}},{'size'(){_0x5d1502['error'](error1);return 0x1;}});_0x5d1502['enqueue']('a');return _0x5e008b['IBVCw'](promise_rejects_exactly,_0x139500,error1,_0xed2ba3['getReader']()['read'](),'read()\x20should\x20reject');}else{_0x4093c0=_0x303f37;}}},{'size'(){_0x4093c0['error'](error1);return 0x1;}});_0x4093c0['enqueue']('a');return promise_rejects_exactly(_0x139500,error1,_0x24fcc7['getReader']()['read'](),_0x3b2449['UGgQs']);},'error()\x20inside\x20size()\x20should\x20work');promise_test(()=>{var _0x2e9a28={'cAZpS':function(_0x4c8d74,_0x3f2ab3,_0x268628,_0x58f6ed){return _0x4c8d74(_0x3f2ab3,_0x268628,_0x58f6ed);},'AMKJX':'desiredSize\x20should\x20be\x201','ViRgx':function(_0x59049d,_0x5f5045){return _0x59049d(_0x5f5045);}};let _0x3f5eb7;const _0x5567c2=new ReadableStream({'start'(_0x42cab0){_0x3f5eb7=_0x42cab0;}},{'size'(){_0x2e9a28['cAZpS'](assert_equals,_0x3f5eb7['desiredSize'],0x1,_0x2e9a28['AMKJX']);return 0x1;},'highWaterMark':0x1});_0x3f5eb7['enqueue']('a');_0x3f5eb7['close']();return _0x2e9a28['ViRgx'](readableStreamToArray,_0x5567c2)['then'](_0x3d4fe1=>assert_array_equals(_0x3d4fe1,['a'],'array should contain one chunk'));},'desiredSize inside size() should work');promise_test(_0x171561=>{var _0x33a2d2={'smDwl':function(_0x3b46db,_0x3601e7){return _0x3b46db===_0x3601e7;},'WmbYW':'RYnkL','KrmFr':'KGMAT','ACFtJ':function(_0x549455,_0x54457d,_0x483a60,_0xd3cba2){return _0x549455(_0x54457d,_0x483a60,_0xd3cba2);},'dIyRI':function(_0xdfdd5b,_0x38da2d){return _0xdfdd5b===_0x38da2d;},'nXXXu':'EiNba','KHuxj':'tJYJb','LBONQ':function(_0x2d6680,_0xd2a48b,_0x5b93cd,_0xad8a95){return _0x2d6680(_0xd2a48b,_0x5b93cd,_0xad8a95);},'XapnY':'reason\x20should\x20be\x20error1','hoYBO':'enqueue() should throw','dWTOQ':'ktDMz'};let _0x3435c1;let _0x18e3d6;const _0x4c934c=new ReadableStream({'start'(_0x6234e3){var _0x27bcdd={'kahju':function(_0xaecc6d,_0x402fe5){return _0xaecc6d===_0x402fe5;}};if(_0x33a2d2['smDwl'](_0x33a2d2['WmbYW'],_0x33a2d2['KrmFr'])){let _0x1e3a14;let _0xc43c2a=0x0;const _0x45b29b=new ReadableStream({'start'(_0x265d56){_0x1e3a14=_0x265d56;}},{'size'(){++_0xc43c2a;if(_0x27bcdd['kahju'](_0xc43c2a,0x2)){_0x1e3a14['close']();}return 0x1;}});_0x1e3a14['enqueue']('a');_0x1e3a14['enqueue']('b');return readableStreamToArray(_0x45b29b)['then'](_0x985e6=>assert_array_equals(_0x985e6,['a','b'],'array\x20should\x20contain\x20two\x20chunks'));}else{_0x18e3d6=_0x6234e3;}},'cancel':_0x171561['step_func'](_0x12e735=>{var _0x15e5f6={'oeRCC':function(_0x1eadd9,_0x3d4573,_0x2d5ca0,_0x2876b8){return _0x33a2d2['ACFtJ'](_0x1eadd9,_0x3d4573,_0x2d5ca0,_0x2876b8);},'WUKMo':'size() should have been called once'};if(_0x33a2d2['dIyRI'](_0x33a2d2['nXXXu'],_0x33a2d2['KHuxj'])){assert_false(readResolved);_0x18e3d6['enqueue']('b');_0x15e5f6['oeRCC'](assert_equals,calls,0x1,_0x15e5f6['WUKMo']);return delay(0x0);}else{_0x33a2d2['LBONQ'](assert_equals,_0x12e735,error1,_0x33a2d2['XapnY']);_0x33a2d2['LBONQ'](assert_throws_js,TypeError,()=>_0x18e3d6['enqueue'](),_0x33a2d2['hoYBO']);}})},{'size'(){if(_0x33a2d2['dWTOQ']===_0x33a2d2['dWTOQ']){_0x3435c1=_0x4c934c['cancel'](error1);return 0x1;}else{_0x18e3d6=c;}},'highWaterMark':Infinity});_0x18e3d6['enqueue']('a');const _0x1a0be2=_0x4c934c['getReader']();return Promise['all']([_0x1a0be2['closed'],_0x3435c1]);},'cancel() inside size() should work');promise_test(()=>{var _0x42e81d={'oeoPU':function(_0x5e8f27,_0xf06fd3){return _0x5e8f27!==_0xf06fd3;},'iAbtu':'uoNUx','rglfL':'write','ABaZu':'close','EmdcY':'target should have been closed','zmGFx':function(_0x353f5b){return _0x353f5b();},'MOTTF':function(_0x33e62f,_0x6b4de9,_0x1ef8ff){return _0x33e62f(_0x6b4de9,_0x1ef8ff);},'eYedl':function(_0x45736e,_0x14918c){return _0x45736e(_0x14918c);}};let _0x4a84de;let _0x42b9b0;const _0x6cb619=_0x42e81d['zmGFx'](recordingWritableStream);const _0x3d25f3=new ReadableStream({'start'(_0x2ed297){if(_0x42e81d['oeoPU'](_0x42e81d['iAbtu'],_0x42e81d['iAbtu'])){_0x4a84de=_0x2ed297;}else{_0x4a84de=_0x2ed297;}}},{'size'(){if(!_0x42b9b0){_0x42b9b0=_0x3d25f3['pipeTo'](_0x6cb619);}return 0x1;},'highWaterMark':0x1});_0x4a84de['enqueue']('a');_0x42e81d['MOTTF'](assert_not_equals,_0x42b9b0,undefined);_0x4a84de['enqueue']('a');return _0x42e81d['eYedl'](delay,0x0)['then'](()=>{assert_array_equals(_0x6cb619['events'],['write','a','write','a'],'ws should contain two chunks');_0x4a84de['close']();return _0x42b9b0;})['then'](()=>{assert_array_equals(_0x6cb619['events'],[_0x42e81d['rglfL'],'a','write','a',_0x42e81d['ABaZu']],_0x42e81d['EmdcY']);});},'pipeTo()\x20inside\x20size()\x20should\x20behave\x20as\x20expected');promise_test(()=>{var _0x538b73={'kqELy':function(_0x3e3c48,_0x1c1ec6,_0x24b58d,_0x4a96d8){return _0x3e3c48(_0x1c1ec6,_0x24b58d,_0x4a96d8);},'DYpYL':function(_0x34fd61,_0x48f623){return _0x34fd61(_0x48f623);},'uiVrp':function(_0x3bb790,_0x2d3de6){return _0x3bb790!==_0x2d3de6;},'iAWui':'vACHX','CYlpL':function(_0x238447,_0x383fd6,_0x28908f){return _0x238447(_0x383fd6,_0x28908f);},'wiZgx':'done should be false','egHkv':'chunk\x20should\x20have\x20been\x20read','htUmL':function(_0x26852c,_0x5bb18a,_0xe71aad,_0x3304fd){return _0x26852c(_0x5bb18a,_0xe71aad,_0x3304fd);},'CpGpU':'calls should still be 1','KnmEH':function(_0x511b97,_0x293c0c){return _0x511b97===_0x293c0c;},'WExgm':'KPAZx','WhCWY':'NiBMD','mxsqu':function(_0x3482ae,_0x28babd,_0x1958ba){return _0x3482ae(_0x28babd,_0x1958ba);},'fnzsl':'done should be false again','ePzvy':'chunk a should come after b'};let _0xcbf533;let _0x14de57;let _0x10b9e7=0x0;let _0x405c10=![];let _0x307e2d;const _0x5ef879=new ReadableStream({'start'(_0x192342){_0xcbf533=_0x192342;}},{'size'(){_0x14de57=_0x307e2d['read']();++_0x10b9e7;return 0x1;},'highWaterMark':0x0});_0x307e2d=_0x5ef879['getReader']();_0xcbf533['enqueue']('a');_0x14de57['then'](()=>{_0x405c10=!![];});return flushAsyncEvents()['then'](()=>{assert_false(_0x405c10);_0xcbf533['enqueue']('b');_0x538b73['kqELy'](assert_equals,_0x10b9e7,0x1,'size() should have been called once');return delay(0x0);})['then'](()=>{_0x538b73['DYpYL'](assert_true,_0x405c10);_0x538b73['kqELy'](assert_equals,_0x10b9e7,0x1,'size()\x20should\x20only\x20be\x20called\x20once');return _0x14de57;})['then'](({value,done})=>{if(_0x538b73['uiVrp'](_0x538b73['iAWui'],'yBLzm')){_0x538b73['CYlpL'](assert_false,done,_0x538b73['wiZgx']);_0x538b73['kqELy'](assert_equals,value,'b',_0x538b73['egHkv']);_0x538b73['htUmL'](assert_equals,_0x10b9e7,0x1,_0x538b73['CpGpU']);return _0x307e2d['read']();}else{_0xcbf533=c;}})['then'](({value,done})=>{if(_0x538b73['KnmEH'](_0x538b73['WExgm'],_0x538b73['WhCWY'])){_0x538b73['DYpYL'](assert_true,_0x405c10);assert_equals(_0x10b9e7,0x1,'size() should only be called once');return _0x14de57;}else{_0x538b73['mxsqu'](assert_false,done,_0x538b73['fnzsl']);_0x538b73['htUmL'](assert_equals,value,'a',_0x538b73['ePzvy']);}});},'read()\x20inside\x20of\x20size()\x20should\x20behave\x20as\x20expected');promise_test(()=>{var _0x464278={'erPDj':function(_0x27d6dd,_0x7a6e9c,_0x165e69){return _0x27d6dd(_0x7a6e9c,_0x165e69);},'RcOVU':'done\x20should\x20be\x20false','vMbWI':'value should be a'};let _0x5c21bc;let _0x2637a4;const _0x5305e1=new ReadableStream({'start'(_0x2dc059){_0x5c21bc=_0x2dc059;}},{'size'(){_0x2637a4=_0x5305e1['getReader']();return 0x1;}});_0x5c21bc['enqueue']('a');return _0x2637a4['read']()['then'](({value,done})=>{_0x464278['erPDj'](assert_false,done,_0x464278['RcOVU']);assert_equals(value,'a',_0x464278['vMbWI']);});},'getReader()\x20inside\x20size()\x20should\x20work');promise_test(()=>{var _0x1990d4={'SGMlw':function(_0x503f9f,_0x22f5ee,_0x31b892){return _0x503f9f(_0x22f5ee,_0x31b892);},'sqKgA':function(_0x26699b,_0xfb1c28){return _0x26699b(_0xfb1c28);}};let _0x162a82;let _0x1e986d;let _0x217955;const _0x11feee=new ReadableStream({'start'(_0x261fa6){_0x162a82=_0x261fa6;}},{'size'(){[_0x1e986d,_0x217955]=_0x11feee['tee']();return 0x1;}});_0x162a82['enqueue']('a');_0x1990d4['SGMlw'](assert_true,_0x11feee['locked'],'rs\x20should\x20be\x20locked');_0x162a82['close']();return Promise['all']([_0x1990d4['sqKgA'](readableStreamToArray,_0x1e986d)['then'](_0x51e479=>assert_array_equals(_0x51e479,['a'],'branch1 should have one chunk')),_0x1990d4['sqKgA'](readableStreamToArray,_0x217955)['then'](_0x334860=>assert_array_equals(_0x334860,['a'],'branch2\x20should\x20have\x20one\x20chunk'))]);},'tee() inside size() should work');