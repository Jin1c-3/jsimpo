'use strict';const WebSocket=require('ws');const {expect}=require('chai');const awsRequest=require('@serverless/test/aws-request');const log=require('log')['get']('serverless:test');const wait=require('timers-ext/promise/sleep');const fixtures=require('../../fixtures/programmatic');const {confirmCloudWatchLogs}=require('../../utils/misc');const {deployService,removeService}=require('../../utils/integration');const {createApi,deleteApi,getRoutes,createStage,deleteStage}=require('../../utils/websocket');describe('AWS - API Gateway Websocket Integration Test',function(){var _0x20b1e5={'LKCwH':function(_0x35e65c,_0x163b6d){return _0x35e65c(_0x163b6d);},'wHcOF':'ondJe','sdFdt':'WtmBJ','tCQKk':function(_0x22cb2c,_0x5bb4bb,_0x37fbec,_0x1510cf){return _0x22cb2c(_0x5bb4bb,_0x37fbec,_0x1510cf);},'stdOp':'CloudFormation','Hfmlq':'describeStacks','gPWGh':function(_0xcbe279,_0x12edd3){return _0xcbe279===_0x12edd3;},'hLaaT':'dwlRC','sDoOo':'Sending message to \'hello\' route','vJSFQ':function(_0x1f9532,_0x4b6494){return _0x1f9532(_0x4b6494);},'ASqPX':'Hello,\x20serverless','UxECc':'oAxEq','noxOq':'serverless','mzCsD':function(_0x160e83,_0xc08fd1){return _0x160e83!==_0xc08fd1;},'RucKf':'AhOdR','WoKKP':'message','TyaAp':function(_0x10c291){return _0x10c291();},'qVzuH':'hLXcY','VLehI':'PsOxg','vwUHD':function(_0x45cb3b,_0x20402a){return _0x45cb3b(_0x20402a);},'AvGaZ':function(_0x4e32bc,_0xfebcfd,_0x551151){return _0x4e32bc(_0xfebcfd,_0x551151);},'enoqq':function(_0x5eb087,_0x194264){return _0x5eb087(_0x194264);},'lZGXe':'Unexpected\x20WebSocket\x20message','XCpOe':'open','sSzjJ':function(_0x12712e){return _0x12712e();},'Hkmpy':function(_0x339950,_0xf6893d){return _0x339950(_0xf6893d);},'vqdoJ':'nGCKf','sZzzH':'dev','WJcFh':function(_0x17441d,_0x2276a3){return _0x17441d(_0x2276a3);},'EZNBt':function(_0x1ce73b,_0x54d4e1){return _0x1ce73b(_0x54d4e1);},'WWGvR':function(_0x27604e,_0x313fa0){return _0x27604e>_0x313fa0;},'adHPI':'should\x20add\x20the\x20routes\x20to\x20the\x20referenced\x20API','Lfnbz':'should\x20expose\x20an\x20accessible\x20websocket\x20endpoint','TnuNa':function(_0x4c5acc,_0x30b3d4){return _0x4c5acc*_0x30b3d4;},'IDyGy':function(_0x1c1121,_0x2d468d){return _0x1c1121*_0x2d468d;},'zYDWd':function(_0xa9cc86,_0x20afb2){return _0xa9cc86(_0x20afb2);},'YEzNp':'Two-Way Setup','WvthP':function(_0x24ace7,_0x4614c3,_0x3d2d7d){return _0x24ace7(_0x4614c3,_0x3d2d7d);},'BHIQZ':'Minimal Setup'};this['timeout'](_0x20b1e5['TnuNa'](_0x20b1e5['IDyGy'](0x3e8,0x3c),0xa));let _0x46d73c;let _0x17b866;let _0x1f6528;let _0x29545d;let _0x173e4a;const _0x4e3882=_0x20b1e5['sZzzH'];_0x20b1e5['EZNBt'](before,async()=>{const _0x562ec8=await fixtures['setup']('websocket');({servicePath:_0x1f6528,updateConfig}=_0x562ec8);_0x17b866=_0x562ec8['serviceConfig']['service'];_0x46d73c=_0x17b866+'-'+_0x4e3882;return _0x20b1e5['LKCwH'](deployService,_0x1f6528);});_0x20b1e5['zYDWd'](after,()=>{if(_0x20b1e5['wHcOF']!==_0x20b1e5['sdFdt']){if(!_0x173e4a)return null;return removeService(_0x1f6528);}else{ws['close']();}});async function _0x10d2e8(){const _0x2a86cc=await _0x20b1e5['tCQKk'](awsRequest,_0x20b1e5['stdOp'],_0x20b1e5['Hfmlq'],{'StackName':_0x46d73c});const _0x2936f1=_0x2a86cc['Stacks'][0x0]['Outputs']['find'](_0x4e4ae7=>_0x4e4ae7['OutputKey']==='ServiceEndpointWebsocket')['OutputValue'];return _0x2936f1;}describe(_0x20b1e5['YEzNp'],()=>{if(_0x20b1e5['gPWGh'](_0x20b1e5['qVzuH'],_0x20b1e5['VLehI'])){_0x20b1e5['LKCwH'](promiseReject,error);try{ws['close']();}catch(_0x4a4ab3){}}else{let _0x14934b;_0x20b1e5['vwUHD'](after,()=>clearTimeout(_0x14934b));_0x20b1e5['AvGaZ'](it,'should expose a websocket route that can reply to a message',async()=>{var _0x7fb2a5={'tjgFs':function(_0x1c647c,_0x48d03e){return _0x20b1e5['gPWGh'](_0x1c647c,_0x48d03e);},'VGIZt':_0x20b1e5['hLaaT'],'xOVxm':_0x20b1e5['sDoOo'],'ooIcp':'hello','YkfXH':function(_0x40efc8,_0x18fef2,_0x218bb9){return _0x40efc8(_0x18fef2,_0x218bb9);},'NwTKa':function(_0x430230,_0x3c182c){return _0x20b1e5['vJSFQ'](_0x430230,_0x3c182c);},'lVotA':_0x20b1e5['ASqPX'],'iuiEE':_0x20b1e5['UxECc'],'KETDr':'jaPac','vpIdO':_0x20b1e5['noxOq'],'roFVS':function(_0x395bbc,_0x21df15){return _0x20b1e5['mzCsD'](_0x395bbc,_0x21df15);},'XKULx':_0x20b1e5['RucKf'],'QFfpf':'open','GYXXC':'close','XWaUy':_0x20b1e5['WoKKP']};const _0x1a0032=await _0x20b1e5['TyaAp'](_0x10d2e8);return new Promise((_0x46087b,_0x278f6a)=>{var _0x48aaee={'hmowY':_0x7fb2a5['xOVxm'],'qmCOk':_0x7fb2a5['ooIcp'],'Aptpv':_0x7fb2a5['vpIdO'],'nIMxX':function(_0x2282f5,_0x3d88c7){return _0x2282f5(_0x3d88c7);},'yIGDL':'Hello, serverless'};if(_0x7fb2a5['roFVS']('rnwHX',_0x7fb2a5['XKULx'])){const _0x1e8cea=new WebSocket(_0x1a0032);_0x278f6a=(_0x3aea5b=>_0x54edbd=>{_0x3aea5b(_0x54edbd);try{_0x1e8cea['close']();}catch(_0x3b8dbd){}})(_0x278f6a);const _0x31aedc=()=>{if(_0x7fb2a5['tjgFs']('dwlRC',_0x7fb2a5['VGIZt'])){log['debug'](_0x7fb2a5['xOVxm']);_0x1e8cea['send'](JSON['stringify']({'action':_0x7fb2a5['ooIcp'],'name':'serverless'}));_0x14934b=_0x7fb2a5['YkfXH'](setTimeout,_0x31aedc,0x3e8);}else{log['debug'](_0x48aaee['hmowY']);_0x1e8cea['send'](JSON['stringify']({'action':_0x48aaee['qmCOk'],'name':_0x48aaee['Aptpv']}));_0x14934b=setTimeout(_0x31aedc,0x3e8);}};_0x1e8cea['on']('error',_0x278f6a);_0x1e8cea['on'](_0x7fb2a5['QFfpf'],_0x31aedc);_0x1e8cea['on'](_0x7fb2a5['GYXXC'],_0x46087b);_0x1e8cea['on'](_0x7fb2a5['XWaUy'],_0x4d2af8=>{_0x173e4a=!![];_0x7fb2a5['NwTKa'](clearTimeout,_0x14934b);try{log['debug']('Received\x20WebSocket\x20message:\x20'+_0x4d2af8);_0x7fb2a5['NwTKa'](expect,_0x4d2af8)['to']['equal'](_0x7fb2a5['lVotA']);}finally{if(_0x7fb2a5['iuiEE']!==_0x7fb2a5['KETDr']){_0x1e8cea['close']();}else{_0x173e4a=!![];_0x48aaee['nIMxX'](clearTimeout,_0x14934b);try{log['debug']('Received WebSocket message: '+_0x4d2af8);_0x48aaee['nIMxX'](expect,_0x4d2af8)['to']['equal'](_0x48aaee['yIGDL']);}finally{_0x1e8cea['close']();}}}});}else{ws['close']();}})['finally'](()=>clearTimeout(_0x14934b));});}});_0x20b1e5['WvthP'](describe,_0x20b1e5['BHIQZ'],()=>{var _0x421bde={'eQXHF':'OcRTl','UsDlz':function(_0x5f197c,_0x21a21b){return _0x20b1e5['enoqq'](_0x5f197c,_0x21a21b);},'uMplf':_0x20b1e5['lZGXe'],'uJPBK':'error','wDkMq':_0x20b1e5['XCpOe'],'yRjbd':function(_0x247bda){return _0x20b1e5['sSzjJ'](_0x247bda);},'VJaLb':function(_0x425cdb,_0x2f6386){return _0x20b1e5['Hkmpy'](_0x425cdb,_0x2f6386);},'Druuz':_0x20b1e5['vqdoJ'],'OctrQ':_0x20b1e5['sZzzH'],'ExVAf':function(_0x2efc69,_0x328c15){return _0x20b1e5['WJcFh'](_0x2efc69,_0x328c15);},'IflcX':function(_0x5c1877,_0x5ccfe0){return _0x5c1877(_0x5ccfe0);},'ZLjoT':function(_0x563968,_0x22a99c){return _0x20b1e5['EZNBt'](_0x563968,_0x22a99c);},'soDuB':function(_0x42933c,_0x2e1d22){return _0x20b1e5['EZNBt'](_0x42933c,_0x2e1d22);},'ctHBR':function(_0x4fa712,_0x39b826){return _0x20b1e5['WWGvR'](_0x4fa712,_0x39b826);},'jSogu':function(_0x1eaa67,_0x2310a7,_0x2c781b){return _0x1eaa67(_0x2310a7,_0x2c781b);},'vwFJn':_0x20b1e5['adHPI']};_0x20b1e5['AvGaZ'](it,_0x20b1e5['Lfnbz'],async function(){var _0x44a804={'VRyLY':'ZiiuH','huCTu':_0x421bde['eQXHF'],'zcsyM':function(_0x5962ed,_0x4b8ed2){return _0x421bde['UsDlz'](_0x5962ed,_0x4b8ed2);},'Qwsys':'test message','JQoSN':_0x421bde['uMplf'],'aZFVf':_0x421bde['uJPBK'],'fgpgx':_0x421bde['wDkMq']};if(!_0x173e4a)this['skip']();const _0xa355f6=await _0x421bde['yRjbd'](_0x10d2e8);log['debug']('WebSocket Server URL '+_0xa355f6);_0x421bde['VJaLb'](expect,_0xa355f6)['to']['match'](/wss:\/\/.+\.execute-api\..+\.amazonaws\.com.+/);return new Promise((_0x22b938,_0x5a70ee)=>{var _0x564283={'rCbOT':function(_0x304598,_0x29d1d0){return _0x44a804['zcsyM'](_0x304598,_0x29d1d0);},'OHOnZ':'FsNdg','HGUcQ':'Stop propagation','AkxDO':_0x44a804['Qwsys'],'LKUUg':_0x44a804['JQoSN'],'PjfSm':'Unexpected message'};const _0x26765c=new WebSocket(_0xa355f6);let _0x12afee=![];_0x5a70ee=(_0x22b31b=>_0x33a852=>{var _0x35d503={'yCNmA':function(_0x39bf0d,_0x3d009f){return _0x564283['rCbOT'](_0x39bf0d,_0x3d009f);}};_0x12afee=!![];_0x22b31b(_0x33a852);try{if(_0x564283['OHOnZ']===_0x564283['OHOnZ']){_0x26765c['close']();}else{log['debug']('Received\x20WebSocket\x20message:\x20'+event);_0x35d503['yCNmA'](expect,event)['to']['equal']('Hello, serverless');}}catch(_0x2d7a7c){}})(_0x5a70ee);_0x26765c['on'](_0x44a804['aZFVf'],_0x5a70ee);_0x26765c['on'](_0x44a804['fgpgx'],()=>{if(_0x44a804['VRyLY']!==_0x44a804['huCTu']){confirmCloudWatchLogs('/aws/websocket/'+_0x46d73c,()=>{if(_0x12afee)throw new Error(_0x564283['HGUcQ']);_0x26765c['send'](_0x564283['AkxDO']);return wait(0x1f4);})['then'](_0x18e1d8=>{_0x564283['rCbOT'](expect,_0x18e1d8['length']>0x0)['to']['equal'](!![]);_0x26765c['close']();},_0x5a70ee);}else{_0x12afee=!![];_0x564283['rCbOT'](promiseReject,error);try{_0x26765c['close']();}catch(_0x6c303e){}}});_0x26765c['on']('close',_0x22b938);_0x26765c['on']('message',_0x4058a4=>{log['debug'](_0x564283['LKUUg'],_0x4058a4);_0x564283['rCbOT'](_0x5a70ee,new Error(_0x564283['PjfSm']));});});});_0x20b1e5['AvGaZ'](describe,'when using an existing websocket API',()=>{var _0x5d285b={'bcqNt':function(_0x4a540c,_0xcde60){return _0x421bde['ctHBR'](_0x4a540c,_0xcde60);}};let _0x45fd32;before(async function(){if('nGCKf'===_0x421bde['Druuz']){if(!_0x173e4a)this['skip']();const _0x2a192f=_0x4e3882+'-'+_0x17b866+'-ext-api';const _0x2fcf78=await createApi(_0x2a192f);_0x45fd32=_0x2fcf78['ApiId'];await createStage(_0x45fd32,_0x421bde['OctrQ']);await _0x29545d({'provider':{'apiGateway':{'websocketApiId':_0x45fd32}}});return deployService(_0x1f6528);}else{expect(_0x5d285b['bcqNt'](events['length'],0x0))['to']['equal'](!![]);ws['close']();}});after(async()=>{if(!_0x173e4a)return;await _0x421bde['VJaLb'](_0x29545d,{'provider':{'apiGateway':{'websocketApiId':null}}});await deleteStage(_0x45fd32,_0x421bde['OctrQ']);await _0x421bde['ExVAf'](deployService,_0x1f6528);log['debug']('Deleting external websocket API...');await _0x421bde['IflcX'](deleteApi,_0x45fd32);});_0x421bde['jSogu'](it,_0x421bde['vwFJn'],async()=>{const _0x4b82e2=await _0x421bde['ZLjoT'](getRoutes,_0x45fd32);_0x421bde['soDuB'](expect,_0x4b82e2['length'])['to']['equal'](0x4);});});});});