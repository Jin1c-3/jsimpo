var async=require("../lib");var{expect}=require("chai");var assert=require("assert");describe("cargo",()=>{it("cargo",e=>{var t=[],o=[40,40,20];var r=async.cargo((e,a)=>{setTimeout(()=>{t.push("process "+e.join(" "));a("error","arg")},o.shift())},2);r.push(1,(e,a)=>{expect(e).to.equal("error");expect(a).to.equal("arg");expect(r.length()).to.equal(3);t.push("callback "+1)});r.push(2,(e,a)=>{expect(e).to.equal("error");expect(a).to.equal("arg");expect(r.length()).to.equal(3);t.push("callback "+2)});expect(r.length()).to.equal(2);setTimeout(()=>{r.push(3,(e,a)=>{expect(e).to.equal("error");expect(a).to.equal("arg");expect(r.length()).to.equal(1);t.push("callback "+3)})},15);setTimeout(()=>{r.push(4,(e,a)=>{expect(e).to.equal("error");expect(a).to.equal("arg");expect(r.length()).to.equal(1);t.push("callback "+4)});expect(r.length()).to.equal(2);r.push(5,(e,a)=>{expect(e).to.equal("error");expect(a).to.equal("arg");expect(r.length()).to.equal(0);t.push("callback "+5)})},30);r.drain(()=>{expect(t).to.eql(["process 1 2","callback 1","callback 2","process 3 4","callback 3","callback 4","process 5","callback 5"]);expect(r.length()).to.equal(0);e()})});it("without callback",e=>{var t=[],o=[40,60,60,20];var a=async.cargo((e,a)=>{setTimeout(()=>{t.push("process "+e.join(" "));a("error","arg")},o.shift())},2);a.push(1);setTimeout(()=>{a.push(2)},20);setTimeout(()=>{a.push(3);a.push(4);a.push(5)},80);a.drain(()=>{expect(t).to.eql(["process 1","process 2","process 3 4","process 5"]);e()})});it("bulk task",e=>{var t=[],o=[30,20];var a=async.cargo((e,a)=>{setTimeout(()=>{t.push("process "+e.join(" "));a("error",e.join(" "))},o.shift())},3);a.push([1,2,3,4],(e,a)=>{expect(e).to.equal("error");t.push("callback "+a)});expect(a.length()).to.equal(4);setTimeout(()=>{expect(t).to.eql(["process 1 2 3","callback 1 2 3","callback 1 2 3","callback 1 2 3","process 4","callback 4"]);expect(a.length()).to.equal(0);e()},200)});it("drain once",e=>{var a=async.cargo((e,a)=>{a()},3);var t=0;a.drain(()=>{t++});for(var o=0;o<10;o++){a.push(o)}setTimeout(()=>{expect(t).to.equal(1);e()},50)});it("drain twice",e=>{var a=async.cargo((e,a)=>{a()},3);function t(){for(var e=0;e<10;e++){a.push(e)}}var o=0;a.drain(()=>{o++;if(o===1){t()}else{expect(o).to.equal(2);e()}});t()});it("events",e=>{var t=[];var a=async.cargo((e,a)=>{t.push("process "+e);async.setImmediate(a)},1);a.concurrency=3;a.saturated(()=>{assert(a.running()==3,"cargo should be saturated now");t.push("saturated")});a.empty(()=>{assert(a.length()===0,"cargo should be empty now");t.push("empty")});a.drain(()=>{assert(a.length()===0&&a.running()===0,"cargo should be empty now and no more workers should be running");t.push("drain");expect(t).to.eql(["process foo","process bar","saturated","process zoo","foo cb","saturated","process poo","bar cb","empty","saturated","process moo","zoo cb","poo cb","moo cb","drain"]);e()});a.push("foo",()=>{t.push("foo cb")});a.push("bar",()=>{t.push("bar cb")});a.push("zoo",()=>{t.push("zoo cb")});a.push("poo",()=>{t.push("poo cb")});a.push("moo",()=>{t.push("moo cb")})});it("expose payload",e=>{var t=false;var o=async.cargo((e,a)=>{if(!t){expect(o.payload).to.equal(1);assert(e.length===1,"should start with payload = 1")}else{expect(o.payload).to.equal(2);assert(e.length===2,"next call shold have payload = 2")}t=true;setTimeout(a,25)},1);o.drain(e);expect(o.payload).to.equal(1);o.push([1,2,3]);setTimeout(()=>{o.payload=2},15)});it("workersList",e=>{var t=false;function o(e){return e.workersList().map(e=>{return e.data})}var r=async.cargo((e,a)=>{if(!t){expect(e).to.eql(["foo","bar"])}else{expect(e).to.eql(["baz"])}expect(o(r)).to.eql(e);async.setImmediate(()=>{expect(o(r)).to.eql(e);t=true;a()})},2);r.drain(()=>{expect(r.workersList()).to.eql([]);expect(r.running()).to.equal(0);e()});r.push("foo");r.push("bar");r.push("baz")});it("running",e=>{var t=async.cargo((e,a)=>{expect(t.running()).to.equal(1);async.setImmediate(()=>{expect(t.running()).to.equal(1);a()})},2);t.drain(()=>{expect(t.running()).to.equal(0);e()});t.push("foo");t.push("bar");t.push("baz")})});