import{findDOM}from"../utils";function queryBat(e,t){const h=[];e.forEach(e=>{const{selector:t,single:s,fields:o,component:i}=e;const l=i!==null?findDOM(i)||document:document;let r=false;if(l!==document){const n=l.parentNode.querySelectorAll(t);for(let e=0,t=n.length;e<t;++e){if(l===n[e]){r=true;break}}}if(s){const c=r===true?l:l.querySelector(t);h.push(filter(o,c,t))}else{const u=l.querySelectorAll(t);const f=[];r===true&&f.push(l);for(let e=0,t=u.length;e<t;++e){f.push(u[e])}h.push(f.map(e=>filter(o,e)))}});t(h)}function filter(e,s,t){if(!s)return null;const{id:o,dataset:i,rect:l,size:r,scrollOffset:n,properties:c=[],computedStyle:u=[]}=e;const{left:f,right:h,top:p,bottom:d,width:a,height:_}=s.getBoundingClientRect();const g=t==="html";const m={};if(o)m.id=s.id;if(i)m.dataset=Object.assign({},s.dataset);if(l){if(!g){m.left=f;m.right=h;m.top=p;m.bottom=d}else{m.left=0;m.right=0;m.top=0;m.bottom=0}}if(r){if(!g){m.width=a;m.height=_}else{m.width=s.clientWidth;m.height=s.clientHeight}}if(n){m.scrollLeft=s.scrollLeft;m.scrollTop=s.scrollTop}if(c.length){c.forEach(e=>{const t=s.getAttribute(e);if(t)m[e]=t})}if(u.length){const y=window.getComputedStyle(s);u.forEach(e=>{const t=y.getPropertyValue(e)||y[e];if(t)m[e]=t})}return m}class Query{constructor(){this._defaultWebviewId=null;this._webviewId=null;this._queue=[];this._queueCb=[];this._component=null}in(e){this._component=e;return this}select(e){if(typeof e==="string")e=e.replace(">>>",">");return new NodesRef(e,this,true)}selectAll(e){if(typeof e==="string")e=e.replace(">>>",">");return new NodesRef(e,this,false)}selectViewport(){return new NodesRef("html",this,true)}exec(t){queryBat(this._queue,e=>{const s=this._queueCb;e.forEach((e,t)=>{typeof s[t]==="function"&&s[t].call(this,e)});typeof t==="function"&&t.call(this,e)})}_push(e,t,s,o,i=null){this._queue.push({component:t,selector:e,single:s,fields:o});this._queueCb.push(i)}}class NodesRef{constructor(e,t,s){this._component=t._component;this._selector=e;this._selectorQuery=t;this._single=s}boundingClientRect(e){const{_selector:t,_component:s,_single:o,_selectorQuery:i}=this;i._push(t,s,o,{id:!0,dataset:!0,rect:!0,size:!0},e);return i}scrollOffset(e){const{_selector:t,_component:s,_single:o,_selectorQuery:i}=this;i._push(t,s,o,{id:!0,dataset:!0,scrollOffset:!0},e);return i}fields(e,t){const{_selector:s,_component:o,_single:i,_selectorQuery:l}=this;const{id:r,dataset:n,rect:c,size:u,scrollOffset:f,properties:h=[],computedStyle:p=[]}=e;l._push(s,o,i,{id:r,dataset:n,rect:c,size:u,scrollOffset:f,properties:h,computedStyle:p},t);return l}}export function createSelectorQuery(){return new Query}