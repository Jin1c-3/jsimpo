const uuid=require("uuid");const{encode,decode}=require("arson");const{MESSAGE,RESPONSE,PING,PONG}=require("./types.js");const hasOwn=Object.prototype.hasOwnProperty;Object.assign(exports,{enable(c){if(typeof c.onMessage==="function"&&typeof c.sendMessage==="function"){return c}const r=new Map;c.onMessage=function e(s,n){if(!r.has(s)){r.set(s,new Set)}r.get(s).add(n)};const d=new Map;const i=new Map;const s=new Map;const n=Object.create(null);function a(e){if(e&&e.code!=="EPIPE"){console.error("Error sending message:",e)}}n[PING]=function({id:e}){c.send({type:PONG,id:e},a)};n[PONG]=function({id:e}){const s=d.get(e);if(typeof s==="function"){d.delete(e);s()}};n[MESSAGE]=function({responseId:o,topic:n,encodedPayload:t}){const e=(s.get(n)||Promise.resolve()).then(()=>{const s=[];const e=r.get(n);if(e&&e.size>0){e.forEach(e=>s.push(e(decode(t))));return Promise.all(s)}return s}).then(e=>{if(o){c.send({type:RESPONSE,responseId:o,encodedResults:encode(e)},a)}},s=>{const n={};Reflect.ownKeys(s).forEach(e=>{n[e]=s[e]});c.send({type:RESPONSE,responseId:o,encodedError:encode(n)},a)});s.set(n,e)};n[RESPONSE]=function(e){const s=i.get(e.responseId);if(s){if(hasOwn.call(e,"encodedError")){s.reject(decode(e.encodedError))}else{s.resolve(decode(e.encodedResults))}}};c.on("message",e=>{const s=n[e.type];if(typeof s==="function"){s(e)}});c.sendMessage=function e(o,t){c.readyForMessages=c.readyForMessages||u();return c.readyForMessages.then(()=>{const n=uuid();return new Promise((e,s)=>{i.set(n,{resolve:e,reject:s});c.send({type:MESSAGE,responseId:n,topic:o,encodedPayload:encode(t)},e=>{if(e){s(e)}})}).then(e=>{i.delete(n);return e},e=>{i.delete(n);throw e})})};function u(){return new Promise((e,s)=>{const n={type:PING,id:uuid()};const o=1.1;let t=50;d.set(n.id,e);function r(){if(d.has(n.id)){c.send(n,e=>{if(e){s(e)}else{setTimeout(r,t);t*=o}})}}r()})}c.on("exit",(e,s)=>{const n=new Error("process exited");Object.assign(n,{code:e,signal:s});i.forEach(e=>e.reject(n));c.readyForMessages=Promise.reject(n);c.readyForMessages.catch(()=>{})});return c},onMessage(e,s){}});if(typeof process.send==="function"){exports.enable(process);exports.onMessage=process.onMessage}