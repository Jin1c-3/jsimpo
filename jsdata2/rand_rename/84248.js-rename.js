var EventEmitter=require("events").EventEmitter;var spawn=require("child_process").spawn;var readlink=require("graceful-readlink").readlinkSync;var path=require("path");var dirname=path.dirname;var basename=path.basename;var fs=require("fs");exports=module.exports=new Command;exports.Command=Command;exports.Option=Option;function Option(t,e){this.flags=t;this.required=~t.indexOf("<");this.optional=~t.indexOf("[");this.bool=!~t.indexOf("-no-");t=t.split(/[ ,|]+/);if(t.length>1&&!/^[[<]/.test(t[1]))this.short=t.shift();this.long=t.shift();this.description=e||""}Option.prototype.name=function(){return this.long.replace("--","").replace("no-","")};Option.prototype.is=function(t){return t==this.short||t==this.long};function Command(t){this.commands=[];this.options=[];this._execs={};this._allowUnknownOption=false;this._args=[];this._name=t||""}Command.prototype.__proto__=EventEmitter.prototype;Command.prototype.command=function(t,e,n){n=n||{};var i=t.split(/ +/);var o=new Command(i.shift());if(e){o.description(e);this.executables=true;this._execs[o._name]=true;if(n.isDefault)this.defaultExecutable=o._name}o._noHelp=!!n.noHelp;this.commands.push(o);o.parseExpectedArgs(i);o.parent=this;if(e)return this;return o};Command.prototype.arguments=function(t){return this.parseExpectedArgs(t.split(/ +/))};Command.prototype.addImplicitHelpCommand=function(){this.command("help [cmd]","display help for [cmd]")};Command.prototype.parseExpectedArgs=function(t){if(!t.length)return;var n=this;t.forEach(function(t){var e={required:false,name:"",variadic:false};switch(t[0]){case"<":e.required=true;e.name=t.slice(1,-1);break;case"[":e.name=t.slice(1,-1);break}if(e.name.length>3&&e.name.slice(-3)==="..."){e.variadic=true;e.name=e.name.slice(0,-3)}if(e.name){n._args.push(e)}});return this};Command.prototype.action=function(i){var o=this;var t=function(n,t){n=n||[];t=t||[];var e=o.parseOptions(t);outputHelpIfNecessary(o,e.unknown);if(e.unknown.length>0){o.unknownOption(e.unknown[0])}if(e.args.length)n=e.args.concat(n);o._args.forEach(function(t,e){if(t.required&&null==n[e]){o.missingArgument(t.name)}else if(t.variadic){if(e!==o._args.length-1){o.variadicArgNotLast(t.name)}n[e]=n.splice(e)}});if(o._args.length){n[o._args.length]=o}else{n.push(o)}i.apply(o,n)};var e=this.parent||this;var n=e===this?"*":this._name;e.on(n,t);if(this._alias)e.on(this._alias,t);return this};Command.prototype.option=function(t,e,n,i){var o=this,r=new Option(t,e),s=r.name(),a=camelcase(s);if(typeof n!="function"){if(n instanceof RegExp){var p=n;n=function(t,e){var n=p.exec(t);return n?n[0]:e}}else{i=n;n=null}}if(false==r.bool||r.optional||r.required){if(false==r.bool)i=true;if(undefined!==i)o[a]=i}this.options.push(r);this.on(s,function(t){if(null!==t&&n)t=n(t,undefined===o[a]?i:o[a]);if("boolean"==typeof o[a]||"undefined"==typeof o[a]){if(null==t){o[a]=r.bool?i||true:false}else{o[a]=t}}else if(null!==t){o[a]=t}});return this};Command.prototype.allowUnknownOption=function(t){this._allowUnknownOption=arguments.length===0||t;return this};Command.prototype.parse=function(t){if(this.executables)this.addImplicitHelpCommand();this.rawArgs=t;this._name=this._name||basename(t[1],".js");if(this.executables&&t.length<3&&!this.defaultExecutable){t.push("--help")}var e=this.parseOptions(this.normalize(t.slice(2)));var n=this.args=e.args;var i=this.parseArgs(this.args,e.unknown);var o=i.args[0];if(this._execs[o]&&typeof this._execs[o]!="function"){return this.executeSubCommand(t,n,e.unknown)}else if(this.defaultExecutable){n.unshift(o=this.defaultExecutable);return this.executeSubCommand(t,n,e.unknown)}return i};Command.prototype.executeSubCommand=function(t,e,n){e=e.concat(n);if(!e.length)this.help();if("help"==e[0]&&1==e.length)this.help();if("help"==e[0]){e[0]=e[1];e[1]="--help"}var i=t[1];var o=basename(i,".js")+"-"+e[0];var r,s=readlink(i);if(s!==i&&s.charAt(0)!=="/"){s=path.join(dirname(i),s)}r=dirname(s);var a=path.join(r,o);var p=false;if(exists(a+".js")){o=a+".js";p=true}else if(exists(a)){o=a}e=e.slice(1);var u;if(process.platform!=="win32"){if(p){e.unshift(a);e=(process.execArgv||[]).concat(e);u=spawn("node",e,{stdio:"inherit",customFds:[0,1,2]})}else{u=spawn(o,e,{stdio:"inherit",customFds:[0,1,2]})}}else{e.unshift(a);u=spawn(process.execPath,e,{stdio:"inherit"})}u.on("close",process.exit.bind(process));u.on("error",function(t){if(t.code=="ENOENT"){console.error("\n  %s(1) does not exist, try --help\n",o)}else if(t.code=="EACCES"){console.error("\n  %s(1) not executable. try chmod or run with root\n",o)}process.exit(1)});this.runningCommand=u};Command.prototype.normalize=function(t){var e=[],n,i,o;for(var r=0,s=t.length;r<s;++r){n=t[r];if(r>0){i=this.optionFor(t[r-1])}if(n==="--"){e=e.concat(t.slice(r));break}else if(i&&i.required){e.push(n)}else if(n.length>1&&"-"==n[0]&&"-"!=n[1]){n.slice(1).split("").forEach(function(t){e.push("-"+t)})}else if(/^--/.test(n)&&~(o=n.indexOf("="))){e.push(n.slice(0,o),n.slice(o+1))}else{e.push(n)}}return e};Command.prototype.parseArgs=function(t,e){var n;if(t.length){n=t[0];if(this.listeners(n).length){this.emit(t.shift(),t,e)}else{this.emit("*",t)}}else{outputHelpIfNecessary(this,e);if(e.length>0){this.unknownOption(e[0])}}return this};Command.prototype.optionFor=function(t){for(var e=0,n=this.options.length;e<n;++e){if(this.options[e].is(t)){return this.options[e]}}};Command.prototype.parseOptions=function(t){var e=[],n=t.length,i,o,r;var s=[];for(var a=0;a<n;++a){r=t[a];if("--"==r){i=true;continue}if(i){e.push(r);continue}o=this.optionFor(r);if(o){if(o.required){r=t[++a];if(null==r)return this.optionMissingArgument(o);this.emit(o.name(),r)}else if(o.optional){r=t[a+1];if(null==r||"-"==r[0]&&"-"!=r){r=null}else{++a}this.emit(o.name(),r)}else{this.emit(o.name())}continue}if(r.length>1&&"-"==r[0]){s.push(r);if(t[a+1]&&"-"!=t[a+1][0]){s.push(t[++a])}continue}e.push(r)}return{args:e,unknown:s}};Command.prototype.opts=function(){var t={},e=this.options.length;for(var n=0;n<e;n++){var i=camelcase(this.options[n].name());t[i]=i==="version"?this._version:this[i]}return t};Command.prototype.missingArgument=function(t){console.error();console.error("  error: missing required argument `%s'",t);console.error();process.exit(1)};Command.prototype.optionMissingArgument=function(t,e){console.error();if(e){console.error("  error: option `%s' argument missing, got `%s'",t.flags,e)}else{console.error("  error: option `%s' argument missing",t.flags)}console.error();process.exit(1)};Command.prototype.unknownOption=function(t){if(this._allowUnknownOption)return;console.error();console.error("  error: unknown option `%s'",t);console.error();process.exit(1)};Command.prototype.variadicArgNotLast=function(t){console.error();console.error("  error: variadic arguments must be last `%s'",t);console.error();process.exit(1)};Command.prototype.version=function(t,e){if(0==arguments.length)return this._version;this._version=t;e=e||"-V, --version";this.option(e,"output the version number");this.on("version",function(){process.stdout.write(t+"\n");process.exit(0)});return this};Command.prototype.description=function(t){if(0===arguments.length)return this._description;this._description=t;return this};Command.prototype.alias=function(t){if(0==arguments.length)return this._alias;this._alias=t;return this};Command.prototype.usage=function(t){var e=this._args.map(function(t){return humanReadableArgName(t)});var n="[options]"+(this.commands.length?" [command]":"")+(this._args.length?" "+e.join(" "):"");if(0==arguments.length)return this._usage||n;this._usage=t;return this};Command.prototype.name=function(){return this._name};Command.prototype.largestOptionLength=function(){return this.options.reduce(function(t,e){return Math.max(t,e.flags.length)},0)};Command.prototype.optionHelp=function(){var e=this.largestOptionLength();return[pad("-h, --help",e)+"  "+"output usage information"].concat(this.options.map(function(t){return pad(t.flags,e)+"  "+t.description})).join("\n")};Command.prototype.commandHelp=function(){if(!this.commands.length)return"";var t=this.commands.filter(function(t){return!t._noHelp}).map(function(t){var e=t._args.map(function(t){return humanReadableArgName(t)}).join(" ");return[t._name+(t._alias?"|"+t._alias:"")+(t.options.length?" [options]":"")+" "+e,t.description()]});var n=t.reduce(function(t,e){return Math.max(t,e[0].length)},0);return["","  Commands:","",t.map(function(t){var e=t[1]?"  "+t[1]:"";return pad(t[0],n)+e}).join("\n").replace(/^/gm,"    "),""].join("\n")};Command.prototype.helpInformation=function(){var t=[];if(this._description){t=["  "+this._description,""]}var e=this._name;if(this._alias){e=e+"|"+this._alias}var n=["","  Usage: "+e+" "+this.usage(),""];var i=[];var o=this.commandHelp();if(o)i=[o];var r=["  Options:","",""+this.optionHelp().replace(/^/gm,"    "),"",""];return n.concat(i).concat(t).concat(r).join("\n")};Command.prototype.outputHelp=function(t){if(!t){t=function(t){return t}}process.stdout.write(t(this.helpInformation()));this.emit("--help")};Command.prototype.help=function(t){this.outputHelp(t);process.exit()};function camelcase(t){return t.split("-").reduce(function(t,e){return t+e[0].toUpperCase()+e.slice(1)})}function pad(t,e){var n=Math.max(0,e-t.length);return t+Array(n+1).join(" ")}function outputHelpIfNecessary(t,e){e=e||[];for(var n=0;n<e.length;n++){if(e[n]=="--help"||e[n]=="-h"){t.outputHelp();process.exit(0)}}}function humanReadableArgName(t){var e=t.name+(t.variadic===true?"...":"");return t.required?"<"+e+">":"["+e+"]"}function exists(t){try{if(fs.statSync(t).isFile()){return true}}catch(t){return false}}