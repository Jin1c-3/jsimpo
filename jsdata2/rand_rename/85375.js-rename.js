var ArrayRemove=require("../../utils/array/Remove");var CameraEvents=require("../../cameras/2d/events");var Class=require("../../utils/Class");var CONST=require("../../const");var EventEmitter=require("eventemitter3");var Events=require("../events");var GameEvents=require("../../core/events");var IsSizePowerOfTwo=require("../../math/pow2/IsSizePowerOfTwo");var Matrix4=require("../../math/Matrix4");var NOOP=require("../../utils/NOOP");var PipelineManager=require("./PipelineManager");var RenderTarget=require("./RenderTarget");var ScaleEvents=require("../../scale/events");var TextureEvents=require("../../textures/events");var Utils=require("./Utils");var WebGLSnapshot=require("../snapshot/WebGLSnapshot");var WebGLRenderer=new Class({Extends:EventEmitter,initialize:function e(t){EventEmitter.call(this);var r=t.config;var i={alpha:r.transparent,desynchronized:r.desynchronized,depth:false,antialias:r.antialiasGL,premultipliedAlpha:r.premultipliedAlpha,stencil:true,failIfMajorPerformanceCaveat:r.failIfMajorPerformanceCaveat,powerPreference:r.powerPreference,preserveDrawingBuffer:r.preserveDrawingBuffer};this.config={clearBeforeRender:r.clearBeforeRender,antialias:r.antialias,backgroundColor:r.backgroundColor,contextCreation:i,roundPixels:r.roundPixels,maxTextures:r.maxTextures,maxTextureSize:r.maxTextureSize,batchSize:r.batchSize,maxLights:r.maxLights,mipmapFilter:r.mipmapFilter};this.game=t;this.type=CONST.WEBGL;this.pipelines=null;this.width=0;this.height=0;this.canvas=t.canvas;this.blendModes=[];this.contextLost=false;this.snapshotState={x:0,y:0,width:1,height:1,getPixel:false,callback:null,type:"image/png",encoder:.92,isFramebuffer:false,bufferWidth:0,bufferHeight:0};this.currentActiveTexture=0;this.startActiveTexture=0;this.maxTextures=0;this.textureIndexes;this.tempTextures;this.textureZero;this.normalTexture;this.currentFramebuffer=null;this.fboStack=[];this.currentProgram=null;this.currentBlendMode=Infinity;this.currentScissorEnabled=false;this.currentScissor=null;this.scissorStack=[];this.contextLostHandler=NOOP;this.contextRestoredHandler=NOOP;this.gl=null;this.supportedExtensions=null;this.instancedArraysExtension=null;this.vaoExtension=null;this.extensions={};this.glFormats=[];this.compression={ETC1:false,PVRTC:false,S3TC:false};this.drawingBufferHeight=0;this.blankTexture=null;this.whiteTexture=null;this.maskCount=0;this.maskStack=[];this.currentMask={mask:null,camera:null};this.currentCameraMask={mask:null,camera:null};this.glFuncMap=null;this.currentType="";this.newType=false;this.nextTypeMatch=false;this.finalType=false;this.mipmapFilter=null;this.textureFlush=0;this.isTextureClean=false;this.defaultScissor=[0,0,0,0];this.isBooted=false;this.renderTarget=null;this.projectionMatrix;this.projectionWidth=0;this.projectionHeight=0;this.init(this.config)},init:function(e){var t;var r=this.game;var i=this.canvas;var s=e.backgroundColor;if(r.config.context){t=r.config.context}else{t=i.getContext("webgl",e.contextCreation)||i.getContext("experimental-webgl",e.contextCreation)}if(!t||t.isContextLost()){this.contextLost=true;throw new Error("WebGL unsupported")}this.gl=t;var n=this;this.contextLostHandler=function(e){n.contextLost=true;n.game.events.emit(GameEvents.CONTEXT_LOST,n);e.preventDefault()};this.contextRestoredHandler=function(){n.contextLost=false;n.init(n.config);n.game.events.emit(GameEvents.CONTEXT_RESTORED,n)};i.addEventListener("webglcontextlost",this.contextLostHandler,false);i.addEventListener("webglcontextrestored",this.contextRestoredHandler,false);r.context=t;for(var a=0;a<=27;a++){this.blendModes.push({func:[t.ONE,t.ONE_MINUS_SRC_ALPHA],equation:t.FUNC_ADD})}this.blendModes[1].func=[t.ONE,t.DST_ALPHA];this.blendModes[2].func=[t.DST_COLOR,t.ONE_MINUS_SRC_ALPHA];this.blendModes[3].func=[t.ONE,t.ONE_MINUS_SRC_COLOR];this.blendModes[17]={func:[t.ZERO,t.ONE_MINUS_SRC_ALPHA],equation:t.FUNC_REVERSE_SUBTRACT};this.glFormats[0]=t.BYTE;this.glFormats[1]=t.SHORT;this.glFormats[2]=t.UNSIGNED_BYTE;this.glFormats[3]=t.UNSIGNED_SHORT;this.glFormats[4]=t.FLOAT;this.glFuncMap={mat2:{func:t.uniformMatrix2fv,length:1,matrix:true},mat3:{func:t.uniformMatrix3fv,length:1,matrix:true},mat4:{func:t.uniformMatrix4fv,length:1,matrix:true},"1f":{func:t.uniform1f,length:1},"1fv":{func:t.uniform1fv,length:1},"1i":{func:t.uniform1i,length:1},"1iv":{func:t.uniform1iv,length:1},"2f":{func:t.uniform2f,length:2},"2fv":{func:t.uniform2fv,length:1},"2i":{func:t.uniform2i,length:2},"2iv":{func:t.uniform2iv,length:1},"3f":{func:t.uniform3f,length:3},"3fv":{func:t.uniform3fv,length:1},"3i":{func:t.uniform3i,length:3},"3iv":{func:t.uniform3iv,length:1},"4f":{func:t.uniform4f,length:4},"4fv":{func:t.uniform4fv,length:1},"4i":{func:t.uniform4i,length:4},"4iv":{func:t.uniform4iv,length:1}};var u=t.getSupportedExtensions();if(!e.maxTextures||e.maxTextures===-1){e.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS)}if(!e.maxTextureSize){e.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE)}var h="WEBGL_compressed_texture_";var f="WEBKIT_"+h;this.compression.ETC1=t.getExtension(h+"etc1")||t.getExtension(f+"etc1");this.compression.PVRTC=t.getExtension(h+"pvrtc")||t.getExtension(f+"pvrtc");this.compression.S3TC=t.getExtension(h+"s3tc")||t.getExtension(f+"s3tc");this.supportedExtensions=u;var o="ANGLE_instanced_arrays";this.instancedArraysExtension=u.indexOf(o)>-1?t.getExtension(o):null;var l="OES_vertex_array_object";this.vaoExtension=u.indexOf(l)>-1?t.getExtension(l):null;t.disable(t.DEPTH_TEST);t.disable(t.CULL_FACE);t.enable(t.BLEND);t.clearColor(s.redGL,s.greenGL,s.blueGL,s.alphaGL);this.mipmapFilter=t[e.mipmapFilter];this.maxTextures=Utils.checkShaderMax(t,e.maxTextures);this.textureIndexes=[];var c=this.tempTextures;if(Array.isArray(c)){for(var T=0;a<this.maxTextures;T++){t.deleteTexture(c[T])}}else{c=new Array(this.maxTextures)}for(var d=0;d<this.maxTextures;d++){var E=t.createTexture();t.activeTexture(t.TEXTURE0+d);t.bindTexture(t.TEXTURE_2D,E);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,255,255]));c[d]=E;this.textureIndexes.push(d)}this.tempTextures=c;this.currentActiveTexture=1;this.startActiveTexture++;t.activeTexture(t.TEXTURE1);this.pipelines=new PipelineManager(this);this.setBlendMode(CONST.BlendModes.NORMAL);this.projectionMatrix=(new Matrix4).identity();r.textures.once(TextureEvents.READY,this.boot,this);return this},boot:function(){var e=this.game;var t=this.pipelines;var r=e.scale.baseSize;this.width=r.width;this.height=r.height;this.isBooted=true;this.renderTarget=new RenderTarget(this,this.width,this.height,1,0,true,true);t.boot(e.config.pipeline);this.blankTexture=e.textures.getFrame("__DEFAULT");this.whiteTexture=e.textures.getFrame("__WHITE");var i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,null);i.enable(i.SCISSOR_TEST);e.scale.on(ScaleEvents.RESIZE,this.onResize,this);this.resize(r.width,r.height)},onResize:function(e,t){if(t.width!==this.width||t.height!==this.height){this.resize(t.width,t.height)}},beginCapture:function(e,t){if(e===undefined){e=this.width}if(t===undefined){t=this.height}this.renderTarget.bind(true,e,t);this.setProjectionMatrix(e,t);this.resetTextures()},endCapture:function(){this.renderTarget.unbind(true);this.resetProjectionMatrix();return this.renderTarget},resize:function(e,t){var r=this.gl;this.width=e;this.height=t;this.setProjectionMatrix(e,t);r.viewport(0,0,e,t);this.drawingBufferHeight=r.drawingBufferHeight;r.scissor(0,r.drawingBufferHeight-t,e,t);this.defaultScissor[2]=e;this.defaultScissor[3]=t;this.emit(Events.RESIZE,e,t);return this},getAspectRatio:function(){return this.width/this.height},setProjectionMatrix:function(e,t){if(e!==this.projectionWidth||t!==this.projectionHeight){this.projectionWidth=e;this.projectionHeight=t;this.projectionMatrix.ortho(0,e,t,0,-1e3,1e3)}return this},resetProjectionMatrix:function(){this.projectionWidth=this.width;this.projectionHeight=this.height;this.projectionMatrix.ortho(0,this.width,this.height,0,-1e3,1e3)},hasExtension:function(e){return this.supportedExtensions?this.supportedExtensions.indexOf(e):false},getExtension:function(e){if(!this.hasExtension(e)){return null}if(!(e in this.extensions)){this.extensions[e]=this.gl.getExtension(e)}return this.extensions[e]},flush:function(){this.pipelines.flush()},pushScissor:function(e,t,r,i,s){if(s===undefined){s=this.drawingBufferHeight}var n=this.scissorStack;var a=[e,t,r,i];n.push(a);this.setScissor(e,t,r,i,s);this.currentScissor=a;return a},setScissor:function(e,t,r,i,s){if(s===undefined){s=this.drawingBufferHeight}var n=this.gl;var a=this.currentScissor;var u=r>0&&i>0;if(a&&u){var h=a[0];var f=a[1];var o=a[2];var l=a[3];u=h!==e||f!==t||o!==r||l!==i}if(u){this.flush();n.scissor(e,s-t-i,r,i)}},resetScissor:function(){var e=this.gl;e.enable(e.SCISSOR_TEST);var t=this.currentScissor;if(t){var r=t[0];var i=t[1];var s=t[2];var n=t[3];if(s>0&&n>0){e.scissor(r,this.drawingBufferHeight-i-n,s,n)}}},popScissor:function(){var e=this.scissorStack;e.pop();var t=e[e.length-1];if(t){this.setScissor(t[0],t[1],t[2],t[3])}this.currentScissor=t},hasActiveStencilMask:function(){var e=this.currentMask.mask;var t=this.currentCameraMask.mask;return e&&e.isStencil||t&&t.isStencil},resetViewport:function(){var e=this.gl;e.viewport(0,0,this.width,this.height);this.drawingBufferHeight=e.drawingBufferHeight},setBlendMode:function(e,t){if(t===undefined){t=false}var r=this.gl;var i=this.blendModes[e];if(t||e!==CONST.BlendModes.SKIP_CHECK&&this.currentBlendMode!==e){this.flush();r.enable(r.BLEND);r.blendEquation(i.equation);if(i.func.length>2){r.blendFuncSeparate(i.func[0],i.func[1],i.func[2],i.func[3])}else{r.blendFunc(i.func[0],i.func[1])}this.currentBlendMode=e;return true}return false},addBlendMode:function(e,t){var r=this.blendModes.push({func:e,equation:t});return r-1},updateBlendMode:function(e,t,r){if(this.blendModes[e]){this.blendModes[e].func=t;if(r){this.blendModes[e].equation=r}}return this},removeBlendMode:function(e){if(e>17&&this.blendModes[e]){this.blendModes.splice(e,1)}return this},setBlankTexture:function(){this.setTexture2D(this.blankTexture.glTexture)},setTextureSource:function(e){if(this.pipelines.forceZero()){this.setTextureZero(e.glTexture,true);return 0}var t=this.gl;var r=this.currentActiveTexture;if(e.glIndexCounter<this.startActiveTexture){e.glIndexCounter=this.startActiveTexture;if(r<this.maxTextures){e.glIndex=r;t.activeTexture(t.TEXTURE0+r);t.bindTexture(t.TEXTURE_2D,e.glTexture);this.currentActiveTexture++}else{this.flush();this.startActiveTexture++;this.textureFlush++;e.glIndexCounter=this.startActiveTexture;e.glIndex=1;t.activeTexture(t.TEXTURE1);t.bindTexture(t.TEXTURE_2D,e.glTexture);this.currentActiveTexture=2}}this.isTextureClean=false;return e.glIndex},isNewNormalMap:function(e,t){return this.textureZero!==e||this.normalTexture!==t},setTextureZero:function(e,t){if(this.textureZero!==e){if(t){this.flush()}var r=this.gl;r.activeTexture(r.TEXTURE0);r.bindTexture(r.TEXTURE_2D,e);this.textureZero=e}},clearTextureZero:function(){this.textureZero=null},setNormalMap:function(e){if(this.normalTexture!==e){var t=this.gl;t.activeTexture(t.TEXTURE1);t.bindTexture(t.TEXTURE_2D,e);this.normalTexture=e;if(this.currentActiveTexture===1){this.currentActiveTexture=2}}},clearNormalMap:function(){this.normalTexture=null;this.startActiveTexture++;this.currentActiveTexture=1;this.textureFlush++},unbindTextures:function(){var e=this.gl;var t=this.tempTextures;for(var r=0;r<t.length;r++){e.activeTexture(e.TEXTURE0+r);e.bindTexture(e.TEXTURE_2D,null)}this.normalTexture=null;this.textureZero=null;this.currentActiveTexture=1;this.startActiveTexture++;this.textureFlush++},resetTextures:function(e){if(e===undefined){e=false}if(this.isTextureClean){return}this.flush();var t=this.gl;var r=this.tempTextures;if(e){for(var i=0;i<r.length;i++){t.activeTexture(t.TEXTURE0+i);t.bindTexture(t.TEXTURE_2D,r[i])}t.activeTexture(t.TEXTURE1);t.bindTexture(t.TEXTURE_2D,r[1]);this.isTextureClean=true}else{t.activeTexture(t.TEXTURE0);t.bindTexture(t.TEXTURE_2D,r[0]);t.activeTexture(t.TEXTURE1);t.bindTexture(t.TEXTURE_2D,r[1])}this.normalTexture=null;this.textureZero=null;this.currentActiveTexture=1;this.startActiveTexture++;this.textureFlush++},setTexture2D:function(e){if(this.pipelines.forceZero()){this.setTextureZero(e,true);return 0}var t=this.gl;var r=this.currentActiveTexture;if(e.glIndexCounter<this.startActiveTexture){e.glIndexCounter=this.startActiveTexture;if(r<this.maxTextures){e.glIndex=r;t.activeTexture(t.TEXTURE0+r);t.bindTexture(t.TEXTURE_2D,e);this.currentActiveTexture++}else{this.flush();this.startActiveTexture++;this.textureFlush++;e.glIndexCounter=this.startActiveTexture;e.glIndex=1;t.activeTexture(t.TEXTURE1);t.bindTexture(t.TEXTURE_2D,e);this.currentActiveTexture=2}}this.isTextureClean=false;return e.glIndex},pushFramebuffer:function(e,t,r,i){if(e===this.currentFramebuffer){return this}this.fboStack.push(e);return this.setFramebuffer(e,t,r,i)},setFramebuffer:function(e,t,r,i){if(t===undefined){t=false}if(r===undefined){r=false}if(i===undefined){i=true}if(e===this.currentFramebuffer){return this}var s=this.gl;var n=this.width;var a=this.height;if(e&&e.renderTexture&&i){n=e.renderTexture.width;a=e.renderTexture.height}else{this.flush()}s.bindFramebuffer(s.FRAMEBUFFER,e);if(i){s.viewport(0,0,n,a)}if(t){if(e){this.drawingBufferHeight=a;this.pushScissor(0,0,n,a)}else{this.drawingBufferHeight=this.height;this.popScissor()}}this.currentFramebuffer=e;if(r){this.resetTextures()}return this},popFramebuffer:function(e,t,r){if(e===undefined){e=false}if(t===undefined){t=false}if(r===undefined){r=true}var i=this.fboStack;i.pop();var s=i[i.length-1];if(!s){s=null}this.setFramebuffer(s,e,t,r);return s},setProgram:function(e){if(e!==this.currentProgram){this.flush();this.gl.useProgram(e);this.currentProgram=e;return true}return false},resetProgram:function(){this.gl.useProgram(this.currentProgram);return this},createTextureFromSource:function(e,t,r,i){var s=this.gl;var n=s.NEAREST;var a=s.NEAREST;var u=s.CLAMP_TO_EDGE;var h=null;t=e?e.width:t;r=e?e.height:r;var f=IsSizePowerOfTwo(t,r);if(f){u=s.REPEAT}if(i===CONST.ScaleModes.LINEAR&&this.config.antialias){n=f?this.mipmapFilter:s.LINEAR;a=s.LINEAR}if(!e&&typeof t==="number"&&typeof r==="number"){h=this.createTexture2D(0,n,a,u,u,s.RGBA,null,t,r)}else{h=this.createTexture2D(0,n,a,u,u,s.RGBA,e)}return h},createTexture2D:function(e,t,r,i,s,n,a,u,h,f,o,l){f=f===undefined||f===null?true:f;if(o===undefined){o=false}if(l===undefined){l=false}var c=this.gl;var T=c.createTexture();c.activeTexture(c.TEXTURE0);var d=c.getParameter(c.TEXTURE_BINDING_2D);c.bindTexture(c.TEXTURE_2D,T);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,t);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,r);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,s);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,i);c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,f);c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,l);if(a===null||a===undefined){c.texImage2D(c.TEXTURE_2D,e,n,u,h,0,n,c.UNSIGNED_BYTE,null)}else{if(!o){u=a.width;h=a.height}c.texImage2D(c.TEXTURE_2D,e,n,n,c.UNSIGNED_BYTE,a)}if(IsSizePowerOfTwo(u,h)){c.generateMipmap(c.TEXTURE_2D)}if(d){c.bindTexture(c.TEXTURE_2D,d)}T.isAlphaPremultiplied=f;T.isRenderTexture=false;T.width=u;T.height=h;T.glIndex=0;T.glIndexCounter=-1;return T},createFramebuffer:function(e,t,r,i){var s=this.gl;var n=s.createFramebuffer();var a=0;this.setFramebuffer(n);if(i){var u=s.createRenderbuffer();s.bindRenderbuffer(s.RENDERBUFFER,u);s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_STENCIL,e,t);s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,u)}r.isRenderTexture=true;r.isAlphaPremultiplied=false;s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,r,0);a=s.checkFramebufferStatus(s.FRAMEBUFFER);if(a!==s.FRAMEBUFFER_COMPLETE){var h={36054:"Incomplete Attachment",36055:"Missing Attachment",36057:"Incomplete Dimensions",36061:"Framebuffer Unsupported"};throw new Error("Framebuffer status: "+h[a])}n.renderTexture=r;this.setFramebuffer(null);this.resetTextures();return n},createProgram:function(e,t){var r=this.gl;var i=r.createProgram();var s=r.createShader(r.VERTEX_SHADER);var n=r.createShader(r.FRAGMENT_SHADER);r.shaderSource(s,e);r.shaderSource(n,t);r.compileShader(s);r.compileShader(n);if(!r.getShaderParameter(s,r.COMPILE_STATUS)){throw new Error("Vertex Shader failed:\n"+r.getShaderInfoLog(s))}if(!r.getShaderParameter(n,r.COMPILE_STATUS)){throw new Error("Fragment Shader failed:\n"+r.getShaderInfoLog(n))}r.attachShader(i,s);r.attachShader(i,n);r.linkProgram(i);if(!r.getProgramParameter(i,r.LINK_STATUS)){throw new Error("Link Program failed:\n"+r.getProgramInfoLog(i))}r.useProgram(i);return i},createVertexBuffer:function(e,t){var r=this.gl;var i=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,i);r.bufferData(r.ARRAY_BUFFER,e,t);r.bindBuffer(r.ARRAY_BUFFER,null);return i},createIndexBuffer:function(e,t){var r=this.gl;var i=r.createBuffer();r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,i);r.bufferData(r.ELEMENT_ARRAY_BUFFER,e,t);r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null);return i},deleteTexture:function(e,t){if(t){this.resetTextures(true)}if(e){this.gl.deleteTexture(e)}return this},deleteFramebuffer:function(e){if(e){this.gl.deleteFramebuffer(e);ArrayRemove(this.fboStack,e);if(this.currentFramebuffer===e){this.currentFramebuffer=null}}return this},deleteProgram:function(e){if(e){this.gl.deleteProgram(e)}return this},deleteBuffer:function(e){this.gl.deleteBuffer(e);return this},preRenderCamera:function(e){var t=e.x;var r=e.y;var i=e.width;var s=e.height;var n=e.backgroundColor;e.emit(CameraEvents.PRE_RENDER,e);this.pipelines.preBatchCamera(e);this.pushScissor(t,r,i,s);if(e.mask){this.currentCameraMask.mask=e.mask;this.currentCameraMask.camera=e._maskCamera;e.mask.preRenderWebGL(this,e,e._maskCamera)}if(n.alphaGL>0){var a=this.pipelines.setMulti();a.drawFillRect(t,r,i,s,Utils.getTintFromFloats(n.blueGL,n.greenGL,n.redGL,1),n.alphaGL)}},getCurrentStencilMask:function(){var e=null;var t=this.maskStack;var r=this.currentCameraMask;if(t.length>0){e=t[t.length-1]}else if(r.mask&&r.mask.isStencil){e=r}return e},postRenderCamera:function(e){var t=e.flashEffect;var r=e.fadeEffect;if(t.isRunning||(r.isRunning||r.isComplete)){var i=this.pipelines.setMulti();t.postRenderWebGL(i,Utils.getTintFromFloats);r.postRenderWebGL(i,Utils.getTintFromFloats)}e.dirty=false;this.popScissor();if(e.mask){this.currentCameraMask.mask=null;e.mask.postRenderWebGL(this,e._maskCamera)}this.pipelines.postBatchCamera(e);e.emit(CameraEvents.POST_RENDER,e)},preRender:function(){if(this.contextLost){return}var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null);if(this.config.clearBeforeRender){var t=this.config.backgroundColor;e.clearColor(t.redGL,t.greenGL,t.blueGL,t.alphaGL);e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)}e.enable(e.SCISSOR_TEST);this.currentScissor=this.defaultScissor;this.scissorStack.length=0;this.scissorStack.push(this.currentScissor);if(this.game.scene.customViewports){e.scissor(0,this.drawingBufferHeight-this.height,this.width,this.height)}this.currentMask.mask=null;this.currentCameraMask.mask=null;this.maskStack.length=0;this.textureFlush=0;this.emit(Events.PRE_RENDER)},render:function(e,t,r){if(this.contextLost){return}var i=t.length;this.emit(Events.RENDER,e,r);this.preRenderCamera(r);if(i===0){this.setBlendMode(CONST.BlendModes.NORMAL);this.postRenderCamera(r);return}this.currentType="";var s=this.currentMask;for(var n=0;n<i;n++){this.finalType=n===i-1;var a=t[n];var u=a.mask;s=this.currentMask;if(s.mask&&s.mask!==u){s.mask.postRenderWebGL(this,s.camera)}if(u&&s.mask!==u){u.preRenderWebGL(this,a,r)}if(a.blendMode!==this.currentBlendMode){this.setBlendMode(a.blendMode)}var h=a.type;if(h!==this.currentType){this.newType=true;this.currentType=h}if(!this.finalType){this.nextTypeMatch=t[n+1].type===this.currentType}else{this.nextTypeMatch=false}a.renderWebGL(this,a,r);this.newType=false}s=this.currentMask;if(s.mask){s.mask.postRenderWebGL(this,s.camera)}this.setBlendMode(CONST.BlendModes.NORMAL);this.postRenderCamera(r)},postRender:function(){if(this.contextLost){return}this.flush();this.emit(Events.POST_RENDER);var e=this.snapshotState;if(e.callback){WebGLSnapshot(this.canvas,e);e.callback=null}if(this.textureFlush>0){this.startActiveTexture++;this.currentActiveTexture=1}},snapshot:function(e,t,r){return this.snapshotArea(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight,e,t,r)},snapshotArea:function(e,t,r,i,s,n,a){var u=this.snapshotState;u.callback=s;u.type=n;u.encoder=a;u.getPixel=false;u.x=e;u.y=t;u.width=Math.min(r,this.gl.drawingBufferWidth);u.height=Math.min(i,this.gl.drawingBufferHeight);return this},snapshotPixel:function(e,t,r){this.snapshotArea(e,t,1,1,r);this.snapshotState.getPixel=true;return this},snapshotFramebuffer:function(e,t,r,i,s,n,a,u,h,f,o){if(s===undefined){s=false}if(n===undefined){n=0}if(a===undefined){a=0}if(u===undefined){u=t}if(h===undefined){h=r}var l=this.currentFramebuffer;this.snapshotArea(n,a,u,h,i,f,o);var c=this.snapshotState;c.getPixel=s;c.isFramebuffer=true;c.bufferWidth=t;c.bufferHeight=r;this.setFramebuffer(e);WebGLSnapshot(this.canvas,c);this.setFramebuffer(l);c.callback=null;c.isFramebuffer=false;return this},canvasToTexture:function(e,t,r,i){if(r===undefined){r=false}if(i===undefined){i=false}if(!t){return this.createCanvasTexture(e,r,i)}else{return this.updateCanvasTexture(e,t,i)}},createCanvasTexture:function(e,t,r){if(t===undefined){t=false}if(r===undefined){r=false}var i=this.gl;var s=i.NEAREST;var n=i.NEAREST;var a=e.width;var u=e.height;var h=i.CLAMP_TO_EDGE;var f=IsSizePowerOfTwo(a,u);if(!t&&f){h=i.REPEAT}if(this.config.antialias){s=f?this.mipmapFilter:i.LINEAR;n=i.LINEAR}return this.createTexture2D(0,s,n,h,h,i.RGBA,e,a,u,true,false,r)},updateCanvasTexture:function(e,t,r){if(r===undefined){r=false}var i=this.gl;var s=e.width;var n=e.height;if(s>0&&n>0){i.activeTexture(i.TEXTURE0);var a=i.getParameter(i.TEXTURE_BINDING_2D);i.bindTexture(i.TEXTURE_2D,t);i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,r);i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,true);i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e);t.width=s;t.height=n;if(a){i.bindTexture(i.TEXTURE_2D,a)}}return t},createVideoTexture:function(e,t,r){if(t===undefined){t=false}if(r===undefined){r=false}var i=this.gl;var s=i.NEAREST;var n=i.NEAREST;var a=e.videoWidth;var u=e.videoHeight;var h=i.CLAMP_TO_EDGE;var f=IsSizePowerOfTwo(a,u);if(!t&&f){h=i.REPEAT}if(this.config.antialias){s=f?this.mipmapFilter:i.LINEAR;n=i.LINEAR}return this.createTexture2D(0,s,n,h,h,i.RGBA,e,a,u,true,true,r)},updateVideoTexture:function(e,t,r){if(r===undefined){r=false}var i=this.gl;var s=e.videoWidth;var n=e.videoHeight;if(s>0&&n>0){i.activeTexture(i.TEXTURE0);var a=i.getParameter(i.TEXTURE_BINDING_2D);i.bindTexture(i.TEXTURE_2D,t);i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,r);i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e);t.width=s;t.height=n;if(a){i.bindTexture(i.TEXTURE_2D,a)}}return t},setTextureFilter:function(e,t){var r=this.gl;var i=[r.LINEAR,r.NEAREST][t];r.activeTexture(r.TEXTURE0);var s=r.getParameter(r.TEXTURE_BINDING_2D);r.bindTexture(r.TEXTURE_2D,e);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,i);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,i);if(s){r.bindTexture(r.TEXTURE_2D,s)}return this},getMaxTextureSize:function(){return this.config.maxTextureSize},destroy:function(){this.canvas.removeEventListener("webglcontextlost",this.contextLostHandler,false);this.canvas.removeEventListener("webglcontextrestored",this.contextRestoredHandler,false);var e=this.gl;var t=this.tempTextures;for(var r=0;r<t.length;r++){e.deleteTexture(t[r])}this.pipelines.destroy();this.removeAllListeners();this.fboStack=[];this.maskStack=[];this.extensions={};this.textureIndexes=[];this.gl=null;this.game=null;this.canvas=null;this.contextLost=true;this.currentMask=null;this.currentCameraMask=null}});module.exports=WebGLRenderer;