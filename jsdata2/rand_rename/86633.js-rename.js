var Class=require("../../utils/Class");var FileTypesManager=require("../FileTypesManager");var GetFastValue=require("../../utils/object/GetFastValue");var ImageFile=require("./ImageFile.js");var IsPlainObject=require("../../utils/object/IsPlainObject");var JSONFile=require("./JSONFile.js");var MultiFile=require("../MultiFile.js");var MultiAtlasFile=new Class({Extends:MultiFile,initialize:function e(t,a,i,s,r,l,u){if(IsPlainObject(a)){var n=a;a=GetFastValue(n,"key");if(GetFastValue(n,"url",false)){i=GetFastValue(n,"url")}else{i=GetFastValue(n,"atlasURL")}l=GetFastValue(n,"xhrSettings");s=GetFastValue(n,"path");r=GetFastValue(n,"baseURL");u=GetFastValue(n,"textureXhrSettings")}var h=new JSONFile(t,a,i,l);MultiFile.call(this,t,"multiatlas",a,[h]);this.config.path=s;this.config.baseURL=r;this.config.textureXhrSettings=u},onFileComplete:function(e){var t=this.files.indexOf(e);if(t!==-1){this.pending--;if(e.type==="json"&&e.data.hasOwnProperty("textures")){var a=e.data.textures;var i=this.config;var s=this.loader;var r=s.baseURL;var l=s.path;var u=s.prefix;var n=GetFastValue(i,"baseURL",this.baseURL);var h=GetFastValue(i,"path",this.path);var f=GetFastValue(i,"prefix",this.prefix);var F=GetFastValue(i,"textureXhrSettings");s.setBaseURL(n);s.setPath(h);s.setPrefix(f);for(var v=0;v<a.length;v++){var o=a[v].image;var d="MA"+this.multiKeyIndex+"_"+o;var g=new ImageFile(s,d,o,F);this.addToMultiFile(g);s.addFile(g);if(a[v].normalMap){var p=new ImageFile(s,d,a[v].normalMap,F);p.type="normalMap";g.setLink(p);this.addToMultiFile(p);s.addFile(p)}}s.setBaseURL(r);s.setPath(l);s.setPrefix(u)}}},addToCache:function(){if(this.isReadyToProcess()){var e=this.files[0];var t=[];var a=[];var i=[];for(var s=1;s<this.files.length;s++){var r=this.files[s];if(r.type==="normalMap"){continue}var l=r.key.indexOf("_");var u=r.key.substr(l+1);var n=r.data;for(var h=0;h<e.data.textures.length;h++){var f=e.data.textures[h];if(f.image===u){a.push(n);t.push(f);if(r.linkFile){i.push(r.linkFile.data)}break}}}if(i.length===0){i=undefined}this.loader.textureManager.addAtlasJSONArray(this.key,a,t,i);this.complete=true;for(s=0;s<this.files.length;s++){this.files[s].pendingDestroy()}}}});FileTypesManager.register("multiatlas",function(e,t,a,i,s){var r;if(Array.isArray(e)){for(var l=0;l<e.length;l++){r=new MultiAtlasFile(this,e[l]);this.addFile(r.files)}}else{r=new MultiAtlasFile(this,e,t,a,i,s);this.addFile(r.files)}return this});module.exports=MultiAtlasFile;