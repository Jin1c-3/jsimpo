import marked from"marked";const DEFAULT_SLIDE_SEPARATOR="\r?\n---\r?\n",DEFAULT_NOTES_SEPARATOR="notes?:",DEFAULT_ELEMENT_ATTRIBUTES_SEPARATOR="\\.element\\s*?(.+?)$",DEFAULT_SLIDE_ATTRIBUTES_SEPARATOR="\\.slide:\\s*?(\\S.+?)$";const SCRIPT_END_PLACEHOLDER="__SCRIPT_END__";const CODE_LINE_NUMBER_REGEX=/\[([\s\d,|-]*)\]/;const HTML_ESCAPE_MAP={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};const Plugin=()=>{let n;function a(e){var t=e.querySelector("[data-template]")||e.querySelector("script");var r=(t||e).textContent;r=r.replace(new RegExp(SCRIPT_END_PLACEHOLDER,"g"),"<\/script>");var a=r.match(/^\n?(\s*)/)[1].length,n=r.match(/^\n?(\t*)/)[1].length;if(n>0){r=r.replace(new RegExp("\\n?\\t{"+n+"}","g"),"\n")}else if(a>1){r=r.replace(new RegExp("\\n? {"+a+"}","g"),"\n")}return r}function i(e){var t=e.attributes;var r=[];for(var a=0,n=t.length;a<n;a++){var i=t[a].name,s=t[a].value;if(/data\-(markdown|separator|vertical|notes)/gi.test(i))continue;if(s){r.push(i+'="'+s+'"')}else{r.push(i)}}return r.join(" ")}function f(e){e=e||{};e.separator=e.separator||DEFAULT_SLIDE_SEPARATOR;e.notesSeparator=e.notesSeparator||DEFAULT_NOTES_SEPARATOR;e.attributes=e.attributes||"";return e}function m(e,t){t=f(t);var r=e.split(new RegExp(t.notesSeparator,"mgi"));if(r.length===2){e=r[0]+'<aside class="notes">'+marked(r[1].trim())+"</aside>"}e=e.replace(/<\/script>/g,SCRIPT_END_PLACEHOLDER);return'<script type="text/template">'+e+"<\/script>"}function s(e,t){t=f(t);var r=new RegExp(t.separator+(t.verticalSeparator?"|"+t.verticalSeparator:""),"mg"),a=new RegExp(t.separator);var n,i=0,s,o=true,u,l=[];while(n=r.exec(e)){var d=null;s=a.test(n[0]);if(!s&&o){l.push([])}u=e.substring(i,n.index);if(s&&o){l.push(u)}else{l[l.length-1].push(u)}i=r.lastIndex;o=s}(o?l:l[l.length-1]).push(e.substring(i));var c="";for(var E=0,p=l.length;E<p;E++){if(l[E]instanceof Array){c+="<section "+t.attributes+">";l[E].forEach(function(e){c+="<section data-markdown>"+m(e,t)+"</section>"});c+="</section>"}else{c+="<section "+t.attributes+" data-markdown>"+m(l[E],t)+"</section>"}}return c}function o(r){return new Promise(function(e){var t=[];[].slice.call(r.querySelectorAll("section[data-markdown]:not([data-markdown-parsed])")).forEach(function(r,e){if(r.getAttribute("data-markdown").length){t.push(u(r).then(function(e,t){r.outerHTML=s(e.responseText,{separator:r.getAttribute("data-separator"),verticalSeparator:r.getAttribute("data-separator-vertical"),notesSeparator:r.getAttribute("data-separator-notes"),attributes:i(r)})},function(e,t){r.outerHTML='<section data-state="alert">'+"ERROR: The attempt to fetch "+t+" failed with HTTP status "+e.status+"."+"Check your browser's JavaScript console for more details."+"<p>Remember that you need to serve the presentation HTML from a HTTP server.</p>"+"</section>"}))}else{r.outerHTML=s(a(r),{separator:r.getAttribute("data-separator"),verticalSeparator:r.getAttribute("data-separator-vertical"),notesSeparator:r.getAttribute("data-separator-notes"),attributes:i(r)})}});Promise.all(t).then(e)})}function u(i){return new Promise(function(r,a){var t=new XMLHttpRequest,n=i.getAttribute("data-markdown");var e=i.getAttribute("data-charset");if(e!=null&&e!=""){t.overrideMimeType("text/html; charset="+e)}t.onreadystatechange=function(e,t){if(t.readyState===4){if(t.status>=200&&t.status<300||t.status===0){r(t,n)}else{a(t,n)}}}.bind(this,i,t);t.open("GET",n,true);try{t.send()}catch(e){console.warn("Failed to get the Markdown file "+n+". Make sure that the presentation and the file are served by a HTTP server and the file can be found there. "+e);r(t,n)}})}function c(e,t,r){var a=new RegExp(r,"mg");var n=new RegExp('([^"= ]+?)="([^"]+?)"|(data-[^"= ]+?)(?=[" ])',"mg");var i=e.nodeValue;var s,o;if(s=a.exec(i)){var u=s[1];i=i.substring(0,s.index)+i.substring(a.lastIndex);e.nodeValue=i;while(o=n.exec(u)){if(o[2]){t.setAttribute(o[1],o[2])}else{t.setAttribute(o[3],"")}}return true}return false}function E(e,t,r,a,n){if(t!=null&&t.childNodes!=undefined&&t.childNodes.length>0){var i=t;for(var s=0;s<t.childNodes.length;s++){var o=t.childNodes[s];if(s>0){var u=s-1;while(u>=0){var l=t.childNodes[u];if(typeof l.setAttribute=="function"&&l.tagName!="BR"){i=l;break}u=u-1}}var d=e;if(o.nodeName=="section"){d=o;i=o}if(typeof o.setAttribute=="function"||o.nodeType==Node.COMMENT_NODE){E(d,o,i,a,n)}}}if(t.nodeType==Node.COMMENT_NODE){if(c(t,r,a)==false){c(t,e,n)}}}function l(){var e=n.getRevealElement().querySelectorAll("[data-markdown]:not([data-markdown-parsed])");[].slice.call(e).forEach(function(e){e.setAttribute("data-markdown-parsed",true);var t=e.querySelector("aside.notes");var r=a(e);e.innerHTML=marked(r);E(e,e,null,e.getAttribute("data-element-attributes")||e.parentNode.getAttribute("data-element-attributes")||DEFAULT_ELEMENT_ATTRIBUTES_SEPARATOR,e.getAttribute("data-attributes")||e.parentNode.getAttribute("data-attributes")||DEFAULT_SLIDE_ATTRIBUTES_SEPARATOR);if(t){e.appendChild(t)}});return Promise.resolve()}function d(e){return e.replace(/([&<>'"])/g,e=>HTML_ESCAPE_MAP[e])}return{id:"markdown",init:function(e){n=e;let{renderer:t,animateLists:r,...a}=n.getConfig().markdown||{};if(!t){t=new marked.Renderer;t.code=(e,t)=>{let r="";if(CODE_LINE_NUMBER_REGEX.test(t)){r=t.match(CODE_LINE_NUMBER_REGEX)[1].trim();r=`data-line-numbers="${r}"`;t=t.replace(CODE_LINE_NUMBER_REGEX,"").trim()}e=d(e);return`<pre><code ${r} class="${t}">${e}</code></pre>`}}if(r===true){t.listitem=e=>`<li class="fragment">${e}</li>`}marked.setOptions({renderer:t,...a});return o(n.getRevealElement()).then(l)},processSlides:o,convertSlides:l,slidify:s,marked:marked}};export default Plugin;