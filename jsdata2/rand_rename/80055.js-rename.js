"use strict";var css=require("css");var util=require("./lib/util");var validateItem=require("./lib/validator").validate;var shorthandParser=require("./lib/shorthand-parser");function convertLengthShorthand(e,t){for(var r=0;r<e.declarations.length;r++){var a=e.declarations[r];if(a.property===t){var i=a.value.split(/\s+/);i[1]=i[1]||i[0];i[2]=i[2]||i[0];i[3]=i[3]||i[1];e.declarations.splice(r,1);e.declarations.splice(r,0,{type:"declaration",property:t+"-left",value:i[3],position:a.position});e.declarations.splice(r,0,{type:"declaration",property:t+"-bottom",value:i[2],position:a.position});e.declarations.splice(r,0,{type:"declaration",property:t+"-right",value:i[1],position:a.position});e.declarations.splice(r,0,{type:"declaration",property:t+"-top",value:i[0],position:a.position})}}}function mergeStyle(t,e,r,a,i,o){if(!process.env.UNI_USING_NVUE_STYLE_COMPILER){t[e]=t[e]||{};t[e][i]=a[i];return}e=e.split(".").map(e=>"."+e).slice(1);var s=e.find(e=>e in t)||e[0];r+=e.filter(e=>e!==s).sort().join("");var l=t[s]=t[s]||{};var n=l[r]=l[r]||{};n[i]=[...a[i],r.split(".").length-1,o]}function parse(e,t){var r,a,c={},p=[];r=css.parse(e,{silent:true});if(r.stylesheet.parsingErrors&&r.stylesheet.parsingErrors.length){a=r.stylesheet.parsingErrors;a.forEach(function(e){p.push({line:e.line,column:e.column,reason:e.toString().replace("Error","ERROR")})})}if(r&&r.type==="stylesheet"&&r.stylesheet&&r.stylesheet.rules&&r.stylesheet.rules.length){r.stylesheet.rules.forEach(function(l,n){var e=l.type;var u={};var v=[];if(e==="rule"){if(l.declarations&&l.declarations.length){l.declarations=shorthandParser(l.declarations);convertLengthShorthand(l,"padding");convertLengthShorthand(l,"margin");l.declarations.forEach(function(e){var t=e.type;var r,a,i,o,s,l;if(t!=="declaration"){return}r=e.property;a=e.value;var n=a.replace(/\s*!important/g,"");var c=Number(a!==n);a=n;l=util.hyphenedToCamelCase(r);s=validateItem(l,a);if(typeof s.value==="number"||typeof s.value==="string"){if(process.env.UNI_USING_NVUE_STYLE_COMPILER){var p=u[l];u[l]=Array.isArray(p)&&p[1]>c?p:[s.value,c]}else{u[l]=s.value}}if(s.log){s.log.line=e.position.start.line;s.log.column=e.position.start.column;v.push(s.log)}});l.selectors.forEach(function(e){e=e.replace(/\s*([\+\~\>])\s*/g,"$1").replace(/\s+/," ");const t=e.match(process.env.UNI_USING_NVUE_STYLE_COMPILER?/^((?:(?:\.[A-Za-z0-9_\-]+)+[\+\~\> ])*)((?:\.[A-Za-z0-9_\-\:]+)+)$/:/^(\.)([A-Za-z0-9_\-:]+)$/);if(t){var r=t[1];var a=t[2];var i=a.indexOf(":");if(i>-1){var o=a.slice(i);a=a.slice(0,i);var s={};Object.keys(u).forEach(function(e){s[e+o]=u[e]});u=s}Object.keys(u).forEach(function(e){mergeStyle(c,a,r,u,e,n)})}else{p.push({line:l.position.start.line,column:l.position.start.column,reason:"ERROR: Selector `"+e+"` is not supported. Weex only support classname selector"})}});p=p.concat(v)}}else if(e==="font-face"){if(l.declarations&&l.declarations.length){l.declarations.forEach(function(e){if(e.type!=="declaration"){return}var t=util.hyphenedToCamelCase(e.property);var r=e.value;if(t==="fontFamily"&&"\"'".indexOf(r[0])>-1){r=r.slice(1,r.length-1)}u[t]=r});if(!c["@FONT-FACE"]){c["@FONT-FACE"]=[]}c["@FONT-FACE"].push(u)}}})}c["@VERSION"]=2;t(a,{jsonStyle:c,log:p})}function validate(t,e){var i=[];var r;try{t=JSON.parse(JSON.stringify(t))}catch(e){r=e;t={}}Object.keys(t).forEach(function(e){var a=t[e];Object.keys(a).forEach(function(e){var t=a[e];var r=validateItem(e,t);if(typeof r.value==="number"||typeof r.value==="string"){a[e]=r.value}else{delete a[e]}if(r.log){i.push(r.log)}})});e(r,{jsonStyle:t,log:i})}module.exports={parse:parse,validate:validate,validateItem:validateItem,util:util};