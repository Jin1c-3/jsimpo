import{isFn,isStr,hasOwn,isPlainObject}from"uni-shared";import{isSyncApi,isContextApi}from"../helpers/promise";import{protocols}from"uni-platform/runtime/api/protocols";const CALLBACKS=["success","fail","cancel","complete"];function processCallback(r,s,n){return function(e){return s(processReturnValue(r,e,n))}}function processArgs(r,s,n={},e={},o=false){if(isPlainObject(s)){const t=o===true?s:{};if(isFn(n)){n=n(s,t)||{}}for(const i in s){if(hasOwn(n,i)){let e=n[i];if(isFn(e)){e=e(s[i],s,t)}if(!e){console.warn(`The '${r}' method of platform '__PLATFORM_TITLE__' does not support option '${i}'`)}else if(isStr(e)){t[e]=s[i]}else if(isPlainObject(e)){t[e.name?e.name:i]=e.value}}else if(CALLBACKS.indexOf(i)!==-1){if(isFn(s[i])){t[i]=processCallback(r,s[i],e)}}else{if(!o){t[i]=s[i]}}}return t}else if(isFn(s)){s=processCallback(r,s,e)}return s}function processReturnValue(e,r,s,n=false){if(isFn(protocols.returnValue)){r=protocols.returnValue(e,r)}return processArgs(e,r,s,{},n)}export default function wrapper(t,e){if(hasOwn(protocols,t)){const i=protocols[t];if(!i){return function(){console.error(`Platform '__PLATFORM_TITLE__' does not support '${t}'.`)}}return function(e,r){let s=i;if(isFn(i)){s=i(e)}e=processArgs(t,e,s.args,s.returnValue);const n=[e];if(typeof r!=="undefined"){n.push(r)}if(isFn(s.name)){t=s.name(e)}else if(isStr(s.name)){t=s.name}const o=__GLOBAL__[t].apply(__GLOBAL__,n);if(isSyncApi(t)){return processReturnValue(t,o,s.returnValue,isContextApi(t))}return o}}return e}