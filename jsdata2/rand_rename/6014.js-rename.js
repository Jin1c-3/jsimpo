(function(global){define(["./lib/_base"],function(base){var testCache,tasks;testCache={};tasks=function(){var nextHandle,tasksByHandle,currentlyRunningATask;nextHandle=1;tasksByHandle={};currentlyRunningATask=false;function Task(e,t){this.handler=e;this.args=Array.prototype.slice.call(t)}Task.prototype.run=function(){if(base.isFunction(this.handler)){this.handler.apply(undefined,this.args)}else{var scriptSource=""+this.handler;eval(scriptSource)}};return{addFromSetImmediateArguments:function(e){var t,a,n,s;t=e[0];a=Array.prototype.slice.call(e,1);n=new Task(t,a);s=nextHandle++;tasksByHandle[s]=n;return s},runIfPresent:function(e){if(!currentlyRunningATask){var t=tasksByHandle[e];if(t){currentlyRunningATask=true;try{t.run()}finally{delete tasksByHandle[e];currentlyRunningATask=false}}}else{global.setTimeout(function(){tasks.runIfPresent(e)},0)}},remove:function(e){delete tasksByHandle[e]}}}();function has(e){if(base.isFunction(testCache[e])){testCache[e]=testCache[e](global)}return testCache[e]}function add(e,t,a){testCache[e]=a?t(global,d,el):t}function aliasMicrosoftImplementation(e){e.setImmediate=global.msSetImmediate;e.clearImmediate=global.msClearImmediate}function installPostMessageImplementation(e){var a="cujojs/poly.setImmediate"+Math.random();function n(e,t){return typeof e==="string"&&e.substring(0,t.length)===t}function t(e){if(e.source===global&&n(e.data,a)){var t=e.data.substring(a.length);tasks.runIfPresent(t)}}global.addEventListener("message",t,false);e.setImmediate=function(){var e=tasks.addFromSetImmediateArguments(arguments);global.postMessage(a+e,"*");return e}}function installReadyStateChangeImplementation(e){e.setImmediate=function(){var e=tasks.addFromSetImmediateArguments(arguments);var t=global.document.createElement("script");t.onreadystatechange=function(){tasks.runIfPresent(e);t.onreadystatechange=null;t.parentNode.removeChild(t);t=null};global.document.documentElement.appendChild(t);return e}}function installSetTimeoutImplementation(e){e.setImmediate=function(){var e=tasks.addFromSetImmediateArguments(arguments);global.setTimeout(function(){tasks.runIfPresent(e)},0);return e}}add("setimmediate",function(e){return base.isFunction(e.setImmediate)});add("ms-setimmediate",function(e){return base.isFunction(e.msSetImmediate)});add("post-message",function(e){var t,a;t=true;a=e.onmessage;if(!e.postMessage){return false}e.onmessage=function(){t=false};e.postMessage("","*");e.onmessage=a;return t});add("script-onreadystatechange",function(e){return"document"in e&&"onreadystatechange"in e.document.createElement("script")});if(!has("setimmediate")){if(has("ms-setimmediate")){aliasMicrosoftImplementation(global)}else{if(has("post-message")){installPostMessageImplementation(global)}else if(has("script-onreadystatechange")){installReadyStateChangeImplementation(global)}else{installSetTimeoutImplementation(global)}global.clearImmediate=tasks.remove}}})})(this.global||this);